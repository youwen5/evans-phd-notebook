\section{The geometric side}
\label{ch:geo}

\subsection{Rapoport-Zink spaces}
We briefly recall the theory of Rapoport-Zink spaces.
This follows the exposition in \cite[\S4.1]{ref:survey}.

Let $\breve F$ denote the completion of a maximal unramified extension of $F$,
and let $\FF$ denote the residue field of $\OO_{\breve F}$.
Suppose $S$ is a $\Spf \OO_{\breve F}$-scheme.
Then we can consider triples $(X, \iota, \lambda)$ consisting of the following data.
\begin{itemize}
  \ii $X$ is a formal $\varpi$-divisible $n$-dimensional $\OO_F$-module over $S$
  whose relative height is $2n$.

  \ii $\iota \colon \OO_E \to \End(X)$ is an action of $\OO_E$
  such that the induced action of $\OO_F$ on $\Lie X$
  is via the structure morphism $\OO_F \to \Sheaf_S$.

  We require that $\iota$ satisfies the Kottwitz condition of signature $(n-1,1)$,
  meaning that for all $a \in \OO_E$,
  the characteristic polynomial of $\iota(a)$ on $\Lie X$
  is exactly \[ (T-a)^{n-1} (T-\bar a) \in \Sheaf_S[T]. \]

  \ii $\lambda \colon X \to X^\vee$ is a principal $\OO_F$-relative polarization.

  We require that the Rosati involution of $\lambda$
  induces the map $a \mapsto \bar a$ on $\OO_F$
  (i.e.\ the nontrivial automorphism of $\Gal(E/F)$).
\end{itemize}
The triple is called supersingular if $X$ is a supersingular strict $\OO_F$-module.

For each $n \ge 1$, over $\FF$
we choose a supersingular triple $(\XX_n, \iota_{\XX_n}, \lambda_{\XX_n})$;
it's unique up to $\OO_E$-linear quasi-isogeny compatible with the polarization,
and refer to it as the \emph{framing object}.
We can now define the Rapoport-Zink space:
\begin{definition}
  [Rapoport-Zink space; {\cite[\S5.1]{ref:AFLspherical}}]
  For each $n \ge 1$, we let $\RZ_n$ denote the
  functor over $\Spf \OO_{\breve F}$ defined as follows.
  Let $S$ be an $\Spf \OO_{\breve F}$ scheme, and let
  $\ol S \coloneqq S \times_{\Spf \OO_{\breve F}} \Spec \FF$.
  For every $\Spf \OO_{\breve F}$ scheme, we let $\RZ_n(S)$
  be the set of isomorphism classes of quadruples
  \[ (X, \iota, \lambda, \rho) \]
  where $(X, \iota, \lambda)$ is one of the triples as we described, and
  \[ \rho \colon X \times_S \ol S \to \XX_n \times_{\Spec \FF} \ol S \]
  is a \emph{framing}, meaning it is a height zero $\OO_F$-linear quasi-isogeny
  and satisfies
  \[ \rho^\ast((\lambda_{\XX_n})_{\ol S}) = \lambda_{\ol S}. \]
\end{definition}
Then $\RZ_n$ is formally smooth over $\OO_{\breve F}$ of relative dimension $n-1$.

Henceforth, we also make the following abbreviation.
\begin{definition}
  [$\RZ_{m,n}$]
  For integers $m$ and $n$,
  \[ \RZ_{m,n} \coloneq \RZ_{m} \times_{\Spf \OO_{\breve F}} \RZ_n. \]
\end{definition}

\subsection{A realization of the non-split Hermitian space $\VV_n^-$ of dimension $n$}
For the following definition (and later on), we need a variation of $\RZ_1$:
\begin{definition}
  [$\EE$]
  Let $(\EE, \iota_\EE, \lambda_\EE)$ be the unique triple over $\FF$
  whose Rosati involution has signature $(1,0)$
  (note this is different from $\RZ_1$ where the signature is $(0,1)$ instead).
\end{definition}

At the same time, we can define the following Hermitian space.
\begin{definition}
  [{\cite[\S5.2]{ref:AFLspherical}}]
  For each $n \ge 1$, let
  \[ \VV_n^- \coloneqq \Hom_{\OO_E}^\circ (\EE, \XX_n) \]
  which we call the space of special homomorphisms.
  When endowed with the form
  \[ \left< x,y \right> = \lambda_{\EE}^{-1} \circ y^\vee \circ \lambda_{\XX_n} \circ x
    \in \End_{E}^\circ(\EE) \simeq E \]
  it becomes an $n$-dimensional $E/F$-Hermitian space.
  \label{def:VV_n_nonsplit}
\end{definition}
\begin{proposition}
  [Realization of $\VV_n^-$]
  Up to isomorphism, $\VV_n^-$ is the unique $n$-dimensional
  nondegenerate non-split $E/F$-Hermitian space.
\end{proposition}
\begin{proof}
  See the comment in \cite[\S5.2]{ref:AFLspherical}
  or the comment after \cite[Equation (4.2)]{ref:survey}.
\end{proof}

As described in \cite[Equation (4.3)]{ref:survey}, there is an action of
$\U(\VV_n^-)$ on $(\XX_n, \iota_{\XX_n}, \lambda_{\XX_n})$
and hence each $g \in \U(\VV_n^-)$ acts on $\RZ_n$ by
\[ g \cdot (X, i, \lambda, \rho) \coloneqq (X, i, \lambda, g \circ \rho). \]

\subsection{Intersection numbers for the group version of AFL for the full spherical Hecke algebra}
Here we reproduce the definition of the intersection number used in \Cref{conj:inhomog_spherical}.

Compared to the formulation of the group version and semi-Lie version of the AFL,
the intersection number requires the introduction of a
\emph{Hecke operator} $\TT_{\varphi}$ for an element
\[ \varphi \in \HH(G^\flat \times G, K^\flat \times K) \]
as introduced in \cite{ref:AFLspherical}.
This definition is too involved to reproduce here in its entirety,
we give a summary for this special cases in which we need.

First consider the given $f \in \HH(\U(\VV_n^+))$.
The main work of the construction is to define another
derived formal scheme $\mathcal{T}_{\mathbf{1}_{K^\flat} \otimes f}$
(see \cite[\S6.1]{ref:AFLspherical}) together with two projection maps
\begin{center}
\begin{tikzcd}
  & \ar[ld] \mathcal T_{\mathbf{1}_{K^\flat} \otimes f} \ar[rd] & \\
  \RZ_{n-1,n} && \RZ_{n-1,n}.
\end{tikzcd}
\end{center}
This definition is carried out in \cite[\S5]{ref:AFLspherical},
by defining it first for so-called \emph{atomic elements} of the spherical Hecke algebra,
which form basis elements of a certain presentation of this Hecke algebra
as the unitary group for a polynomial algebra;
we refer the reader to \emph{loc.\ cit.}~for the full details.

Now, take the natural closed embedding
\[ \RZ_{n-1} \to \RZ_n \]
and let
\[ \Delta \colon \RZ_{n-1} \hookrightarrow \RZ_{n-1,n} \]
be the associated graph morphism; let $\Delta_{\RZ_{n-1}}$ denote the image,
with an inclusion $\iota \colon \Delta_{\RZ_{n-1}} \hookrightarrow \RZ_{n-1,n}$.
Once this is done, consider then the diagram
\begin{center}
\begin{tikzcd}
  & \pi_1^\ast(\Delta_{\RZ_{n-1}}) \ar[ld] \ar[r] \ar[rd]
    & \ar["\pi_1" near end, ld] \mathcal T_{\mathbf{1}_{K^\flat} \otimes f}
      \ar["\pi_2" near end, rd] \\
  \Delta_{\RZ_{n-1}} \ar[r, "\iota"', hook] & \RZ_{n-1,n}
  & (\pi_2)_\ast(\pi_1^\ast(\Delta_{\RZ_{n-1,n}})) \ar[r] & \RZ_{n-1,n}.
\end{tikzcd}
\end{center}
That is, one takes the pullback of
$\Delta_{\RZ_{n-1}} \xhookrightarrow{\iota} \RZ_{n-1,n}$
along the projection
\[ \RZ_{n-1,n} \xleftarrow{\pi_1} \mathcal{T}_{\mathbf{1}_{K^\flat} \otimes f} \]
and then takes the pushforward along the other projection
\[ \mathcal{T}_{\mathbf{1}_{K^\flat} \otimes f} \xrightarrow{\pi_2} \RZ_{n-1,n}. \]
\begin{definition}
  [Hecke operator]
  Set
  \[
    \TT_{\mathbf{1}_{K^\flat} \otimes f} (\Delta_{\RZ_{n-1}})
    \coloneqq (\pi_2)_\ast(\pi_1^\ast(\Delta_{\RZ_{n-1}})).
  \]
\end{definition}
This is the part of the intersection number depending on $f$
(or rather $\TT_{\mathbf{1}_{K^\flat} \otimes f}$).
As for our $g \in \U(\VV_n^-)\rs$,
consider the translation $(1,g) \cdot \Delta_{\RZ_{n-1}}$.
The intersection number is then defined as by taking the intersection
of these two objects using the derived tensor product $\jiao$ of the structure sheaves.

\begin{definition}
  [$\Int((1,g), \mathbf{1}_{K^\flat} \otimes f)$; {\cite[Equation (6.1.1)]{ref:AFLspherical}}
  or {\cite[Equation (4.4)]{ref:survey}}]
  \label{def:intersection_number_inhomog}
  We define the intersection number in \Cref{conj:inhomog_spherical} by
  \begin{align*}
    \Int((1,g), \mathbf{1}_{K^\flat} \otimes f)
    &\coloneqq \left\langle
      \TT_{\mathbf{1}_{K^\flat} \otimes f} \Delta_{\RZ_{n-1}},
      (1,g) \cdot \Delta_{\RZ_{n-1}} \right\rangle _{\RZ{n-1,n}} \\
    &\coloneqq \chi_{\RZ_{n-1,n}} \left(
      \Sheaf_{\TT_{\mathbf{1}_{K^\flat} \otimes f} (\Delta_{\RZ_{n-1}})}
      \jiao_{\Sheaf_{\RZ_{n-1,n}}} \Sheaf_{(1,g) \cdot \Delta_{\RZ_{n-1}}} \right).
  \end{align*}
\end{definition}

Here $\chi$ denotes the Euler-Poincar\'{e} characteristic,
meaning that if $X$ is a formal scheme over $\Spf \OO_{\breve F}$
then given a finite complex $\mathcal{F}$ of $\Sheaf_X$-modules we set
\[ \chi_X(\mathcal{F}) = \sum_i \sum_j (-1)^{i+j}
  \operatorname*{len}_{\OO_{\breve F}} H^j(X, H_i(\mathcal F)) \]
provided all the lengths are finite.

\begin{remark}
  In general we could adapt this definition so $(1,g)$ is replaced by
  by an element of $(\U(\VV_{n-1}^-) \times \U(\VV_n^-))\rs$
  if we wish to work with the full group version of the AFL
  rather than just the inhomogeneous version.
  However, this simpler definition will be sufficient for our purposes.
\end{remark}

\subsection{Intersection numbers for the semi-Lie version of AFL for the full spherical Hecke algebra}
Now we continue to define an intersection number needed for the proposed
\Cref{conj:semi_lie_spherical} from earlier.
The definition mirrors the one given in the last section.
Here we reproduce the definition of the intersection number used in \Cref{conj:inhomog_spherical}.

We work here with $\RZ_{n,n}$ rather than $\RZ_{n-1,n}$.
The change is that we need to incorporate the new $u \in \VV_n^-$ that was not present before.
In order to do this one considers a certain relative Cartier divisor $\ZD(u)$
on $\RZ_n$ for each nonzero $u \in \VV_n^-$.
This divisor was defined by Kudala and Rapport in \cite{ref:KR}
and accordingly we call it a \emph{KR-divisor} following \cite[\S4.3]{ref:survey}.
The definition is given as follows.
\begin{definition}
  [$\ZD(u)$; {\cite[Definition 3.2]{ref:KR}}]
  Recall that $(\EE, \iota_\EE, \lambda_\EE)$ is the unique triple over $\FF$
  whose Rosati involution has signature $(1,0)$.
  Hence the formal $\OO_F$-module has a unique lifting called its \emph{canonical lifting},
  which we denote by the triple $(\mathcal{E}, \iota_{\mathcal{E}}, \lambda_{\mathcal E})$.

  Then the KR-divisor $\ZD(u)$ is the locus where the quasi-homomorphism
  \[ u \colon \EE \to \XX_n \]
  lifts to a homomorphism from $\mathcal{E}$ to the universal object over $\RZ_n$.
  More explicitly, it consists of those $X \in \RZ_n$
  such that there exists a map $\varphi : \mathcal{E} \to X$ with the following property.
  Let $S$ be an $\Spf \OO_{\breve F}$ scheme and consider the map on special fiber
  \[ \mathcal{E} = \EE \times_S \ol S \xrightarrow{\varphi \times_S \ol S} X' \times_S \ol S. \]
  Since $X \in \RZ_n$ we also have $\rho \colon X \times_S \ol S \to \XX_n \times_{\Spec \FF} \ol S$.
  Moreover, $u$ gives a map
  \[
    \EE \times_{\Spec \FF} \ol S
    \xrightarrow{u \times _{\Spec \FF} \ol S}
    \XX_n \times_{\Spec \FF} \ol S.
  \]
  Then we require the following diagram to commute:
  \begin{center}
  \begin{tikzcd}
    \EE \times_S \ol S \ar[rr, "\varphi \times_S \ol S"] \ar[d, "\rho_{\mathcal E}"] && X \times_S \ol S\ar[d, "\rho"] \\
    \EE \times_{\Spec \FF} \ol S \ar[rr, "u \times_{\Spec \FF} \ol S"] && \XX_n \times_{\Spec \FF} \ol S.
  \end{tikzcd}
  \end{center}
\end{definition}
That is, $\ZD(u)$ is the locus where $u$ lifts to a homomorphism $\mathcal{E} \to \mathcal{X}_n$.
Note also by the definition that $g \ZD(u) = \ZD (gu)$.
See \cite{ref:KR} for a full definition.

The main change is then that we can consider $\Delta_{\ZD(u)}$ as the image of
\[ \ZD(u) \hookrightarrow \RZ_n \xrightarrow{\Delta} \RZ_{n,n} \]
where $\Delta \colon \RZ_n \to \RZ_{n,n}$ now denotes the diagonal map.
If one defines an appropriate space $\mathcal T_{\mathbf{1}_K \otimes f}$
for $f \in \HH(\U(\VV_n^+))$ again following \cite{ref:AFLspherical}, together with
\begin{center}
\begin{tikzcd}
  & \ar[ld] \mathcal T_{\mathbf{1}_K \otimes f} \ar[rd] & \\
  \RZ_{n,n} && \RZ_{n,n}
\end{tikzcd}
\end{center}
then one can then repeat the diagram from before:
\begin{center}
\begin{tikzcd}
  & \pi_1^\ast(\Delta_{\ZD(u)}) \ar[ld] \ar[r] \ar[rd]
    & \ar["\pi_1" near end, ld] \mathcal T_{\mathbf{1}_K \otimes f}
      \ar["\pi_2" near end, rd] \\
  \Delta_{\ZD(u)} \ar[r, "\iota"', hook] & \RZ_{n,n}
  & (\pi_2)_\ast(\pi_1^\ast(\Delta_{\ZD(u)})) \ar[r] & \RZ_{n,n}.
\end{tikzcd}
\end{center}
In other words, we again take a pullback followed by a pushforward
but this time of $\Delta_{\ZD(u)} \hookrightarrow \RZ_{n,n}$.
This lets us write an analogous definition:
\begin{definition}[Hecke operator]
  Set
  \[ \TT_{\mathbf{1}_K \otimes f} (\Delta_{\ZD(u)})
    \coloneqq (\pi_2)_\ast(\pi_1^\ast(\Delta_{\ZD(u)})). \]
\end{definition}
Meanwhile to replace $(1,g) \Delta_{\RZ_{n,n-1}}$, we let
\[ \Gamma_g \subseteq \RZ_{n,n} \]
denote the graph of the automorphism of $\RZ_n$ induced by $g$.
This finally allows us to write a definition of the intersection number in the semi-Lie case:
\begin{definition}
  [$\Int((g,u), f)$]
  \label{def:intersection_number_semi_lie_spherical}
  In analog to \Cref{def:intersection_number_inhomog} for the group version of the AFL,
  we now define the intersection number in \Cref{conj:semi_lie_spherical} as
  \begin{align*}
    \Int((g,u), f)
    &\coloneqq \left\langle \TT_{\mathbf{1}_{K} \otimes f} \Delta_{\ZD(u)}, \Gamma_g \right\rangle _{\RZ{n,n}} \\
    &\coloneqq \chi_{\RZ_{n,n}} \left(
      \Sheaf_{\TT_{\mathbf{1}_K \otimes f}(\Delta_{\ZD(u)})}
      \jiao_{\Sheaf_{\RZ_{n,n}}} \Sheaf_{\Gamma_g} \right).
    \end{align*}
\end{definition}
In the situation where $f = \mathbf{1}_K$,
this coincides with the existing definition in \cite[Equation (4.9)]{ref:survey}
and \cite[Remark 3.1]{ref:annalsAFL}.

\subsection{An analogy between the geometric and analytic sides}
With the intersection number now defined for \Cref{conj:semi_lie_spherical},
we provide some intuitive discussion about the connection.
All of this is for philosophical cheerleading only,
and is not meant to formally assert any definitions or results.
But it may help in motivating the formulation of the conjecture.

For this section write $G \coloneqq \U(\VV_n^+)$ and $K \coloneqq G \cap \GL_n(\OO_E)$
the hyperspecial maximal compact subgroup of $G$.
For simplicity we only focus on the semi-Lie AFL originally proposed by Liu to start;
which is the special case of \Cref{conj:semi_lie_spherical}
when $f = \mathbf{1}_K$ and $\phi = \mathbf{1}_{K'}$.

\paragraph{The geometric side}
On the geometric side, $\RZ_n$ is the RZ-space acted on by $\U(\VV_n^-)$,
and hence $\U(\VV_n^-) \times \U(\VV_n^-)$ acts on $\RZ_{n,n}$.
Roughly speaking, we are considering the two morphisms
\[ \RZ_n \xrightarrow{\Delta} \RZ_{n,n} \xleftarrow{\Gamma_g} \RZ_n \]
with $\Delta$ being thought of as the diagonal morphism
and $\Gamma_g$ as the graph under multiplication by $g \in \U(\VV_n^-)\rs$.

Hence loosely speaking, the intersection $\Int\left( (g,u), \mathbf{1}_K \right)$
can be thought of as the intersection of three images in $\RZ_{n,n}$:
\begin{itemize}
  \ii A ``diagonal'' object $\Delta$;
  \ii A ``graph'' object $\Gamma$;
  \ii A third object $\ZD(u)$, the KR-divisor, parametrized by diagrams
  \begin{center}
  \begin{tikzcd}
    \mathcal{E}\ar[r] \ar[d, dash] & \mathcal{X}_n \ar[d, dash] \\
    \EE \ar[r, "u"] & \XX_n.
  \end{tikzcd}
  \end{center}
\end{itemize}
The derived tensor product $\jiao$
is used together with some formalism to make this intersection idea precise.
The intersection of the ``diagonal'' and ``graph'' is the \emph{fixed point locus},
and in fact could be formally defined as the intersection
\[ \Gamma_g \cap \Delta_{\RZ_n} \]
viewed as a closed formal subscheme of $\RZ_n$ (or $\RZ_{n,n}$);
see \cite[Equation (4.6)]{ref:survey}.

\paragraph{The analytic side}
On the other hand, consider the analytic side.
We will try to explain how the weighted orbital integral in \Cref{def:orbitalFJ}
can be thought of as some weighted intersection of analogous objects.

Note the quotient $G/K$ can be identified as
\[ G/K \simeq \left\{ \Lambda \subseteq \VV_n^+ \mid \Lambda^\vee = \Lambda \right\} \]
that is, the set of self-dual lattices $\Lambda$ of full rank,
which thus has a natural action of $G$.
Henceforth we denote elements of $G/K$ by $h$,
and fix one particular such lattice $\Lambda_0$, acted on by $\OO_E$.
Hence $G/K$ can be thought of as
\[ G/K \simeq \left\{ h \Lambda_0 \mid h \in G/K \right\}. \]

Recall from \eqref{eq:unweighted_orbital_semi_lie}
that we have an orbital integral on the unitary side of the shape
\[ \int_{h \in G/K} \mathbf{1}_K(h^{-1} g h) \mathbf{1}_{\Lambda_0}(h \cdot u) \odif h \]
where $u \in \VV_n^+$, and $\Lambda_0$ is a fixed particular lattice in $G/K$.
See for example the ``relative fundamental lemma''
stated as \cite[Conjecture 1.9]{ref:liuFJ}.

Like before, we can consider two maps
\[ G/K \xrightarrow{\Delta} G/K \times G/K \xleftarrow{\Gamma_g} G/K \]
which are the diagonal morphism and the graph of the action of $g$.
Hence the intersection are those cosets $hK$ for which
\[ hK = ghK \iff h^{-1} g h \in K. \]
Hence the indicator function $\mathbf{1}_K(h^{-1} g h)$
plays the analog of the fixed point locus in the geometric side.

Meanwhile, the term $h \cdot u$ plays a role analogous
to the KR-divisor on the geometric side, giving the third intersection object.
We have
\[ h \cdot u \in \Lambda_0 \iff u \in h^{-1} \Lambda_0 \]
and so the object corresponding to the KR-divisor $\ZD(u)$
is the subset in $G/K$ of those lattices containing $u$, that is
\[ \left\{ \Lambda' \mid \Lambda' \ni u \right\}. \]
The analog to the earlier diagram that we described for $\ZD(u)$ is then
\begin{align*}
  \OO_E &\to \Lambda' \\
  1 &\mapsto u.
\end{align*}

Up until now this whole section is written for $f = \mathbf{1}_K$ and $\phi = \mathbf{1}_{K'}$.
In the general situation,
if one replaces $\mathbf{1}_K$ in the above integral by a general $f$,
then this corresponds to changing the analog of the fixed point locus;
the idea of \cite{ref:AFLspherical} is that
this should correspond to replacing $\Delta_{\ZD(u)}$
with $\TT_f(\Delta_{\ZD(u)})$ on the geometric side.
