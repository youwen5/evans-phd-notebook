\section{Intersection numbers for $\Int((g,u), f)$ for $n = 2$}
\label{ch:jiao}
This chapter is dedicated to computing intersection numbers
for the semi-Lie version of AFL in the special case $n = 2$.

\subsection{Background on quaternion division algebra}
Through this section we let $\DD$ be a quaternion division algebra over $F$,
with a fixed maximal order $\OO_\DD$.
We will make $\DD$ explicit in the following way for our calculations to follow.

\subsubsection{Structure as a noncommutative algebra}
As $F$-vector spaces we will write
\[ \DD = E \oplus E \Pi \]
where $\Pi$ is selected so that $\Pi^2 = \varpi$.
We endow $\DD$ with a noncommutative multiplication according to
\[ \Pi t = \bar t \Pi \qquad \text{ for all } t \in E \]
where $\ol{t}$ is the image of $t \in E$ under the nontrivial element of $\Gal(E/F)$.

\subsubsection{Conjugation of elements of $\DD$}
In general, suppose $x \in \DD$ is any element
decomposed as $x = a + b \Pi$ for $a,b \in E$.
Then we denote by $\bar x \in \DD$ the conjugate in $\DD$ defined by
\[ \bar x \coloneqq \bar a - b \Pi \]
where, again, $\bar a$ is the image of $a \in E$ under the nontrivial element of $\Gal(E/F)$.
It is an anti-involution, meaning that $\ol{\bar x} = x$ and $\ol{xy} = \bar y \bar x$.

(Notice that we have a slight abuse of notation here in that we have
used the same notation to denote both conjugation under the Galois action of $\Gal(E/F)$
as well as the conjugation in $\DD$.
However, there is no ambiguity resulting because when $E$ is viewed as a subset of $\DD$,
the two symbols denote the same element of $E$:
that is we have
\[ \ol{a + 0 \Pi} = \bar{a} + 0 \Pi \]
in any event.
In other words, the restriction of the quaternion conjugation to $E$
coincides with the nontrivial element of $\Gal(E/F)$,
so we do not need to introduce a separate notation for it.)

This allows us to define the reduced norm and trace in $\DD$.
The reduced trace is given by
\[ \tr x \coloneqq x + \bar x = \Tr{E/F}(a) = 2x_0 \in F. \]
We may thus define
\[ \DT \coloneqq \left\{ u \in \DD \mid \tr u = 0 \right\} \]
which has codimension $1$ inside $\DD$ (i.e.\ is three-dimensional as an $F$-vector space).
Since $\tr(a+b\Pi) = \Tr_{E/F}(a)$, we could also write
\[ \DT = \{ a+b\Pi \mid a,b \in E \text{ and } \Tr_{E/F}(a) = 0 \}. \]

The reduced norm is similarly defined by
\begin{align*}
  \Nm x &= x \bar x = (a + b \Pi)(\bar a - b \Pi) \\
  &= a \bar a + b \Pi \bar a - a b \Pi - b \Pi b \Pi \\
  &= a \bar a - b \bar b \varpi \\
  &= \Norm_{E/F}(a) - \Norm_{E/F}(b) \varpi \in F.
\end{align*}

As an $F$-vector space, $\DD$ has a basis given by
$\{1, \sqrt{\eps}, \Pi, \sqrt{\eps}\Pi\}$, that is
\[ \DD = F \oplus F\sqrt\eps \oplus F \Pi \oplus F\sqrt\eps\Pi. \]
It will be convenient to introduce the following notation:
\begin{definition}
  [$x_0$ and $x_-$]
  For $x \in \DD$, we introduce the notation $x_0$ and $x_-$ to mean
  \begin{itemize}
    \ii $x_0$ is the projection into the first component $F$; and
    \ii $x_- = x - x_0$ is the projection into
    $\DT = F\sqrt\eps \oplus F \Pi \oplus F\sqrt\eps\Pi$.
  \end{itemize}
\end{definition}
In particular, the formula for conjugation then reads as the simpler
\[ \bar x = x_0 - x_-. \]

\subsubsection{Hermitian structure}
We view $\DD$ as an $E/F$-Hermitian space under left multiplication by $E$;
that is, for $a,b,t \in E$ we consider
\[ t \cdot (a + b \Pi) = a t + b t \Pi. \]
as the action of $E$ on $\DD$.
Then we equip $\DD$ with a $E/F$-Hermitian form
$\left\langle \bullet, \bullet \right\rangle \colon \DD \times \DD \to E$
defined by
\[ \left\langle x,y \right\rangle = \half \Tr_{\DD/E}(x \bar y) \]
i.e.\ the projection of $x \bar y \in \DD = E \oplus E\Pi$ onto the first component.
In particular, note that
\[ \left\langle x,x \right\rangle = x \bar{x} = \Nm x \]
or equivalently
\[ \left\langle a+b\Pi, a+b\Pi \right\rangle = a \bar a - b \bar b \varpi. \]

\subsubsection{Identification of $\VV_n^-$ with $\DD$}
We continue using the notation $(\EE, \iota_\EE, \lambda_\EE)$ as the triple over $\FF$
whose Rosati involution has signature $(1,0)$.
Moreover, we will take the identification
\[ \End(\EE) \simeq \OO_\DD \]
see \cite[Remark 2.5]{ref:KR},
and hence the corresponding identification
\[ \VV_n^- \simeq \DD. \]

\subsection{The invariants for the orbit of $(g,u)$}
\label{sec:g_u_invariants}

We specialize to the situation where $u \in \OO_\DD$ and $g \in \U(\VV_n^-)$.

\subsubsection{Coordinates for $g$}
To impose coordinates on $g$, we appeal to the following fact.
\begin{lemma}
  [Description of $\U(\VV_2^-)$]
  Every unitary map in $\U(\VV_2^-)$ can be described in the form
  \[ x \mapsto \lambda\inv x (\alpha + \beta \Pi) \]
  for some quaternion $\alpha + \beta \Pi \in \DD^\times$
  and an element $\lambda \in E^\times$ such that
  \[ \Nm(\alpha + \beta \Pi) = \Norm_{E/F}(\lambda). \]

  Moreover, such a description is unique up to multiplication by elements of $F$.
  In other words,
  \[ \U(\VV_2^-) \simeq (E^\times \times \DD^\times)^\circ / \Delta(F^\times) \]
  where $(\DD^\times \times E^\times)^\circ$
  denotes those pairs $(\lambda, \alpha + \beta \Pi)$
  with $\Norm_{E/F}(\lambda) = \Nm(\alpha + \beta \Pi)$,
  and $\Delta(F^\times)$ is the diagonal embedding of $F^\times$.
\end{lemma}
\begin{remark}
  In this paper we will not have a need to compose multiple such unitary maps.
  However, if we did, then our notation above swaps the multiplication order.
  That is, if we have $g_1, g_2 \in \U(\VV_2^-)$ represented by pairs
  $g_1 \leftrightarrow (\lambda_1, \alpha_1 + \beta \Pi_1)$
  and $g_2 \leftrightarrow (\lambda_2, \alpha_2 + \beta \Pi_2)$
  under the isomorphism above, then
  \[ g_1 \circ g_2 \leftrightarrow (\lambda_2 \lambda_1, (\alpha_2 + \beta_2 \Pi)(\alpha_1 + \beta \Pi)). \]
\end{remark}

Note that in the definition for $g$, if $v(\lambda) \neq 0$
then we can factor out powers of $\varpi = \bar\varpi$ from $\lambda$
and put them into $\alpha$ and $\beta$ instead.
Hence, by relabeling $\alpha$ and $\beta$, we may assume without loss of generality that:
\begin{assume}
  We assume WLOG that $v(\lambda) = 0$ (and hence $v(\alpha)=0$, $v(\beta) \ge 0$).
\end{assume}
This frees us from having to deal with $v(\lambda)$ offsets in subsequent calculation.

We encode $g$ as a matrix on $\DD$ now (with the obvious $E$-basis $1$, $\Pi$,
again viewing $\DD$ as a left-$E$ module)
so we can compute its determinant and trace.
We have
\begin{align*}
  g(1) &= \lambda\inv \cdot 1 \cdot (\alpha + \beta \Pi)
    = \lambda\inv \alpha + \lambda\inv \beta \Pi \\
  g(\Pi) &= \lambda\inv \cdot \Pi (\alpha + \beta \Pi)
    = \lambda\inv \bar\beta \varpi + \lambda\inv \bar\alpha \Pi.
\end{align*}
Hence, written as a matrix with respect to the obvious basis $\{1, \Pi\}$ we have
\[ g = \lambda\inv \begin{pmatrix}
  \alpha & \bar\beta \varpi \\
  \beta &  \bar\alpha
  \end{pmatrix}. \]

\subsubsection{Coordinates for $u$}
We also impose coordinates for $u$ according to
\[ u = s + t \Pi \in \OO_\DD \qquad s, t \in E. \]
To make the calculation that follows less complicated,
we are going to make the following assumption on $u$.
\begin{assume}
  We assume WLOG that either $u \in E$ or $u \in E \Pi$.
  That is, either $s = 0$ or $t = 0$.
  \label{assume:st_zero}
\end{assume}
This assumption can be made without loss of generality because
the invariants and the intersection only depend
on the $\SU(2)$-orbit of the pair $(g,u)$,
and any element $u \in \DD^\times$ can be mapped under an element of $\SU(2)$
into a pair for which $u \in E$ or $u \in E \Pi$.

In order for $(g,u)$ to be regular semisimple we require that
\begin{align*}
  u &= s + t \Pi \\
  g(u) &= \lambda\inv (s + t \Pi)(\alpha + \beta \Pi) \\
  &= \lambda\inv \left( (s \alpha + t \bar\beta \varpi) + (s \beta + t \bar\alpha)\Pi \right)
\end{align*}
are linearly independent, meaning
\begin{align*}
  0 &\neq
  \det \begin{pmatrix}
    s & s \alpha + t \bar \beta \varpi \\
    t & s \beta + t \bar \alpha
  \end{pmatrix}
  = st(\bar\alpha - \alpha) + \beta s^2 - \bar\beta t^2 \varpi \\
  &= \beta s^2 - \bar\beta t^2 \varpi \\
  &= \begin{cases}
    -\bar\beta t^2 \varpi & \text{if } s = 0 \\
    \beta s^2 & \text{if } t = 0.
  \end{cases}
\end{align*}
Hence, we have a requirement that $\beta \neq 0$
and $s$ and $t$ are not both zero (we require $st = 0$ from \Cref{assume:st_zero}).
\begin{remark}[$\alpha \neq 0$]
  Note that necessarily $\alpha$ is nonzero as well.
  This follows from the requirement that
  $\alpha \bar \alpha - \beta \bar \beta \varpi = \lambda \bar\lambda$;
  if $\alpha = 0$ we would get a left-hand side with odd valuation
  but a right-hand side with even valuation.
\end{remark}

\subsubsection{The invariants of the matching}
At this point we can state:
\begin{lemma}
  \label{lem:g_u_invariants}
  Under the coordinates we just described,
  the four corresponding invariants of \Cref{def:matching_semi_lie} are:
  \begin{align*}
    \Tr g &= \lambda^{-1} (\alpha + \bar \alpha) \\
    \det g &= \lambda^{-2} (\alpha \bar \alpha - \beta \bar\beta \varpi) \\
    \left\langle u,u \right\rangle &= s \bar s - t \bar t \varpi \\
    \left\langle g(u), u \right\rangle &= \begin{cases}
        \lambda\inv \bar\alpha \Nm u & \text{if } s = 0 \\
        \lambda\inv \alpha \Nm u & \text{if } t = 0.
      \end{cases}
  \end{align*}
\end{lemma}
\begin{proof}
  The first three are immediate.
  The last one follows by computing
  \begin{align*}
    \left\langle g(u), u \right\rangle
    &= \left\langle \lambda\inv(s + t \Pi)(\alpha + \beta \Pi), s + t \Pi \right\rangle \\
    &= \lambda\inv \left\langle
      (s \alpha + t \bar \beta \varpi) + (t \bar \alpha + s \beta) \Pi,
      s + t \Pi \right\rangle \\
    &= \lambda\inv \cdot \half \Tr_{\DD/E} \left[
      ((s \alpha + t \bar \beta \varpi) + (t \bar \alpha + s \beta) \Pi)
      (\bar s - t \Pi) \right] \\
    &= \lambda\inv \left( s \bar s \alpha - t \bar t \bar \alpha \varpi \right)
  \end{align*}
  and recalling that $s t = 0$.
\end{proof}

\subsection{A basis for $\HH(\U(\VV_2^+))$}
\label{sec:hecke_unitary_basis}

As before $K = \GL_2(\OO_E) \cap \U(\VV_2^+)$denotes the maximal hyperspecial compact subgroup of $\U(\VV_2^+)$.
For each $r \ge 0$, we define
\[ \fr \coloneqq \mathbf{1}_{\varpi^{-r} \Mat_2(\OO_E) \cap \U(\VV_2^+)} \in \HH(\U(\VV_2^+)). \]
For convenience $\fr = 0$ for $r < 0$.
We also set
\[  \mathbf{1}_{K, r} \coloneqq \fr - \mathbf{1}_{K, \le (r-1)} \]
which is the indicator function for the coset
\[ K \begin{pmatrix} 0 & \varpi^r \\ \varpi^{-r} & 0 \end{pmatrix} K. \]
Note when $r = 0$, $\mathbf{1}_{K, 0} = \mathbf{1}_K = \mathbf{1}_{K, \le 0}$.

Analogous to \Cref{sec:hecke_basis_FJ} we then have the following result.
\begin{proposition}[$\fr$ basis]
  The functions $\fr$ (for $r \ge 0$) form a basis of $\HH(\U(\VV_2^+))$.
  (Similarly, so do $\mathbf{1}_{K, r}$ for $r \ge 0$.)
\end{proposition}
\begin{proof}
  This follows from the fact that
  \[ \U(\VV_2^+) = \coprod_{r \ge 0}
    K \begin{pmatrix} 0 & \varpi^r \\ \varpi^{-r} & 0 \end{pmatrix} K. \]
  See the comment in \cite[Equation (7.1.5)]{ref:AFLspherical}.
\end{proof}

The base change for this basis is given later in \Cref{lem:finale_base_change}.

\subsection{Background on special divisors for $n = 2$}
\subsubsection{The Rapoport-Zink space $\RZ_2$ and $\TTr$}
Recall $\RZ_2$ from \Cref{ch:geo}.
With the Hecke operator $\TT$ from \cite{ref:AFLspherical}
(see \Cref{ch:geo} for discussion)
we introduce $\TTr = \TT_{\mathbf{1}_K \otimes \mathbf{1}_{K, \le r}}(\Delta_{\RZ_n})$
so that we have the diagram
\begin{center}
\begin{tikzcd}
  & \ar[ld] \TTr \ar[rd] & \\
  \RZ_{2} && \RZ_{2}
\end{tikzcd}
\end{center}

\subsubsection{The Lubin-Tate space $\MM_2$}
We introduce the notation $\MM_2$ for the \emph{Lubin-Tate space} for $n = 2$.
It is defined almost in the same way as $\RZ_2$ except that we replace
$\XX_2$ with $\EE$ now.

\begin{definition}
  [Lubin-Tate space]
  We let $\MM_2$ denote the functor over $\Spf \OO_{\breve F}$ defined as follows.
  Let $S$ be an $\Spf \OO_{\breve F}$ scheme, and let
  $\ol S \coloneqq S \times_{\Spf \OO_{\breve F}} \Spec \FF$.
  For every $\Spf \OO_{\breve F}$ scheme, we let $\RZ_n(S)$
  be the set of isomorphism classes of quadruples
  \[ (Y, \iota, \lambda, \rho) \]
  where $(Y, \iota, \lambda)$ is one of the triples as we described, and
  \[ \rho \colon Y \times_S \ol S \to \EE \times_{\Spec \FF} \ol S \]
  is a \emph{framing}, meaning it is a height zero $\OO_F$-linear quasi-isogeny
  and satisfies
  \[ \rho^\ast((\lambda_{\EE})_{\ol S}) = \lambda_{\ol S}. \]
\end{definition}

\begin{proposition}
  [{\cite[Example 5.5.6]{ref:AFLspherical}}]
  The Serre tensor construction produces an identification
  \[ \Serre \colon \RZ_2 \xrightarrow{\sim} \MM_2. \]
  By abuse of notation we will also use the same symbol for the map
  \[ \Serre \colon \RZ_{2,2} \xrightarrow{\sim} \MM_2 \times \MM_2. \]
\end{proposition}

Recall we have an action of $\U(\VV_2^-)$ (actually $\PU(\VV_2^-)$) on $\RZ_2$.
We describe now the corresponding action on $\MM_2$.
We have an isomorphism of short exact sequences
\begin{center}
\begin{tikzcd}
  1 \ar[r] & \OO_E^\times / \OO_F \ar[r] & (\OO_\DD^\times \times \OO_E^\times)^\circ / \Delta(\OO_F^\times) \ar[r] & \OO_\DD^\times / \OO_F^\times \ar[r] & 1 \\
  1 \ar[r] & \U(1) \ar[r] \ar[u, equals] & \U(\VV_2^-) \ar[r] \ar[u, equals] & \PU(\VV_2^-) \ar[r] \ar[u, equals] & 1.
\end{tikzcd}
\end{center}
The image of $\alpha + \beta \Pi \in \OO_\DD^\times / \OO_F^\times$
is then $(\lambda, \alpha + \beta \Pi) \in \PU(2)$
for any choice of $\lambda$ with $\lambda \bar \lambda = \Nm (\alpha + \beta \Pi)$.

\subsubsection{The divisor $\ZO4$ on $\MM_2 \times \MM_2$}
Now we define the special orthogonal divisor $\ZO4(u)$
on $\MM_2 \times \MM_2$ as follows.
\begin{definition}
  [$\ZO4(u)$]
  Let $u \in \OO_\DD$.
  Then we define the divisor $\ZO4(u)$ to be the pairs $(Y, Y') \in \MM_2 \times \MM_2$
  such that there exists $\varphi \colon Y \to Y'$ with the following property.
  Let $S$ be an $\Spf \OO_{\breve F}$ scheme and consider the map on special fiber
  \[ Y \times_S \ol S \xrightarrow{\varphi \times_S \ol S} Y' \times_S \ol S. \]
  Also, from $Y \in \MM_2$ and $Y' \in \MM_2$ we have the data of framings
  $\rho \colon Y \times_S \ol S \to \EE \times_{\Spec \FF} \ol S$
  and $\rho' \colon Y' \times_S \ol S \to \EE \times_{\Spec \FF} \ol S$.
  Moreover, $u$ gives a map
  \[
    \EE \times_{\Spec \FF} \ol S
    \xrightarrow{u \times _{\Spec \FF} \ol S}
    \EE \times_{\Spec \FF} \ol S.
  \]
  Then we require the following diagram to commute:
  \begin{center}
  \begin{tikzcd}
    Y \times_S \ol S \ar[rr, "\varphi \times_S \ol S"] \ar[d, "\rho"] && Y' \times_S \ol S\ar[d, "\rho'"] \\
    \EE \times_{\Spec \FF} \ol S \ar[rr, "u \times_{\Spec \FF} \ol S"] && \EE \times_{\Spec \FF} \ol S.
  \end{tikzcd}
  \end{center}
\end{definition}

\ifthesis
We propose that the Serre tensor construction identifies
the space $\TTr$ we previously described with the following $\ZO4$ divisor:
\begin{conjecture}
  [$\TTr \simeq \ZO4(\varpi^r)$]
  \label{hypo:serre_pullback_space}
  The Serre tensor construction gives an isomorphism
  \[ \TTr \simeq \ZO4(\varpi^r) \]
  such that we get an analogous diagram
  \begin{center}
  \begin{tikzcd}
    & \ar[ld] \ZO4(\varpi^r) \ar[rd] & \\
    \MM_{2} && \MM_{2}.
  \end{tikzcd}
  \end{center}
\end{conjecture}
We assume this conjecture henceforth.
(In fact, for $n = 2$ we could even go as far as to take this as a definition of $\TTr$,
but then the generalization \Cref{conj:semi_lie_spherical} would be less obvious,
since a definition like this would not easily extend to $n > 2$.)
\fi
\ifpaper
We need the following additional hypothesis:
\begin{hypothesis}
  [$\TTr \simeq \ZO4(\varpi^r)$]
  \label{hypo:serre_pullback_space}
  The Serre tensor construction gives an isomorphism
  \[ \TTr \simeq \ZO4(\varpi^r) \]
  such that we get an analogous diagram
  \begin{center}
  \begin{tikzcd}
    & \ar[ld] \ZO4(\varpi^r) \ar[rd] & \\
    \MM_{2} && \MM_{2}.
  \end{tikzcd}
  \end{center}
\end{hypothesis}
This hypothesis is shown in the in-preparation
\cite{ref:CLZ} by Ryan C.~Chen, Weixiao Lu, and Wei Zhang.
Even without this hypothesis,
for $n = 2$ we could even go as far as to take this as a definition of $\TTr$,
but then the generalization \Cref{conj:semi_lie_spherical} would be less obvious,
since a definition like this would not easily extend to $n > 2$.
\fi

\subsubsection{The divisor $\ZO3$ on $\MM_2$}
Turning to $\MM_2 \times \MM_2$, we will henceforth always identify $\MM_2$
with its image under the diagonal map
\begin{center}
\begin{tikzcd}
  \ZO4(1) \ar[r, "\sim"] & \MM_2 \ar[r, hook, "\Delta_{\MM_2}"] & \MM_2 \times \MM_2.
\end{tikzcd}
\end{center}

\begin{definition}
  [$\ZO3(u)$]
  Suppose now $u \in \DT$.
  Then we define the divisor $\ZO3(u)$ to be those $X \in \MM_2$
  for which we have a diagram
  \begin{center}
  \begin{tikzcd}
    X \ar[r, "\varphi"] \ar[d, dash] & X \ar[d, dash] \\
    \EE \ar[r, "u"] & \EE.
  \end{tikzcd}
  \end{center}
  Note that basically by definition, for $u \in \OO_\DD$ and $\tr u = 0$ we have
  \[ \ZO3(u) \simeq \ZO4(u) \cap \ZO4(1) \]
  when we identify $\MM_2$ with its image in $\MM_2 \times \MM_2$.
\end{definition}

\subsection{Comparison of the unitary and orthogonal special divisors}
We now relate $\ZD(u)$ to $\ZO3(u)$ through our
isomorphism $\RZ_{2,2} \xrightarrow{\sim} \MM_2 \times \MM_2$.
Recall that we have the notation
\[ \ZD(u)^\circ \coloneqq \ZD(u) - \ZD\left( \frac{u}{\varpi} \right). \]
Define $\ZO4(u)^\circ$ and $\ZO3(u)^\circ$ similarly.

\begin{lemma}
  [$\ZO3(\bar u \sqrt{\eps} u)^\circ$, {\cite{ref:CLZ}}]
  \label{lem:serre_pullback_divisor}
  Let $u \in \VV_n^-$, and consider it as an element $u \in \DD$.
  Then pullback along the Serre tensor construction identifies
  \[ \Serre^\ast \ZD(u)^\circ \simeq \ZO3(\bar u \sqrt{\eps} u)^\circ. \]
\end{lemma}
\begin{proof}
  This is shown in the in-preparation
  \cite{ref:CLZ} by Ryan C.~Chen, Weixiao Lu, and Wei Zhang.
  (Although \cite{ref:CLZ} is technically written for $F = \QQ_p$,
  that restriction is for other parts of the paper that don't affect this lemma.)
\end{proof}

\subsection{The intersection number as a triple product}
We return to the intersection number
\[ \Int((g,u), \fr) = \chi_{\RZ_{n,n}} \left(
      \Sheaf_{\TT_{\mathbf{1} \otimes \fr}(\Delta_{\ZD(u)})}
      \jiao_{\Sheaf_{\RZ_{n,n}}} \Sheaf_{\Gamma_g} \right) \]
which we will rewrite more succinctly using angle brackets as
\[ \Int((g,u), \fr) = \Big\langle
  \mathbb{T}_{\mathbf{1}_K \otimes \mathbf{1}_{K, \le r}}
  \Delta_{\ZD(u)}, \Gamma_g \Big\rangle_{\RZ_{2,2}} \]
in analogy to \cite[\S6.1]{ref:AFLspherical}.
(Note that $\Delta$ here is the diagonal map $\RZ_2 \to \RZ_{2,2}$.)
For this calculation, it would be sufficient to split
\[ \ZD(u) = \sum_{i \ge 0} \ZD(u/\varpi^i)^\circ. \]
Accordingly, let us introduce the notation
\begin{align*}
  \Int^\circ((g,u), \fr)
  &\coloneqq \Int((g,u), \fr) - \Int\left( \left( g, \frac{u}{\varpi} \right), \fr \right) \\
  &= \Big\langle \mathbb{T}_{\mathbf{1}_K \otimes \mathbf{1}_{K, \le r}}
    \Delta_{\ZD(u)^\circ}, \Gamma_g \Big\rangle_{\RZ_{2,2}}.
\end{align*}
From \Cref{lem:serre_pullback_divisor} we get
\begin{align*}
  \Int^\circ((g,u), \fr)
  &= \left< \ZO4(g \cdot \varpi^r), \; \Delta(\Serre^\ast(\ZD(u))^\circ) \right>_{\MM_2 \times \MM_2} \\
  &= \left< \ZO4(g \cdot \varpi^r), \; \ZO3(\bar u \sqrt{\eps} u)^\circ \right>_{\MM_2 \times \MM_2} \\
  &= \left< \ZO4(g \cdot \varpi^r), \; \ZO4(1)^\circ, \; \ZO4(\bar u \sqrt{\eps} u)^\circ \right>_{\MM_2 \times \MM_2} \\
  &= \left< \ZO4(g \cdot \varpi^r), \; \ZO4(1), \; \ZO4(\bar u \sqrt{\eps} u) \right>_{\MM_2 \times \MM_2} \\
  &\qquad- \left< \ZO4(g \cdot \varpi^r), \; \ZO4(1), \; \ZO4\left( \frac{\bar u \sqrt{\eps} u}{\varpi} \right) \right>_{\MM_2 \times \MM_2}.
\end{align*}
In that case we have
\begin{equation}
  \Int((g,u), \fr)
  = \sum_{i \ge 0} \Int^\circ\left( \left( g, \frac{u}{\varpi^i} \right), \fr \right).
  \label{eq:int_to_int_circ}
\end{equation}

\subsection{The formula of Gross-Keating}
\label{sec:GK}
In what follows, we let
\[ \left\langle x, y \right\rangle _0
  = \frac{\left\langle x,y \right\rangle + \ol{\left\langle x,y \right\rangle}}{2} \]
denote half the $E/F$-trace of $\left\langle x,y \right\rangle \in E$.
Let $\ODT \coloneqq \OO_\DD \cap \DT$.

\begin{proposition}
  [Gross-Keating]
  \label{prop:GK}
  Let $x,y \in \ODT$ and let
  \begin{align*}
    n_1 &= \min\left( v(\left\langle x,x \right\rangle _0), v(\left\langle x,y \right\rangle _0), v(\left\langle y,y \right\rangle _0) \right) \\
    n_2 &= v\left( \left\langle x,x \right\rangle _0 \left\langle y,y \right\rangle _0 - \left\langle x,y \right\rangle^2_0 \right) - n_1
  \end{align*}
  so that $0 \le n_1 \le n_2$.
  Then if $n_1$ is odd, we have
  \[
    \left< \ZO4(1), \; \ZO4(x), \; \ZO4(y) \right>_{\MM_2 \times \MM_2}
    = \sum_{j=0}^{\frac{n_1-1}{2}} (n_1+n_2-4j) q^j
  \]
  while if $n_1$ is even we instead have
  \[
    \left< \ZO4(1), \; \ZO4(x), \; \ZO4(y) \right>_{\MM_2 \times \MM_2}
    = \frac{n_2-n_1+1}{2} q^{n_1/2} + \sum_{j=0}^{n_1/2-1} (n_1+n_2-4j) q^j.
  \]
\end{proposition}
\begin{proof}
  This is a rewriting of \cite[Proposition 14.6]{ref:Kudla1997}
  which is itself a special case of \cite[Proposition 5.4]{ref:GK}.
\end{proof}

We now compute all the quantities needed to invoke the Gross-Keating formula.
We start by writing
\begin{align*}
  \bar u \sqrt{\eps} u
  &= (\ol s - t \Pi) \sqrt{\eps} (s + t \Pi) \\
  &= (\ol s - t \Pi) (s \sqrt{\eps} + t \sqrt{\eps} \Pi) \\
  &= s \ol s \sqrt{\eps} - t \ol{s\sqrt{\eps}} \Pi + \ol s t \sqrt{\eps} \Pi - t \ol{t \sqrt{\eps}} \varpi \\
  &= (s \ol s + t \ol t \varpi) \sqrt{\eps} + 2 \ol s t \sqrt{\eps} \Pi.
\end{align*}
We now invoke \Cref{assume:st_zero} to simplify this to just
\[ \bar u \sqrt{\eps} u = (s \ol s + t \ol t \varpi) \sqrt{\eps}. \]
This assumption will also let us write
\[ (s \ol s + t \ol t \varpi)^2 = (s \ol s - t \ol t \varpi)^2 = (\Nm u)^2. \]

Next we consider
\[ g \cdot \varpi^r = \varpi^r(\alpha + \beta \Pi). \]
(Here the action of $g$ is the one on $\MM_2$,
which is why we write $g \cdot \varpi^r$ rather than $g(\varpi^r$).)
From now on, let's write
\[ \alpha = \alpha_0 + \alpha_1 \sqrt{\eps} \]
for $\alpha_0, \alpha_1 \in F$.
Then we use the notation
\begin{align*}
  x &\coloneqq \bar u \sqrt{\eps} u = (s \bar s + t \bar t \varpi) \sqrt{\eps} \in \ODT \\
  y &\coloneqq (g \cdot \varpi^r)_- = \varpi^r(\alpha_1\sqrt{\eps} + \beta \Pi) \in \ODT.
\end{align*}
Then we can compute
\begin{align*}
  \left\langle x,x \right\rangle _0
  &= \Nm x \\
  &= \Norm_{E/F}((s \bar s + t \bar t \varpi)\sqrt{\eps}) \\
  &= -\eps(s \bar s + t \bar t \varpi)^2 = -\eps (\Nm u)^2 \\
  % --------------------------------------------
  \left\langle y,y \right\rangle _0
  &= \Nm \left( \varpi^r(\alpha_1\sqrt{\eps} + \beta \Pi) \right)  \\
  &= \varpi^{2r} (-\alpha_1^2\eps - \beta\bar\beta \varpi) \\
  % --------------------------------------------
  \left\langle x,y \right\rangle _0 &= (\bar x y)_0 \\
  &= \left[
    -(s \bar s + t \bar t \varpi) \sqrt{\eps}
    \cdot
    \varpi^{r} (\alpha_1\sqrt{\eps} + \beta \Pi)
  \right]_0 \\
  &= - \varpi^r \alpha_1 \eps (s \bar s + t \bar t \varpi).
\end{align*}
This lets us compute the determinant
\begin{align*}
  \left\langle x,x \right\rangle _0 \left\langle y,y \right\rangle _0 - \left\langle x,y \right\rangle^2_0
  &= - \eps (\Nm u)^2\cdot \varpi^{2r}
    (-\alpha_1^2 \eps - \beta \bar\beta \varpi)
  - (\varpi^r \alpha_1 \eps (s \bar s + t \bar t \varpi))^2 \\
  &= \eps (\Nm u)^2\cdot \varpi^{2r} \cdot
    (\varpi \beta \bar\beta).
\end{align*}
Hence we arrive at an exact formula for
\[ \left< \ZO4(1), \; \ZO4(x), \; \ZO4(y) \right>_{\MM_2 \times \MM_2} \]
in terms of the valuations of the above formulas,
which we will explicate in the next section after matching $(g,u)$
to the corresponding element in $(S_2(F) \times V_2'(F))\rs$.
