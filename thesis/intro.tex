\section{Introduction}
Throughout this whole paper, $p > 2$ is a prime,
$F$ is a finite extension of $\QQ_p$,
and $E/F$ is an unramified quadratic field extension.

\subsection{Brief history and motivation for the arithmetic fundamental lemma}
The primary motivation for this paper arises from
the study of conjectured variants of the arithmetic fundamental lemma
for spherical Hecke algebras proposed in \cite{ref:AFLspherical}.
This section briefly provides an overview of the historical context
that led to the formulation of these conjectures.
This history is also summarized in \Cref{fig:history}.

Because this subsection is meant for motivation only, in this survey we do not give
complete definitions or statements, being content to outline a brief gist.
A more detailed account can be found in \cite{ref:survey}.

\begin{figure}[ht]
  \centering
  \begin{tikzcd}
      \text{\cite{ref:waldspurger}} \ar[d] \\
      \text{\cite{ref:GP1,ref:GP2}} \ar[d] \\
    \text{GGP \cite{ref:GGP}}
      \ar[d, dotted, leftrightarrow, "\text{analog}"]
      & \ar[l, Rightarrow, "\text{used to prove}"] \text{FL \cite{ref:JR}}
        \ar[d, dotted, leftrightarrow, "\text{analog}"] \ar[r]
      & \text{\cite{ref:leslie}}
        \ar[d, dotted, leftrightarrow, "\text{analog}"] \\
    \text{Arith.\ GGP \cite{ref:GGP}}
      & \ar[l, Rightarrow, "\text{used to prove}"] \text{AFL \cite{ref:AFL}} \ar[r]
      & \text{\cite{ref:AFLspherical}} \\
    \text{\cite{ref:GZshimura}} \ar[u] \\
    \text{\cite{ref:gross_zagier}} \ar[u]
  \end{tikzcd}
  \caption{The history behind the fundamental lemma and its arithmetic counterpart.
    Unlabeled arrows denote generalizations.}
  \label{fig:history}
\end{figure}

\subsubsection{The GGP conjectures, and the fundamental lemma of Jacquet-Rallis}
In modern arithmetic geometry, a common theme is that there are deep connections
between geometric data with the values of related $L$-functions.

This story begins with a result of
Waldspurger \cite{ref:waldspurger} which showed a formula
relating the nonvanishing of an automorphic period integral
to the central value of the same $L$-functions.
Later, a conjecture that generalizes Waldspurger's formula
was proposed by Gross-Prasad in \cite{ref:GP1,ref:GP2}.
This was further generalized to a series of conjectures
now known as the Gan-Gross-Prasad (GGP) conjectures,
which were proposed in 2012 in \cite{ref:GGP};
they generalize the Gross-Prasad conjecture to different classical groups.
Specifically, the GGP conjecture predict the nonvanishing of a period integral
based on the values of the $L$-function of a certain cuspidal automorphic representation.

In 2011, Jacquet-Rallis \cite{ref:JR} proposed an approach to the Gross-Prasad conjectures
for unitary groups via a relative trace formula (RTF).
The idea is to compare an RTF for the general linear group to one for a unitary group.
This approach relies on a so-called \emph{fundamental lemma},
which links values of certain orbital integrals
over two reductive groups over a non-Archimedean local field.

Let's be a bit more precise about what this fundamental lemma says.
Let $\VV_n^+$ denote the split $E/F$-Hermitian space of dimension $n$ (unique up to isomorphism),
fix a unit vector $w_0$ in it,
and let $(\VV_n^+)^\flat$ be the orthogonal complement of the span of $w_0$.
Let $(G')^\flat \coloneqq \GL_{n-1}(E)$, $G' \coloneqq \GL_n(E)$,
$G^\flat \coloneqq \U((\VV_n^+)^\flat)(F)$ and $G \coloneqq \U(\VV_n^+)(F)$.
For certain
\[ \gamma \in (G')^\flat \times G', \qquad g \in G^\flat \times G \]
the Jacquet-Rallis fundamental lemma proposes a relation between two orbital integrals.
Specifically, it supplies a relation between
\begin{itemize}
\item the orbital integral of $\gamma$ with respect to
  the indicator function $\mathbf{1}_{(K')^\flat \times K'}$
  of the natural hyperspecial compact subgroup
  \[ (K')^\flat \times K' \subset (G')^\flat \times G' = \GL_{n-1}(E) \times \GL_n(E); \]
  and
\item the orbital integral of $g$ with respect to
  the indicator function $\mathbf{1}_{K^\flat \times K}$
  of the natural hyperspecial compact subgroup
  \[ K^\flat \times K \subset G^\flat \times G = \U((\VV_n^+)^\flat)(F) \times \U(\VV_n^+)(F). \]
\end{itemize}
In other words, it states that
\begin{equation}
  \Orb(\gamma, \mathbf{1}_{(K')^\flat \times K'}) = \omega(\gamma) \Orb(g, \mathbf{1}_{K^\flat \times K})
  \label{eq:old_FL}
\end{equation}
where $\omega(\gamma)$ is a suitable \emph{transfer factor}.
The fundamental lemma has since been proved completely;
a local proof was given by Beuzart-Plessis \cite{ref:BeuzartPlessis}
while a global proof was given for large characteristic by W.\ Zhang \cite{ref:Wei2021}.

\subsubsection{The arithmetic GGP conjectures, and the arithmetic fundamental lemma}
At around the same time Waldspurger's formula was published,
Gross-Zagier \cite{ref:gross_zagier} proved a formula
relating the height of Heegner points
on certain modular curves to the derivative at $s=1$ of certain $L$-functions.
The Gross-Zagier formula was then generalized over several decades,
culminating in \cite{ref:GZshimura} where the formula is established
for Shimura curves over arbitrary totally real fields.

An arithmetic analogue of the original Gan-Gross-Prasad conjectures,
which we henceforth refer to as \emph{arithmetic GGP} \cite{ref:GGP},
can then be formulated, further generalizing Gross-Zagier's formula.
Here the modular curves in Gross-Zagier
are replaced with higher dimensional Shimura varieties.
Rather than the period integrals considered previously,
one instead takes intersection numbers of cycles on some Shimura varieties.
Specifically, if one considers the Shimura variety associated to a classical group,
the arithmetic GGP conjecture predicts a relation between intersection numbers
on this Simura variety with the central derivative of automorphic $L$-functions.

By analogy to the work Jacquet-Rallis \cite{ref:JR},
the arithmetic GGP conjectures should have a corresponding
\emph{arithmetic fundamental lemma} (henceforth AFL),
which was proposed by W.\ Zhang \cite[Conjecture 2.9]{ref:AFL}.
The arithmetic fundamental lemma then relates the derivative
of the weighted orbital integral with respect to the indicator function
$\mathbf{1}_{(K')^\flat \times K'} \in \HH((G')^\flat \times G, (K')^\flat \times K')$, that is
\[ \left. \pdv{}{s} \right\rvert_{s=0} \Orb(\gamma, \mathbf{1}_{(K')^\flat \times K'}, s) \]
for $\gamma \in (G')^\flat \times G'$,
to arithmetic intersection numbers on a certain Rapoport-Zink formal moduli space.
The AFL in \cite{ref:AFL} has since been proven over $p$-adic fields for any large
prime $p$ in Mihatsch-Zhang \cite{ref:MZ2021}, W.\ Zhang \cite{ref:Wei2021},
and then for any odd prime $p$ by Z.\ Zhang \cite{ref:Zhiyu}.

\subsubsection{The semi-Lie version of the AFL proposed by Liu}
There is another different version of the AFL, proposed by Yifeng Liu in
\cite[Conjecture 1.12]{ref:liuFJ},
which is often referred to as the \emph{semi-Lie version} of the AFL.
Its statement has been shown to be equivalent to AFL,
see \cite[Remark 1.13]{ref:liuFJ} and is thus now proven.
In contrast, the original AFL proposed by Zhang in \cite[Conjecture 2.9]{ref:AFL}
is sometimes referred to as the \emph{group version}.

A more detailed account of this equivalence is described in \cite[\S1.4]{ref:liuFJ}.

\subsubsection{Generalizations of FL and AFL to the full spherical Hecke algebra}
Recently it was shown by Leslie \cite{ref:leslie} that in fact
\eqref{eq:old_FL} holds in greater generality where the indicator function
$\mathbf{1}_{K^\flat \times K}$ can be replaced by any element in the spherical
Hecke algebra $\varphi \in \HH((G')^\flat \times G', (K')^\flat \times K')$.
In that case, $\mathbf{1}_{(K')^\flat \times K}$ needs to be replaced
by the corresponding element $\varphi'$ under a certain base change homomorphism
\begin{align*}
  \HH((G')^\flat \times G', (K')^\flat \times K') &\to \HH(G^\flat \times G, K^\flat \times K) \\
  \varphi' &\mapsto \varphi
\end{align*}

In that case, the identity \eqref{eq:old_FL} still hold as
\begin{equation}
  \Orb(\gamma, \varphi') = \omega(\gamma) \Orb(g, \varphi).
  \label{eq:eq:leslie_FL}
\end{equation}
To complete the analogy illustrated in \Cref{fig:history},
there should thus be a generalization of the AFL in which
$\mathbf{1}_{(K')^\flat \times K}$ is replaced by any element of the Hecke algebra
$\HH((G')^\flat \times G, (K')^\flat \times K)$.
This conjectural generalization
(for the group version of the AFL) is \cite{ref:AFLspherical}
and we discuss it momentarily;
while the analogous conjectural generalization for the semi-Lie version of the AFL
is our \Cref{conj:semi_lie_spherical} also discussed in the next section.

\subsection{Formulation of AFL conjectures to the full spherical Hecke algebra}
\subsubsection{The inhomogeneous version of the arithmetic fundamental lemma for spherical Hecke algebras proposed by Li-Rapoport-Zhang}
In contrast to the vague motivational cheerleading in the previous section,
starting in this section we will give more precise statements,
even though we will necessarily need to reference definitions appearing in later sections.

Retain the notation $G' \coloneqq \GL_n(E)$, and $G \coloneqq \U(\VV_n^+)(F)$,
with $K' \subset G'$ and $K \subset G$ the natural hyperspecial compact subgroups.
Also, let $q$ denote the residue characteristic of $F$.
Moreover, define the symmetric space
\[ S_n(F) \coloneqq \left\{ g \in \GL_n(E) \mid g \bar{g} = \id_n \right\}. \]
Finally, let $\VV_n^-$ be the non-split Hermitian space of dimension $n$
(unique up to isomorphism),
while $\VV_n^+$ continues to denote the split one (again unique up to isomorphism).

For concreteness, we focus on the inhomogeneous version
of the arithmetic fundamental lemma, which is \cite[Conjecture 6.2.1]{ref:AFLspherical}.
This allows us to deal with just $G'$ instead of $(G')^\flat \times G'$, etc.,
so that the Hecke algebra $\HH((G')^\flat \times G', (K')^\flat \times K')$
can be replaced by the simpler one $\HH(\GL_n(E)) \coloneqq \HH(G', K')$.
Similarly, $\HH(G^\flat \times G, K^\flat \times K)$
can be replaced by the simpler $\HH(\U(\VV_n^+)) \coloneqq \HH(G, K)$.

The AFL conjecture provides a bridge between a geometric left-hand side
(given by an intersection number)
and an analytic right-hand side (given by a weighted orbital integral).
Stating it requires several pieces of data.
We only mention these pieces by name here, with definitions given later:
\begin{itemize}
  \ii On the geometric side, we have an intersection number.
  It uses the following ingredients.
  \begin{itemize}
    \ii We choose a regular semisimple element $g \in \U(\VV_n^-)\rs$.
    (The notation $\U(\VV_n^-)\rs$ denotes the regular semisimple elements of $\U(\VV_n^-)$, etc.
    The notion of regular semisimple is defined in \Cref{def:regular}.)
    \ii We choose a function $f \in \HH(\U(\VV_n^+))$ from the spherical Hecke algebra,
    defined in \Cref{ch:background}.
    \ii We define a certain \emph{intersection number} $\Int(g, f)$
    in \Cref{def:intersection_number_inhomog}.
    These intersection numbers take place in a Rapoport-Zink space
    described in \Cref{ch:geo}.
  \end{itemize}

  \ii On the analytic side, we have a weighted orbital integral.
  It uses the following ingredients.
  \begin{itemize}
    \ii We choose a regular semisimple element $\gamma \in S_n(F)\rs$.
    \ii We choose a test function $\phi$ which comes
    from a certain $\HH(\GL_n(E))$-module that we will denote $\HH(S_n(F))$.
    This module $\HH(S_n(F))$ is defined in \Cref{ch:background}.
    \ii The weighted orbital integral $\Orb(\gamma, \phi, s)$
    is itself defined in \Cref{def:orbital0}.
    (It is connected to an unweighted orbital integral on the unitary group
    according to \Cref{thm:rel_fundamental_lemma}.)
    We abbreviate
    \[ \partial \Orb(\gamma, \phi)
      \coloneqq \left. \pdv{}{s} \right\rvert_{s=0} \Orb(\gamma, \phi, s). \]
    \ii There is also an extra transfer factor $\omega \in \{\pm1\}$
    which we define in \Cref{ch:transf}.
  \end{itemize}

  \ii We need a way to connect the inputs between the two parts of our conjecture.
  Specifically, $f$ and $\phi$ need to be linked, and $g$ and $\gamma$ need to be linked.
  This is done as follows.
  \begin{itemize}
    \ii Once the regular semisimple element $g \in \U(\VV_n^-)\rs$ is chosen,
    we require $\gamma \in S_n(F)\rs$ to be a \emph{matching} element.
    This matching is defined in \Cref{def:matching_inhomog}.
    (Alternatively, one could imagine picking $\gamma \in S_n(F)\rs$ first
    and finding corresponding $g$.
    It turns out $\gamma$ will match an element of $\U(\VV_n^\pm)\rs$ in general,
    and the conjecture is only formulated in the case where $g \in \U(\VV_n^-)$.)

    \ii Once $f \in \HH(\U(\VV_n^+))$ is chosen, we select
    \[ \phi = (\BC_{S_n}^{\eta^{n-1}})^{-1}(f) \]
    to be the image of $f$ under a \emph{base change}.
    This base change is defined and then calculated explicitly for $n = 3$ in \Cref{ch:satake}.
  \end{itemize}
\end{itemize}
With all our protagonists now having names and references,
we can now state the conjecture proposed in \cite{ref:AFLspherical}.

\begin{conjecture}
  [Inhomogeneous version of the AFL for the full spherical Hecke algebra,
  {\cite[Conjecture 6.2.1]{ref:AFLspherical}}]
  \label{conj:inhomog_spherical}
  Let $f \in \HH(\U(\VV_n^+))$ be any element of the Hecke algebra, and let
  \[ \phi = (\BC_{S_n}^{\eta^{n-1}})^{-1}(f) \in \HH(S_n(F)) \]
  be its image under base change as defined in \Cref{ch:satake}.
  Then for matching (as defined in \Cref{def:matching_inhomog}) regular semisimple elements
  \[ g \in \U(\VV_n^-)\rs \longleftrightarrow \gamma \in S_n(F)\rs \]
  we have
  \begin{equation}
    \Int\left( (1,g), \mathbf{1}_{K^\flat} \otimes f \right)
    = -\frac{\omega(\gamma)}{\log q} \partial \Orb(\gamma, \phi)
    \label{eq:inhomog}
  \end{equation}
  where the weighted orbital integral $\Orb(\dots)$ is defined in \Cref{def:orbital0},
  the transfer factor $\omega$ is defined in \Cref{ch:transf},
  and the intersection number $\Int(\dots)$ is defined in \Cref{ch:geo}.
\end{conjecture}

At present, the (inhomogeneous) AFL is the case where $f = \mathbf{1}_K$,
and is thus proven.
Note that in the case of interest where $\gamma \in S_n(F)\rs$
matches an element of $\U(\VV_n^-)\rs$ (rather than $\U(\VV_n^+)\rs$),
the actual value of $\Orb(\gamma, \phi, s)$ at $s = 0$ is always zero
by \Cref{thm:rel_fundamental_lemma};
so the conjecture instead looks at the first derivative at $s = 0$.

The generalized conjecture is also proved in full for
$n = 2$ in \cite[Theorem 1.0.1]{ref:AFLspherical}
(in that reference, our $n$ denotes the $n+1$ in \emph{loc.\ cit.}).
The part of the calculation involving the weighted orbital integral has two parts:
\begin{itemize}
  \ii The calculation makes $\BC_{S_{n}}^{\eta^{n-1}}$
  completely explicit in a natural basis for $n = 2$.
  The result is \cite[Lemma 7.1.1]{ref:AFLspherical}.

  \ii The calculation makes explicit the value of the weighted orbital integral
  \[ \Orb(\gamma, \phi, s) \]
  for any $\gamma \in S_n(F)\rs$ and $\phi \in \HH(S_n(F))$,
  in terms of invariants of $\gamma$ and a decomposition of $\phi$ in a natural basis.
  The result is \cite[Proposition 7.3.2]{ref:AFLspherical}.
\end{itemize}
Combining these two (hence obtaining the right-hand side of \eqref{eq:inhomog})
with a calculation of intersection numbers in \cite[Corollary 7.4.3]{ref:AFLspherical}
(which is the left-hand side of \eqref{eq:inhomog})
shows that \Cref{conj:inhomog_spherical} holds for $n = 2$,
cf.\ \cite[Theorem 7.5.1]{ref:AFLspherical}.

\subsubsection{A proposed arithmetic fundamental lemma for spherical Hecke algebras in the semi-Lie case}
The primary focus of this paper is an analogous conjecture to \Cref{conj:inhomog_spherical}
for the semi-Lie version (also called the Fourier-Jacobi case).
It serves to complete the analogy given in \Cref{tab:semi_lie_analogy}.

\begin{table}[ht]
  \centering
  \begin{tabular}{lll}
    \toprule
    Version & AFL for $\mathbf{1}$ (now proven) & Full spherical Hecke \\
    \midrule
    Group & \cite[Conjecture 2.9]{ref:AFL} & \cite[Conjecture 6.2.1]{ref:AFLspherical} \\
    Semi-Lie & \cite[Conjecture 1.12]{ref:liuFJ} & \Cref{conj:semi_lie_spherical} \\
    \bottomrule
  \end{tabular}
  \caption{Table showing the analogy between the proposed
    \Cref{conj:semi_lie_spherical} and the existing conjectures.}
  \label{tab:semi_lie_analogy}
\end{table}

In this variation, as in \cite{ref:liuFJ},
rather than matching $g \in \U(\VV_n^-)\rs$ to $\gamma \in S_n(F)\rs$,
we consider an augmented space larger than $\U(\VV_n^-)$ and $S_n(F)$.
Specifically, one considers a matching between tuples of regular semisimple elements
\[ (g, u) \in (\U(\VV_n^-) \times \VV_n^-)\rs
  \longleftrightarrow (\gamma, \uu, \vv^\top) \in (S_n(F) \times V'_n(F))\rs \]
where $V'_n(F) = F^n \times (F^n)^\vee$ (defined in \Cref{def:matching_semi_lie})
consists of pairs of column vectors and row vectors of length $n$,
and the space $\VV_n^-$ is defined in \Cref{def:VV_n_nonsplit}.
The notion of \emph{matching} is defined in \Cref{def:matching_semi_lie} as well.

Meanwhile, we still use the same test functions $f$ and $\phi$,
as we did for \cite[Conjecture 6.2.1]{ref:AFLspherical}.
The derivative of interest will be denoted
\[ \partial \Orb(\guv, \phi) \coloneqq
  \left. \pdv{}{s} \right\rvert_{s=0}
  \Orb((\gamma, \uu, \vv^\top), \phi \otimes \oneV, s). \]
Finally, we also update the definition of intersection number
to accommodate the new term $u$ in \Cref{def:intersection_number_semi_lie_spherical}.
\begin{conjecture}
  [Semi-Lie version of the AFL for the full spherical Hecke algebra]
  Let $f \in \HH(\U(\VV_n^+))$ be any element of the Hecke algebra, and let
  \[ \phi = (\BC_{S_n}^{\eta^{n-1}})^{-1}(f) \in \HH(S_n(F)) \]
  be its image under base change defined in \Cref{ch:satake}.
  Then for matching (as defined in \Cref{def:matching_semi_lie}) regular semisimple elements
  \[ (g, u) \in (\U(\VV_n^-) \times \VV_n^-)\rs \longleftrightarrow
    \guv \in (S_n(F) \times V'_n(F))\rs \]
  we have
  \begin{equation}
    \Int\left( (g,u), f \right) = -\frac{\omega\guv}{\log q} \partial \Orb(\guv, \phi \otimes \oneV)
  \end{equation}
  where the orbital integral $\Orb(\dots)$ is defined in \Cref{def:orbitalFJ},
  the transfer factor is defined in \Cref{ch:transf},
  and the intersection number $\Int(\dots)$ is defined in \Cref{ch:geo}.
  \label{conj:semi_lie_spherical}
\end{conjecture}
Note that in this version the new orbital integral $\Orb(\guv, \phi \otimes \oneV, s)$
is defined similarly.
However, as far as we know, no analog of \Cref{thm:rel_fundamental_lemma}
(linking it to an unweighted orbital integral on the unitary side) appears in the literature.
Thus we record the corresponding statement as \Cref{conj:rel_fundamental_lemma_semilie}.
Like before, \Cref{conj:rel_fundamental_lemma_semilie}
predicts that $\Orb(\guv, \phi \otimes \oneV, 0) = 0$ in the case of interest,
which in this case can be checked independently.

\begin{remark}
  For $n = 1$, the Hecke algebra $\HH(S_n(F))$ is trivial
  and therefore \Cref{conj:semi_lie_spherical}
  becomes a special case of the known result \cite{ref:liuFJ}.
  Therefore $n=2$ is the first case of \Cref{conj:semi_lie_spherical} worth examining.
\end{remark}

\subsubsection{A proposed large image conjecture}
\label{sec:intro_large_kernel}

We let $S_n(F)\rs^-$ (resp.\ $(S_n(F) \times V'_n(F))\rs^-$)
denote the subsets of $S_n(F)\rs$ (resp.\ $(S_n(F) \times V'_n(F))\rs$)
consisting of regular semisimple elements that also match with an element of
$\U(\VV_n^-)\rs$ (resp.\ $(\U(\VV_n^-) \times \VV_n^-)\rs$),
i.e.\ those for which \Cref{conj:inhomog_spherical}
and \Cref{conj:semi_lie_spherical} apply.

In \cite{ref:AFLspherical}, it was observed that for $n = 2$
there was a rather large space of $\phi \in \HH(S_2(F))$ such that
\[ \partial \Orb \left(\gamma, \phi \right) = 0 \]
held identically across all $\gamma \in S_2(F)\rs^-$.
If we consider the map
\begin{align*}
  \partial\Orb \colon \HH(S_2(F)) &\to \mathcal{C}^\infty(S_2(F)\rs^-) \\
  \phi &\mapsto \left( \gamma \mapsto \partial \Orb \left(\gamma, \phi \right) \right)
\end{align*}
then \cite[Theorem 8.2.3]{ref:AFLspherical} in fact
shows this map has a kernel of codimension $2$
(equivalently, the image of the map was only two-dimensional).
They thus stated \cite[Conjecture 1.0.2]{ref:AFLspherical} which asserts that for $n \ge 2$,
a similarly defined map (albeit for more than one Hecke algebra) has a large kernel.

It is therefore natural to ask whether a similar large kernel result
could hold for the analogous orbital integral in the semi-Lie case.
We instead propose the following \emph{large image} conjecture,
which we have proved for $n = 2$.
\begin{conjecture}
  [Large image conjecture for $(S_n(F) \times V'_n(F))\rs^-$]
  \label{conj:kernel_semi_lie}
  Let $n \ge 2$.
  The map
  \begin{align*}
    \partial\Orb \colon \HH(S_n(F)) &\to \mathcal{C}^\infty\left( (S_n(F) \times V'_n(F))^- \right) \\
    \phi &\mapsto \left( \guv \mapsto \partial \Orb \left(\guv, \phi \right) \right)
  \end{align*}
  is injective.
\end{conjecture}
In fact for $n=2$ we have a more precise result
showing that the injectivity essentially comes from $v(\uu\vv^\top)$ alone in this case.
See \Cref{thm:semi_lie_ker_trivial} and \Cref{thm:semi_lie_ker_huge} momentarily.

\subsection{Results}
\ifthesis
Most of the results here are dedicated toward the semi-Lie version of the AFL,
which is the new contribution provided by this paper.
But in \Cref{sec:results_group_AFL} we mention some other results
we proved for the group version of the AFL.
\fi

\subsubsection{Formulas for the orbital side of the semi-Lie AFL conjecture for $n=2$}
\label{sec:semi_lie_intro_formulas}
The main case of interest in this thesis is the new conjectured AFL
for the spherical Hecke algebra in the semi-Lie situation in the
specific case $n = 2$ where one can provide evidence for the conjecture.
On the orbital side, the various ingredients can be described concretely
in the following way:
\begin{itemize}
  \ii The Hecke algebra $\HH(S_2(F))$ has a natural basis of
  indicator functions $\mathbf{1}_{K', \le r}$ for each $r \ge 0$;
  see \Cref{ch:orbitalFJ0} for a definition.

  \ii Suppose $\guv \in (S_2(F) \times V'_2(F))\rs^-$.
  Then under the action $\GL_2(F)$ we may assume $\guv$ is of the form
  \[
    \guv = \left( \begin{pmatrix} a & b \\ c & d \end{pmatrix},
      \begin{pmatrix} 0 \\ 1 \end{pmatrix},
      \begin{pmatrix} 0 & e \end{pmatrix} \right)
    \in (S_2(F) \times V_2'(F))\rs^-
  \]
  (that is, we can find a $\GL_2(F)$-orbit representative of this form).
  The parameters $a$, $b$, $c$, $d$ need to satisfy certain dependencies
  for the matching to hold;
  these requirements are documented in \Cref{lem:semi_lie_params}.
\end{itemize}

Then we were able to derive the following fully explicit formula
in terms of the representative detailed in \Cref{lem:semi_lie_params}.
See \Cref{sec:proof_semi_lie_formula} for some concrete examples
and illustrations of \Cref{thm:semi_lie_formula}.
\begin{restatable}[Explicit orbital integral on $S_2(F) \times V'_2(F)$]{theorem}{semilieformula}
  \label{thm:semi_lie_formula}
  Let
  \[
    \guv = \left( \begin{pmatrix} a & b \\ c & d \end{pmatrix},
      \begin{pmatrix} 0 \\ 1 \end{pmatrix},
      \begin{pmatrix} 0 & e \end{pmatrix} \right)
    \in (S_2(F) \times V_2'(F))\rs^-
  \]
  satisfy the requirements in \Cref{lem:semi_lie_params}.
  Let $r \ge 0$.

  If $v(e) < 0$ or $v(b) + v(c) < -2r$, then
  \[ \Orb(\guv, \mathbf{1}_{K'_{S, \le r}} \otimes \oneV, s) = 0 \]
  holds identically for all $s \in \CC$.

  Otherwise define
  \[ \nn_\guv(k) \coloneqq \min\left( \left\lfloor \tfrac{k + (v(b)+r)}{2} \right\rfloor,
    \left\lfloor \tfrac{(2v(e)+v(c)+r)-k}{2} \right\rfloor, N \right) \]
  where
  \[ N \coloneqq \min \left(
      v(e), \tfrac{v(b)+v(c)-1}{2} + r,
      v(d-a) + r \right). \]
  Also, if $v(d-a) < v(e) - r$ and $v(b) + v(c) > 2v(d-a)$, then additionally define
  \begin{align*}
    \cc_\guv(k) &= \min\big( k - (2v(d-a)-v(b)+r), \\
      &\qquad (2v(e)+v(c)-2v(d-a)-r)-k, v(e)-v(d-a)-r \big).
  \end{align*}
  Otherwise define $\cc_\guv(k) = 0$.
  Then we have
  \begin{align*}
    \Orb(\guv, \mathbf{1}_{K'_{S, \le r}}, s)
    &= \sum_{k = -(v(b)+r)}^{2v(e)+v(c)+r} (-1)^k
    \left( 1 + q + q^2 + \dots + q^{\nn_\guv(k)} \right) (q^s)^k \\
    &+ \sum_{k = 2v(d-a)-v(b)+r}^{2v(e)+v(c)-2v(d-a)-r} (-1)^k \cc_\guv(k) q^{v(d-a) + r} (q^s)^k.
  \end{align*}
\end{restatable}

Differentiating this yields the following result:
\begin{restatable}[Derivative at $s=0$ for $S_2(F) \times V'_2(F)$]{corollary}{semiliederiv}
  \label{cor:semi_lie_derivative_single}
  Retain the setting of \Cref{thm:semi_lie_formula}.
  Also define $\varkappa \coloneqq v(e) - (v(d-a)+r)$.
  If both $\varkappa \ge 0$ and $v(b) + v(c) > 2v(d-a)$, then we have the formula
  \begin{align*}
    \frac{(-1)^{v(c)+r}}{\log q}
    &\partial \Orb(\guv, \mathbf{1}_{K'_{S, \le r}}) \\
    &= \sum_{j=0}^N \left( \frac{2v(e)+v(b)+v(c)+1}{2} + r - 2j \right) \cdot q^j \\
    & - q^{v(d-a)+r} \cdot
    \begin{cases}
      \frac{\varkappa}{2} & \text{if }\varkappa \equiv 0 \pmod 2 \\
      \left( v(e)+\frac{v(b)+v(c)}{2}-2v(d-a)-r \right) - \frac{\varkappa}{2}
      & \text{if }\varkappa \equiv 1 \pmod 2.
    \end{cases}
  \end{align*}
  Otherwise we instead have the formula
  \[
    \frac{(-1)^{v(c)+r}}{\log q}
    \partial \Orb(\guv, \mathbf{1}_{K'_{S, \le r}}) \\
    = \sum_{j=0}^N \left( \frac{2v(e)+v(b)+v(c)+1}{2} + r - 2j \right) \cdot q^j.
  \]
\end{restatable}

The formula simplifies even further if one considers instead
$\mathbf{1}_{K'_{S, \le r}} + \mathbf{1}_{K'_{S, \le (r-1)}}$;
and indeed we will see that this particular combination
comes up naturally in \Cref{ch:finale} with a special role
as the base change mentioned in \cite[Lemma 7.1.1]{ref:AFLspherical}.

\begin{restatable}[The special case $\partial \Orb(\guv, \mathbf{1}_{K'_{S, \le r}} + \mathbf{1}_{K'_{S, \le (r-1)}})$]{corollary}{semiliecombo}
  \label{cor:semi_lie_combo}
  Retain the setting of \Cref{thm:semi_lie_formula}.
  Also define $\varkappa \coloneqq v(e) - (v(d-a)+r)$.
  For $r \ge 1$ define
  \begin{align*}
    C &\coloneqq
    \begin{cases}
      \frac{\varkappa-1}{2}
        & \text{if } \varkappa > 0 \text{ is odd}
          \text{ and } v(b) + v(c) > 2v(d-a)  \\
      \frac{\varkappa+v(b)+v(c)-2v(d-a)-1}{2}
        & \text{if } \varkappa \ge 0 \text{ is even}
          \text{ and } v(b) + v(c) > 2v(d-a)  \\
      v(e) - N
        & \text{if } v(e) \ge \frac{v(b)+v(c)-1}{2} + r
        \text{ and } 2v(d-a) > v(b) + v(c) \\
      0 & \text{otherwise}
    \end{cases} \\
    C' &\coloneqq
    \begin{cases}
      C + 1 & \text{if } \varkappa \ge 0 \text{ and } v(b)+v(c) > 2v(d-a) \\
      0 & \text{otherwise}.
    \end{cases}
  \end{align*}
  Then
  \begin{align*}
    \frac{(-1)^{v(c)+r}}{\log q} &
    \partial\Orb(\guv, \mathbf{1}_{K'_{S, \le r}} + \mathbf{1}_{K'_{S, \le (r-1)}}) \\
    &= (q^N + q^{N-1} + \dots + 1) + C q^N + C' q^{N-1}
  \end{align*}
\end{restatable}

\begin{example}[Examples of \Cref{cor:semi_lie_combo}]
  We show some examples of \Cref{cor:semi_lie_combo}:
  \begin{itemize}
  \ii When $r=5$, $v(b) = -20$, $v(c) = 37$, $v(e) = 35$ and $v(d-a) > \frac{v(b)+v(c)}{2} = 8.5$
  the derivative in \Cref{cor:semi_lie_combo} equals
  \[ \log q \cdot (23q^{13} + q^{12} + q^{11} + q^{10} + q^9 + \dots + q + 1). \]
  \ii When $r = 6$, $v(b) = 10$, $v(c) = 5$, $v(e) = 7$, $v(d-a) > v(e)-r = 1$,
  the derivative in \Cref{cor:semi_lie_combo} equals
  \[ -\log q \cdot (q^7 + q^6 + q^5 + \dots + q + 1). \]
  \ii When $r = 8$, $v(b) = -101$, $v(c) = 1000$, $v(e) = 29$, $v(d-a) = 11$,
  the derivative in \Cref{cor:semi_lie_combo} equals
  \[ \log q \cdot (444 q^{19} + 445q^{18} + q^{17} + q^{16} + q^{15} + \dots + q + 1). \]
  \end{itemize}
\end{example}

\subsubsection{Kernel and image results for the semi-Lie orbital integral when $n=2$}
As we mentioned our earlier conjecture \Cref{conj:kernel_semi_lie}
is true for $n = 2$.
More precisely, we have the following two theorems.

\begin{restatable}[$\partial\Orb$ is injective even for fixed $\gamma \in S_2(F)$]{theorem}{semiliekertriv}
  \label{thm:semi_lie_ker_trivial}
  Fix any $\guv \in (S_2(F) \times V'_2(F))\rs^-$.
  Then there doesn't exist any nonzero function $\phi \in \HH(S_2(F))$ such that
  \[ \partial \Orb \left( (\gamma, \uu, \varpi^i \vv^\top), \phi \right) = 0 \]
  holds for every integer $i$.
  Thus \Cref{conj:kernel_semi_lie} holds for $n = 2$.
\end{restatable}

In particular, for $n=2$ the map
\begin{align*}
  \partial\Orb \colon \HH(S_2(F)) &\to \mathcal{C}^\infty\left( (S_2(F) \times V'_2(F))^- \right) \\
  \phi &\mapsto \left( \guv \mapsto \partial \Orb \left(\guv, \phi \right) \right)
\end{align*}
is indeed injective.

\begin{restatable}[The kernel of $\partial\Orb$ is large for fixed $(\uu, \vv^\top) \in V'_2(F)$]{theorem}{semiliekerlarge}
  \label{thm:semi_lie_ker_huge}
  Let $N \ge 0$ be an integer.
  Consider all $\guv \in (S_2(F) \times V'_2(F))\rs^-$ for which $v(\uu\vv^\top) \le N$.
  Then the space of $\phi \in \HH(S_2(F))$ for which
  \[ \partial \Orb \left( \guv, \phi \right) = 0 \]
  holds for all such $\guv$ is a $\QQ$-vector subspace of $\HH(S_2(F))$
  whose codimension is at most $N + 2$.

  Moreover, this subspace of $\HH(S_2(F))$
  is not contained in any maximal ideal of $\HH(S_2(F))$
  when $\HH(S_2(F))$ is viewed as a ring under the isomorphism of \Cref{ch:satake}.
\end{restatable}

\begin{remark}
  [On formalizing large kernels]
  In each case the Hecke algebra is isomorphic as a $\QQ$-algebra to $\QQ[T]$
  for a single variable $T = Y+Y^{-1}$.
  So actually it's mildly surprising that we get a result on finite codimension.
  In general, a finite codimension vector subspace of $\QQ[T]$ could
  be contained in a maximal ideal,
  such as the codimension one subspace $T \mathbb Q[T] \subset \QQ[T]$.
  Conversely, a \emph{finite} dimension vector subspace might still
  not be contained in any maximal ideal,
  such as the one-dimensional space $\QQ \subseteq \QQ[T]$.

  Thus neither finite codimension nor generating all of $\QQ[T]$ as an ideal imply each other.
  It might be interesting to consider other different ways
  of formalizing the notion of ``large kernel''.
\end{remark}

\subsubsection{The geometric side of the semi-Lie AFL conjecture for $n=2$}
\ifthesis
On the geometric side, we were also able to determine the intersection numbers
subject to the provisionsal \Cref{hypo:serre_pullback_space}.
\begin{theorem}
  [Semi-Lie AFL for the full Hecke algebra for $n=2$]
  \label{thm:semi_lie_n_equals_2}
  Assume \Cref{hypo:serre_pullback_space}.
  Then our generalized AFL conjecture, \Cref{conj:semi_lie_spherical}, holds for $n = 2$.
\end{theorem}
\fi
\ifpaper
To provide evidence for \Cref{conj:semi_lie_spherical}, we prove that:
\begin{theorem}
  [Semi-Lie AFL for the full Hecke algebra for $n=2$]
  \label{thm:semi_lie_n_equals_2}
  Our generalized AFL conjecture, \Cref{conj:semi_lie_spherical}, holds for $n = 2$.
\end{theorem}
\fi

The proof of \Cref{thm:semi_lie_n_equals_2} is built up gradually
throughout the paper, culminating in \Cref{ch:finale}.

We comment briefly on the strategy of the proof.
The proof is made possible because the intersection numbers for $n=2$
are easier to work with for a few reasons.
\begin{itemize}
\ii First, one can identify $\VV_2^-$ with an $E/F$-quaternion division algebra,
equipped with a compatible Hermitian form defined via quaternion multiplication.
This makes it possible to describe $\U(\VV_2^-)$ concretely as transformations obtained
via left multiplication by an element of $E$ and right multiplication by a quaternion.
\ii Secondly, it becomes possible to replace the so-called Rapoport-Zink spaces $\RZ_2$
used in the definition of the intersection number with a Lubin-Tate space $\MM_2$.
Thus the problem of computing the intersection number
$\Int\left( (g,u), f \right) \log q$
can be reduced to calculating the intersection of certain special
Kudla-Rapoport divisors on the space $\MM_2$.

However, on the Lubin-Tate space $\MM_2$,
there is a result known as the Gross-Keating formula \cite{ref:GK}
which allows one to make this intersection number fully explicit.
One can then match the resulting equation to the formulas described in
\Cref{cor:semi_lie_derivative_single}
and verify that, under the base change \Cref{ch:satake}
and the matching condition described in \Cref{ch:rs_matching},
the two obtained formulas are identical.
\end{itemize}
\ifthesis
The hypothesis \Cref{hypo:serre_pullback_space}
is a stipulation that the pullback of two of the divisors
behaves in the way one would expect.
\fi

\ifthesis
\subsubsection{Results for $n=3$ for the group AFL}
\label{sec:results_group_AFL}
For the group AFL, we were able to fully compute the orbital integral as well.
The result is too involved to state in the introduction,
but we give the following summary.
\begin{theorem}
  [Summary of the weighted orbital integral for $S_3(F)$]
  \label{thm:summary}
  Let $\gamma \in S_3(F)\rs^-$.
  Then the weighted orbital integral $\Orb(\gamma, \phi, s)$ takes the form
  \[ \sum_k P_k(q) (-q^s)^k \]
  for some polynomials $P_k(q) \in \ZZ[q]$, where
  \begin{itemize}
    \ii the summation variable $k$ is some contiguous range of integers,

    \ii the polynomials $P_k \in \ZZ[q]$ are nonzero and satisfy the property
    that every coefficient of $P_k$ besides possibly the leading coefficient is $1$;

    \ii both $\deg P_k$ and leading coefficient of $P_k$ are the integer parts
    of piecewise linear functions in $k$ with slopes in $\{0, \pm\half, \pm 1\}$.
  \end{itemize}
  The range of the summation, and the aforementioned piecewise linear function(s),
  can be written explicitly in terms of a particular representative
  in the orbit of $\gamma$.
\end{theorem}
For a full statement, see
\Cref{thm:full_orbital_ell_odd,thm:full_orbital_ell_even,thm:full_orbital_ell_neg}.
The calculation corresponds directly to the earlier results
\cite[Lemma 7.1.1 and Proposition 7.3.2]{ref:AFLspherical}
which were the case $n = 2$ of the inhomogeneous group version of the AFL
(note what \cite{ref:AFLspherical} calls $n$ is $n+1$ in our notation).
The methods, which are local in nature,
are rather similar to those employed in \cite{ref:AFL},
which can be thought of as the case $r = 0$.

\begin{remark}
  [\Cref{thm:summary} applies to \Cref{thm:semi_lie_formula}]
  Interestingly, the formula \Cref{thm:semi_lie_formula}
  for $\guv \in (S_2(F) \times V'_2(F))\rs$
  actually fits the same template as \Cref{thm:summary},
  although the semi-Lie formula is more pleasant.
  We do not have a good explanation why the shapes of the orbital integrals
  end up being so similar.
\end{remark}

We were also able to determine the
relevant base changes in \Cref{ch:satake}.
However, we did not complete the comparison on the geometric side in this situation.
Thus we do not claim a proof of $n = 3$ of \Cref{conj:inhomog_spherical},
although we imagine such a proof could be completed
once a method for determining the intersection numbers explicitly is devised.
On the other hand, the orbital data is enough to prove the following result,
which serves as an analog to \Cref{conj:kernel_semi_lie}.
\begin{restatable}[$\partial\Orb \colon \HH(S_3(F)) \to \mathcal{C}^\infty(S_3(F)\rs^-)$ has large image]{theorem}{nogroupkernel}
  \label{thm:no_kernel_group}
  There is no nontrivial $\phi \in \HH(S_3(F))$ such that
  \[ \partial \Orb \left( \gamma, \phi \right) = 0 \]
  holds for every $\gamma \in S_3(F)\rs^-$.
  In other words, the map
  \begin{align*}
    \partial\Orb \colon \HH(S_3(F)) &\to \mathcal{C}^\infty(S_3(F)\rs^-) \\
    \phi &\mapsto \left( \gamma \mapsto \partial \Orb \left(\gamma, \phi \right) \right)
  \end{align*}
  is injective, i.e., has image as large as possible, for $n = 3$.
\end{restatable}
\begin{remark}
  [Comparison to {\cite[Conjecture 1.0.2]{ref:AFLspherical}}]
  Note that \Cref{thm:no_kernel_group} does not falsify
  \cite[Conjecture 1.0.2]{ref:AFLspherical},
  because the conjecture in \emph{loc.\ cit.}\ is formulated
  for a larger Hecke algebra $\HH(S_{n-1}(F)) \otimes \HH(S_n(F))$.
  Meanwhile, here we have only considered an inhomogeneous version of the AFL
  where the first component is $\mathbf{1}_{K'}$.
\end{remark}
\fi

\subsection{Roadmap}
The rest of the paper is organized as follows.

\subsubsection{Background information}
The paper begins with some general background information.
\begin{itemize}
  \ii In \Cref{ch:background} we provide some preliminary background
  on the spaces appearing in the overall paper and the Hecke algebras
  $\HH(\U(\VV_n^+))$ and $\HH(S_n(F))$.

  \ii Further background is stated in \Cref{ch:rs_matching},
  where we describe the matching of regular semisimple elements
  so that we may speak of $S_n(F)\rs^-$ and $(S_n(F) \times V'_n(F))\rs^-$.

  \ii In \Cref{ch:satake} we provide reminders on the Satake transform.
  \ifthesis
  We also derive concrete formulas for base change when $n = 3$
  (in comparison, the analogous results for $n=2$ are
  \cite[Lemma 7.1.1]{ref:AFLspherical});
  but these formulas are only used towards the end of \Cref{ch:ker} later.
  \fi
\end{itemize}

\subsubsection{Introduction and calculation of the orbital integrals}
\ifthesis
We then proceed to introduce the orbital integrals.
\begin{itemize}
  \ii In \Cref{ch:orbital0} we introduce the weighted orbital integral
  for the group version of the AFL for full spherical Hecke algebra,
  and state the parameters to be used for concrete calculation in \Cref{lem:S3_abcd}.
  In \Cref{ch:orbital1,ch:orbital2} we prove \Cref{thm:summary}
  by providing the full formulas
  \Cref{thm:full_orbital_ell_odd,thm:full_orbital_ell_even,thm:full_orbital_ell_neg}.

  \ii In \Cref{ch:orbitalFJ0} we introduce the weighted orbital integral
  for the semi-Lie version of the AFL for full spherical Hecke algebra,
  and state the parameters to be used in \Cref{lem:semi_lie_params}.
  The analogous calculation is in \Cref{ch:orbitalFJ1,ch:orbitalFJ2},
  which is used to prove \Cref{thm:semi_lie_formula} and its corollaries.
\end{itemize}
\fi
\ifpaper
In \Cref{ch:orbital0} we introduce the weighted orbital integral
for the group version of the AFL for full spherical Hecke algebra briefly.
This is only for comparison with the definition in later sections
and will not be used again afterwards.

In \Cref{ch:orbitalFJ0} we introduce the weighted orbital integral
for the semi-Lie version of the AFL for full spherical Hecke algebra,
and state the parameters to be used in \Cref{lem:semi_lie_params}.
The main calculation is carried out in \Cref{ch:orbitalFJ1,ch:orbitalFJ2},
which is used to prove \Cref{thm:semi_lie_formula} and its corollaries.
\fi

\subsubsection{Large kernel and image}
Having completely computed the orbital integrals in these cases,
we take a side trip in \Cref{ch:ker} to prove the large image results asserted.
We establish \Cref{conj:kernel_semi_lie} for $n = 2$ by proving the asserted
\Cref{thm:semi_lie_ker_trivial} and \Cref{thm:semi_lie_ker_huge}
for the orbital integral on $(S_2(F) \times V'_2(F))\rs^-$.
\ifthesis
We also prove \Cref{thm:no_kernel_group} for the orbital integral on $S_3(F)\rs^-$.
\fi

\subsubsection{Geometric side}
We then turn our attention to the other parts of the two versions of the AFL.
In addition to stating the relevant definitions,
the subsequent chapters aim to prove \Cref{thm:semi_lie_n_equals_2}.
\begin{itemize}
  \ii In \Cref{ch:transf} we briefly define the transfer factors $\omega \in \{\pm1\}$.
  \ii In \Cref{ch:geo}, we describe the Rapoport-Zink spaces $\RZ_n$
  that the geometric side is based on, and define the intersection numbers
  $\Int((1,g), \mathbf{1}_{K^\flat} \otimes f)$ and $\Int((g,u), f)$
  that appear in the two version of the generalized AFL.
  The main ingredients are the Hecke operator introduced in \cite{ref:AFLspherical}
  and the KR-divisor $\ZD(u)$ introduced in \cite{ref:KR}.
  \ii In \Cref{ch:jiao}, we specialize to the situation $n = 2$
  for the intersection numbers in the semi-Lie AFL only.
  The Rapoport-Zink space $\RZ_2$ become replaced with Lubin-Tate space $\MM_2$,
  and we introduce the Gross-Keating formula
  that will be our primary tool for the calculation.
\end{itemize}
Finally, in \Cref{ch:finale} we tie everything together and establish
\Cref{thm:semi_lie_n_equals_2}.

\ifthesis
An approximate dependency chart between the chapters is given in Figure~\ref{fig:depchart}.

\begin{figure}[ht]
  \begin{center}
    \begin{tikzcd}
      \text{\ref{ch:background}. Background} \ar[rd, bend left = 10] \ar[dddd, bend left = 80] && \\
      \text{\ref{ch:satake}. Base change} \ar[rdddd, bend left]
      & \text{\ref{ch:rs_matching}. Matching} \ar[ld] \ar[rd] \ar[l] \ar[r]
      &  \text{\ref{ch:transf}. Transfer} \ar[ldddd, bend right] \\
      \text{\ref{ch:orbital0}. Group orbital} \ar[r] \ar[d]
        & \text{\ref{ch:ker}. Large kernel} &
        \text{\ref{ch:orbitalFJ0}. Semi-Lie orbital} \ar[l] \ar[d] \ar[lddd, bend right = 20]  \\
      \text{\ref{ch:orbital1}+\ref{ch:orbital2}. Group orbital proof} &&
      \text{\ref{ch:orbitalFJ1}+\ref{ch:orbitalFJ2}. Semi-Lie orbital proof} \\
      \text{\ref{ch:geo}. Int numbers} \ar[d] && \\
      \text{\ref{ch:jiao}. Gross-Keating} \ar[r] & \text{\ref{ch:finale}. Prove \Cref{thm:semi_lie_n_equals_2}}
    \end{tikzcd}
  \end{center}
  \caption{Dependency chart of the chapters in this paper,
    arranged to loosely resemble the Batman logo.}
  \label{fig:depchart}
\end{figure}
\fi
