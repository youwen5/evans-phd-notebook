\section{General background}
\label{ch:background}

\subsection{Notation}
We provide a glossary of notation that will be used in this paper.
As mentioned in the introduction, $p > 2$ is a prime,
$F$ is a finite extension of $\QQ_p$,
and $E/F$ is an unramified quadratic field extension.

\begin{itemize}
  \ii For any $a \in E$, we let $\bar a$ denote the image of $a$
  under the nontrivial automorphism of $\Gal(E/F)$.
  (Hence $a = \bar a$ exactly when $a \in F$.)
  \ii Fix $\eps \in \OO_F^\times$ such that $E = F[\sqrt{\eps}]$.
  \ii Denote by $\varpi$ a uniformizer of $\OO_F$, such that $\bar \varpi = \varpi$.
  \ii Let $q \coloneqq |\OO_F/\varpi|$ be the residue characteristic.
  (Hence $|\OO_E / \varpi| = q^2$.)
  \ii Let $v$ be the associated valuation for $\varpi$.
  \ii Let $\eta$ be the quadratic character attached to $E/F$ by class field theory,
  so that $\eta(x) = -1^{v(x)}$.
  \ii $\VV_n^+$ denotes a split $E/F$-Hermitian space of dimension $n$ (unique up to isomorphism).
  \ii Let $\beta$ denote the $n \times n$ antidiagonal matrix
  \[ \beta \coloneqq \begin{pmatrix} && 1 \\ & \iddots \\ 1 \end{pmatrix} \]
  and pick the basis of $\VV_n^+$ such that the Hermitian form on $\VV_n^+$ is given by
  \[ \VV_n^+ \times \VV_n^+ \to E \qquad (x,y) \mapsto x^\ast \beta y. \]
  \ii Set
  \[ \U(\VV_n^+) = \{ g \in \GL_n(\OO_E) \mid g^\ast \beta g = \beta\} \]
  the unitary group over $\VV_n^+$.
  Note that $\beta$ is \emph{antidiagonal}, in contrast to the convention $\beta = \id_n$
  that is often used for unitary matrices with entries in $\CC$.
  The natural hyperspecial maximal compact subgroup
  is \[ \U(\VV_n^+) \cap \GL_n(\OO_E). \]
  In some parts of the paper we abbreviate $G = \U(\VV_n^+)$ and $K = \U(\VV_n^+) \cap \GL_n(\OO_E)$
  following the convention in \cite{ref:AFLspherical}.
  \ii Let $K' \coloneqq \GL_n(\OO_E)$ denote the hyperspecial maximal compact subgroup of $G' \coloneqq \GL_n(E)$.
  \ii Let $\VV_n^-$ denote the non-split $E/F$-Hermitian space of dimension $n$
  (unique up to isomorphism), and $\U(\VV_n^-)$ the corresponding unitary group.
  This space will be realized in \Cref{ch:geo}.
\end{itemize}

\subsection{Intersection of disks in an ultrametric space}
The following two lemmas will be useful for both versions of the orbital integral.
It is a slight rephrasing of \cite[Lemma 4.4]{ref:AFL}.

\begin{lemma}
  [One-disk volume lemma]
  \label{lem:volume}
  Let $\xi \in \OO_E^\times$, $\rho \in \ZZ$, and $n \ge \max(\rho, 1)$ an integer.
  Then
  \begin{align*}
    &\Vol\left( \left\{ x \in E \mid v(1-x \bar x) = n,
      \; v(x-\xi) \ge \rho \right\} \right) \\
    &=
    \begin{cases}
      0 & \text{if } v(1-\xi\bar\xi) < \rho \\
      q^{-n}(1-q^{-2}) & \text{if } \rho \le 0 \\
      q^{-(n+\rho)}(1-q\inv) & \text{if } v(1-\xi\bar\xi) \ge \rho \ge 1.
    \end{cases}
  \end{align*}
\end{lemma}
\begin{proof}
  When $\rho \le 0$, the condition $v(x - \xi) \ge \rho$ is vacuously true,
  so we just are computing
  \[ \Vol\left( \left\{ x \in E \mid v(1-x \bar x) = n \right\} \right). \]
  However, in general for any Schwartz function $\psi$ on $E$ we have an identity
  \begin{equation}
    \int_E \psi(x) \odif x
    = \frac{1}{1-q\inv} \int_{y \in F} \int_{t \in \OO_E^\times}
    \psi\left( x_t \cdot \frac{y}{\bar y} \right) \odif y \odif t
    \label{eq:schwartz}
  \end{equation}
  where $x_t$ is any choice of element $x_t \in E$ such that $t = x_t \bar{x_t}$
  (see the proof of \cite[Lemma 4.4]{ref:AFL}).
  Note the measures here are additive despite $t \in \OO_E^\times$.
  So if one selects
  \[ \psi(x) = \mathbf{1}_{v(1 - \Norm(x)) = n} \]
  then we get
  \begin{align*}
    \Vol\left( \left\{ x \in E \mid v(1-x \bar x) = n \right\} \right)
    &= \frac{1}{1-q\inv} \int_{t \in F} \int_{y \in \OO_E^\times}
    \mathbf{1}_{v\left( 1 - \Norm\left(x_t \cdot \frac{y}{\bar y} \right) \right) = n} \odif y \odif t \\
    &= \frac{1}{1-q\inv} \int_{t \in F} \int_{y \in \OO_E^\times}
    \mathbf{1}_{v\left( 1 - t \right) = n} \odif y \odif t \\
    &= \frac{\Vol_E(\OO_E^\times)}{1-q\inv} \cdot \Vol_F(1 + \varpi^{-n} \OO_F^\times) \\
    &= \frac{1 - \frac{1}{q^2}}{1-q\inv}
      \cdot \left( q^{-n} \cdot \left( 1 - \frac 1q \right) \right) \\
    &= q^{-n} (1-q^{-2}).
  \end{align*}
  The case $\rho > 0$ is proved in \cite[Lemma 4.4]{ref:AFL}
  using the same method of using \eqref{eq:schwartz}.
\end{proof}

We also comment on the well-known fact that in an ultrametric space,
any two disks are either disjoint or one is contained in the other.
See \Cref{fig:no_mastercard}.
\begin{lemma}
  [No ultrametric MasterCard logo]
  Choose $\xi_1, \xi_2 \in E$ and $\rho_1 \geq \rho_2$.
  Consider the two disks:
  \begin{align*}
    D_1 &= \left\{ x \in E \mid v(x-\xi_1) \ge \rho_1 \right\} \\
    D_2 &= \left\{ x \in E \mid v(x-\xi_2) \ge \rho_2 \right\}.
  \end{align*}
  Then, if $v(\xi_1-\xi_2) \geq \rho_2$, we have $D_1 \subseteq D_2$.
  If not, instead $D_1 \cap D_2 = \varnothing$.
  \label{lem:no_mastercard}
\end{lemma}
\begin{proof}
  Because $E$ is an ultrametric space and $\Vol(D_1) \leq \Vol(D_2)$,
  we either have $D_1 \subseteq D_2$ or $D_1 \cap D_2 = \varnothing$.
  The latter condition checks which case we are in by testing if $\xi_1 \in D_2$,
  since $\xi_1 \in D_1$.
\end{proof}

\begin{figure}
\centering
\begin{asy}
  defaultpen(fontsize(12pt));
  size(7cm);
  pair O1 = 0.57*dir(-30);
  pair O2 = (0,0);
  real r1 = 0.4;
  real r2 = 1;
  filldraw(circle(O2, r2), rgb(0.9, 0.9, 0.9));
  filldraw(circle(O1, r1), rgb(0.8, 0.8, 0.9));
  pair P1 = O1+r1*dir(230);
  pair P2 = O2+r2*dir( 70);
  draw(O1--P1);
  draw(O2--P2);
  dot("$\xi_1$", O1, dir(90));
  dot("$\xi_2$", O2, dir(180));
  label("$q^{-\rho_1}$", midpoint(O1--P1), dir(P1-O1)*dir(90));
  label("$q^{-\rho_2}$", midpoint(O2--P2), dir(P2-O2)*dir(90));
\end{asy}
\caption{Figure corresponding to \Cref{lem:no_mastercard}.}
\label{fig:no_mastercard}
\end{figure}

We package both of these results together in this lemma that will be used repeatedly.
\begin{lemma}
  [Two-disk volume lemma]
  \label{lem:quadruple_ineq}
  Let $\xi_1, \xi_2 \in \OO_E^\times$ and let $\rho_1 \ge \rho_2$ be integers.
  Also let $n \ge \max(\rho_1, 1)$ be an integer.
  Then the set of points $x \in E$ satisfying all of the equations
  \begin{align*}
    v(x - \xi_1) &\ge \rho_1 \\
    v(x - \xi_2) &\ge \rho_2 \\
    v(1 - x \ol x) &= n
  \end{align*}
  has positive volume if and only if
  \[ v(1 - \xi_1 \bar{\xi_1}) \ge \rho_1, \qquad \rho_2 \le v(\xi_1 - \xi_2). \]
  In that case, the volume is equal to
  \[
    \begin{cases}
      q^{-(n+\rho_1)}(1-q\inv) & \text{if } \rho_1 \ge 1 \\
      q^{-n}(1-q^{-2}) & \text{if } \rho_1 \le 0.
    \end{cases}
  \]
\end{lemma}
In the situation where $\xi_i \notin \OO_E^\times$,
the quantity $v(x-\xi_i) = \min(0, v(\xi_i))$
becomes independent of the value of $x$,
and so \Cref{lem:quadruple_ineq} becomes unnecessary
(\Cref{lem:volume} will suffice).
We will deal with this situation when it arises;
it turns out this will only occur when $v(b) \neq 0$.

\subsection{The spaces $S_n(F)$ and $S_n(F) \times V'_n(F)$}
For the analytic side of the two AFL conjectures we investigate,
the following two spaces will be used as inputs to our weighted orbital integrals.
\begin{definition}
  [$S_n(F)$; {\cite[(4.10)]{ref:survey}}]
  We define the symmetric space
  \[ S_n(F) \coloneqq \left\{ g \in \GL_n(E) \mid g \bar g = \id_n \right\}. \]
  It has a natural left action of $\GL_n(E)$ by
  \begin{align*}
    \GL_n(E) \times S_n(F) &\to S_n(F) \\
    g \cdot \gamma &\coloneqq g \gamma \bar g^{-1}.
  \end{align*}
\end{definition}

\begin{definition}
  [$V'_n(F)$; {\cite[(4.11)]{ref:survey}}]
  We set
  \[ V'_n(F) \coloneqq F^n \times (F^n)^\vee \]
  where $-^\vee$ denotes the $F$-dual space, i.e., $(F^n)^\vee = \Hom_F(F^n, F)$.
  Then we may also consider the augmented space
  \[ S_n(F) \times V'_n(F). \]
  If we identify $F^n$ with column vectors of length $n-1$ and $(F^n)^\vee$
  with row vectors of length $n$ then we have a left action of $\GL_n(F)$ by
  \begin{align*}
    \GL_n(F) \times (S_n(F) \times V'_n)(F)
    &\to S_n(F) \times V'_n(F) \\
    h \cdot (\gamma, \uu, \vv^\top)
    &\coloneqq (h \gamma h^{-1}, h\uu, \vv^\top h^{-1}).
  \end{align*}
  Note that according to the embedding
  \begin{align*}
    S_n(F) \times V'_n(F)
    &\hookrightarrow \Mat_{n+1}(E) \\
    (\gamma, \uu, \vv^\top)
    &\mapsto \begin{pmatrix} \gamma & \uu \\ \vv^\top & 0 \end{pmatrix}
  \end{align*}
  we can consider elements of $S_n(F) \times V'_n(F)$ as elements of $\Mat_{n+1}(E)$ too.
  In that case the action of $h \in \GL_{n+1}(F)$
  coincides with $h \cdot g \mapsto hg\bar{h}^{-1}$ as well.
\end{definition}

\begin{definition}
  [$K'_S$]
  For brevity, let
   \[ K'_S \coloneqq S_n(F) \cap \GL_n(\OO_F). \]
\end{definition}

\subsection{Definition of Hecke algebra}
We reminder the reader the definition of a Hecke algebra.
For this subsection, $G$ will denote \emph{any}
unimodular locally compact topological group,
and $K$ any closed subgroup of $G$.

\begin{definition}
  [$\HH(G,K)$]
  The \emph{Hecke algebra}
  \[ \HH(G, K) \coloneqq \QQ[K \backslash G \slash K] \]
  is defined as the space of compactly supported $K$-bi-invariant
  locally constant functions on $G$.
  (The adjective \emph{spherical} Hecke algebra refers to the special case
  where $K$ is a maximal compact subgroup of $G$,
  which is the main case of interest for us.)

  Given two such functions $f_1$ and $f_2$ in $\HH(G,K)$,
  one can consider define the convolution
  \[ (f_1 \ast f_2)(g) \coloneqq \int_G f_1(g\inv x) f_2(x) \; \odif x \]
  which makes $\HH(G, K)$ into a $\QQ$-algebra,
  whose identity element is $\mathbf{1}_K$.
\end{definition}

In other sources, this may be denoted $\HH_K(G)$ or even just $\HH_K$.
(So what is written in $\HH_{K'^\flat \otimes K'}$ in other places
will be written as $\HH(G'^\flat \otimes G', K'^\flat \otimes K')$ here).

In the case where $G$ is a reductive Lie group and
$K$ is the maximal compact subgroup
(or more generally whenever $(G,K)$ is a Gelfand pair),
this Hecke algebra is actually commutative.

\subsection{The specific Hecke algebras $\HH(\GL_n(E))$ and $\HH(\U(\VV_n^+))$ and the module $\HH(S_n(F))$}
For our purposes, we define shorthands for two specific Hecke algebras
that will come up consistently:
\begin{align*}
  \HH(\GL_n(E)) &\coloneqq \HH(\GL_n(E), \GL_n(\OO_E)) \\
  \HH(\U(\VV_n^+)) &\coloneqq \HH(\U(\VV_n^+), \U(\VV_n^+) \cap \GL_n(\OO_E)).
\end{align*}
Note that $\GL_n(\OO_E)$ and $\U(\VV_n^+) \cap \GL_n(\OO_E)$
are the natural hyperspecial maximal compact subgroups of $\GL_n(E)$ and $\U(\VV_n^+$),
respectively.

Now the symmetric space $S_n(F)$ is not a group,
so it does not make sense to define the same thing here.
Nevertheless, we introduce
\[ \HH(S_n(F)) \coloneqq \mathcal{C}_{\mathrm{c}}^{\infty}(S_n(F))^{K'} \]
as the set of smooth compactly supported functions on $S_n(F)$
which are invariant under the action of $K' \subseteq G'$;
this is an $\HH(\GL_n(E))$-module,
where the action of $f \in \HH(\GL_n(E))$ on $\phi \in \HH(S_n(F))$ is given by
\[ (f \cdot \phi)(\gamma) \coloneqq \int_G f(g) \phi(g \cdot \gamma) \odif g \]
for $\gamma \in S_n(F)$.
This does \textbf{not} have a multiplication structure at the moment, \emph{a priori}.
However, we will later (in \Cref{ch:satake}) give an isomorphism from $\HH(S_n(F))$
to $\HH(\U(\VV_n^+))$ as $\QQ$-vector spaces;
since the latter is a $\QQ$-algebra,
this induces a multiplication structure on $\HH(S_n(F))$
and consequently we may speak of $\HH(S_n(F))$ as a ring under this isomorphism.

Throughout this paper, to be consistent with the notation, we denote
\begin{itemize}
  \ii elements of $\HH(\U(\VV_n^+))$ using $f$ or $f_i$ or similar
    (i.e.\ lowercase Roman letters);
  \ii elements of $\HH(\GL_n(E))$ by $f'$ or $f'_i$ or similar
    (i.e.\ lowercase Roman letters with apostrophes);
  \ii elements of $\HH(S_n(F))$ by $\phi$ or $\phi_i$
    (i.e.\ lowercase Greek letters).
\end{itemize}
