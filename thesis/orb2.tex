\section{Evaluation of the weighted orbital integral for $S_3(F)$}
\label{ch:orbital2}

We now put together the sums we found in the previous section
to come up with the expression for the weighted orbital integral.
We continue to assume \Cref{lem:S3_abcd} and \Cref{lem:parameter_constraints}
in this chapter.

\subsection{Region where $n \leq 0$ for all values of $\ell$}
\begin{proposition}
  [$I_{n \le 0}$]
  \label{prop:O_zero}
  The contribution to the integral $\Orb(\gamma, \mathbf{1}_{K'_{S, \le r}}, s)$ over $n \leq 0$ is exactly
  \[ I_{n \le 0} \coloneqq q^{2(\delta+r)s} \sum_{j=0}^{\delta+2r} q^{-2js}
    = q^{-2rs} + \dots + q^{2(\delta+r)s}. \]
\end{proposition}
\begin{proof}
  For $n = 0$ we get a contribution of
  \begin{align*}
    &\phantom= \kappa \int_{t, t_1 \in E} \mathbf{1}[n=0] \mathbf{1}_{\le r}(\gamma,t,m)
      q^{2s \cdot m} q^{-2m} \odif t \odif t_1 \\
    &= \kappa \Vol(t: n =0) \sum_{m=-r}^{\delta+r} \Vol(t_1: -v(t_1)=m) q^{2m(s-1)} \\
    &= \kappa \left( 1 - \frac{q+1}{q^2} \right) \sum_{m=-r}^{\delta+r}
    \left( q^{2m} \left( 1-q^{-2} \right) \right) q^{2m(s-1)} \\
    &= \kappa \left( 1 - \frac{q+1}{q^2} \right) \left( 1-q^{-2} \right)
    \sum_{m=-r}^{\delta+r} q^{2ms}.
  \end{align*}
  For the region where $v(t) = -k < 0$, for each individual $k > 0$,
  \begin{align*}
    &\phantom= \kappa \int_{t, t_1 \in E} \mathbf{1}[v(t)=-k] \mathbf{1}_{\le r}(\gamma,t,m)
      q^{s(2m-n)} q^{2n-2m} \odif t \odif t_1 \\
    &= \kappa \Vol(t: v(t)=-k) \sum_{m=-r-k}^{\delta+r-k}
      \Vol(t_1: -v(t_1)=m) q^{s(2m+2k)-4k-2m} \\
    &= \kappa q^{2k} \left( 1 - q^{-2} \right) \sum_{m=-r-k}^{\delta+r-k}
      \left( q^{2m} \left( 1-q^{-2} \right) \right) q^{s(2m+2k)-4k-2m} \\
    &= \kappa q^{-2k} \left( 1 - q^{-2} \right)^2
      \sum_{m=-r-k}^{\delta+r-k} q^{2(m+k)s} \\
    &= \kappa q^{-2k} \left( 1 - q^{-2} \right)^2 \sum_{i=-r}^{\delta+r} q^{2is}.
  \end{align*}
  Since $\sum_{k > 0} q^{-2k} = \frac{q^{-2}}{1-q^{-2}}$,
  we find that the total contribution across both
  the $n=0$ case and the $k > 0$ case is
  \begin{align*}
    &\phantom= \left( \left( 1 - \frac{q+1}{q^2} \right) \left( 1-q^{-2} \right)
      + q^{-2}(1-q^{-2})  \right) \kappa \sum_{i=-r}^{\delta+r} q^{2is} \\
    &= \left( 1-q\inv \right) \left(1-q^{-2} \right)
      \kappa \sum_{i=-r}^{\delta+r} q^{2is} \\
    &= \sum_{i=-r}^{\delta+r} q^{2is}.
  \end{align*}
  This equals the claimed sum above.
  (We write it over $0 \le j \le \delta+2r$ for consistency with a later part.)
\end{proof}

\subsection{Contribution from Case 1 and Case 2 assuming $v(b) \ge 0$ and $v(d) \ge 0$}
Again using $\Vol(t_1:-v(t_1)=m) = q^{2m} (1-q^{-2})$,
summing all the cases gives the following contribution within
$\kappa \int_{t, t_1 \in E} \mathbf{1}[n > 0] \mathbf{1}_{\le r}(\gamma,t,m)$:
\begin{align*}
  I_{n > 0}^{\text{1+2}}
  % -----------------------------------------------------------
  &\coloneqq \kappa \sum_{n=1}^{r}
    \sum_{m=n-r}^{\left\lceil \frac{n-r}{2} \right\rceil+\delta+r-1}
    q^{-n} \left( 1 - q^{-2} \right) \\
    &\qquad\qquad\cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &\qquad+ \kappa \sum_{n=r+1}^{\ell+r}
    \sum_{m=n-r}^{\left\lceil \frac{n-r}{2} \right\rceil+\delta+r-1}
    q^{-n - \left\lceil \frac{n-r}{2} \right\rceil} \left( 1 - q\inv \right) \\
    &\qquad\qquad\cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &\qquad+ \kappa \sum_{n=1}^{r}
    \sum_{m=\max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r\right)}^{\delta+r}
    q^{-n} \left( 1 - q^{-2} \right) \\
    &\qquad\qquad\cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
    \\
  &\qquad+ \kappa \sum_{n=1}^{\ell+r}
    \sum_{m=\max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r, \delta+r+1 \right)}^{\min(n,\lambda)+\delta+r}
    q^{-n - (m-\delta-r)} \left( 1 - q\inv \right) \\
    &\qquad\qquad\cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big)
    \\
  % -----------------------------------------------------------
  &= \sum_{n=1}^{r}
    \sum_{m=n-r}^{\left\lceil \frac{n-r}{2} \right\rceil+\delta+r-1}
    q^{n} \left( 1 + q\inv \right)
      \cdot (-1)^n q^{s(2m-n)} \\
  &\qquad+ \sum_{n=r+1}^{\ell+r}
    \sum_{m=n-r}^{\left\lceil \frac{n-r}{2} \right\rceil+\delta+r-1}
    q^{\left\lfloor \frac{n+r}{2} \right\rfloor}
      \cdot (-1)^n q^{s(2m-n)} \\
  &\qquad+ \sum_{n=1}^{r}
    \sum_{m=\max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r\right)}^{\delta+r}
    q^{n} \left( 1 + q\inv \right)
      \cdot (-1)^n q^{s(2m-n)} \\
  &\qquad+ \sum_{n=1}^{\ell+r}
    \sum_{m=\max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r, \delta+r+1 \right)}^{\min(n,\lambda)+\delta+r}
    q^{n - (m-\delta-r)}
      \cdot (-1)^n q^{s(2m-n)}.
\end{align*}
To simplify the expressions, we replace the summation variable $m$ with
\[ j \coloneqq (n + \delta + r) - m \geq 0. \]
In that case,
\[ 2m-n = 2(\delta+n+r-j)-n = n + 2\delta + 2r - 2j. \]
Then the expression rewrites as
\begin{align*}
  I_{n > 0}^{\text{1+2}}
  % -----------------------------------------------------------
  &= \sum_{n=1}^{r}
    \sum_{j = \left\lfloor \frac{n+r}{2} \right\rfloor+ 1}^{\delta + 2r}
    q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{n=r+1}^{\ell+r}
    \sum_{j = \left\lfloor \frac{n+r}{2} \right\rfloor+ 1}^{\delta + 2r}
    q^{\left\lfloor \frac{n+r}{2} \right\rfloor} \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{n=1}^{r}
    \sum_{j=n}^{\min\left( \delta+2r, \left\lfloor \frac{n+r}{2} \right\rfloor \right)}
    q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{n=1}^{\ell+r}
    \sum_{j=\max(0,n-\lambda)}^{\min(\delta+2r, \left\lfloor \frac{n+r}{2} \right\rfloor, n-1)}
    q^{j} \cdot (-1)^n q^{s(n+2\delta+2r-2j)}.
\end{align*}

We interchange the order of summation so that it is first over $j$ and then $n$.
There are four double sums to interchange.

\begin{itemize}
  \ii The first double sum runs from $j=\left\lfloor \frac{r+1}{2} \right\rfloor+1$ to $j=\delta+2r$.
  In addition to $1 \le n \le r$,
  we need $\left\lfloor \frac{n+r}{2} \right\rfloor + 1 \leq j$,
  which solves to $\frac{n+r}{2} \leq j-\half$ or $n \leq 2j-1-r$.
  Thus the condition on $n$ is
  \[ 1 \leq n \leq \min(2j-1-r, r). \]

  \ii The second double sum runs from $j=r+1$ to $\delta+2r$.
  We also need $r+1 \le n \le \ell+r$ and $n \le 2j-1-r$.
  Hence, the desired condition on $n$ is
  \[ r+1 \leq n \leq \min(2j-1-r, \ell+r). \]

  \ii The third double sum runs from $j=1$ to $j=r$.
  Meanwhile, the values of $n$ need to satisfy $1 \le n \le r$, $n \leq j$
  and $j \leq \left\lfloor \frac{n+r}{2} \right\rfloor \implies n \geq 2j-r$,
  consequently we just obtain
  \[ \max(1, 2j-r) \leq n \leq j. \]

  \ii The fourth double sum runs $j=0$ to
  \[ j=\min\left( \delta+2r, \left\lfloor \frac{\ell}{2} \right\rfloor + r, \ell+r-1 \right)
    = \left\lfloor \frac{\ell}{2} \right\rfloor + r - \mathbf{1}[\ell = 0] \]
  again because of $\ell < 2\delta$.
  Meanwhile, we require $1 \le n \le \ell+r$, $j \ge n-\lambda$, $j \le n-1$,
  as well as $j \le \left\lfloor \frac{n+r}{2} \right\rfloor
  \iff n \ge 2j-r$.
  Putting these four conditions together gives
  \[ \max(j+1, 2j-r) \le n \le \min(j+\lambda, \ell+r). \]
\end{itemize}
Hence we get
\begin{align*}
  I_{n > 0}^{\text{1+2}}
  &= \sum_{j = \left\lfloor \frac{r+1}{2} \right\rfloor+ 1}^{\delta+2r}
    \sum_{n=1}^{\min(2j-1-r, r)}
    q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{j = r+1}^{\delta + 2r}
    \sum_{n=r+1}^{\min(2j-1-r, \ell+r)}
    q^{\left\lfloor \frac{n+r}{2} \right\rfloor} \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{j=1}^{r}
    \sum_{n=\max(1,2j-r)}^{j}
    q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{j=0}^{\left\lfloor \frac{\ell}{2} \right\rfloor + r - \mathbf{1}[\ell = 0]}
    \sum_{n=\max(j+1, 2j-r)}^{\min(j+\lambda, \ell+r)}
    q^{j} \cdot (-1)^n q^{s(n+2\delta+2r-2j)}.
\end{align*}

At this point, we can unify the sum over $j$ by noting that for $j$ outside of the
summation range, the inner sum is empty anyway.
Specifically, note that:
\begin{itemize}
  \ii In the first and second double sum,
  the inner sum over $n$ is empty anyway when $j < r$.
  \ii In the third double sum, adding $j=0$ does not introduce new terms.
  Moreover, when $j > r$ the inner sum over $n$ is also empty anyway.
  \ii In the fourth double sum,
  \begin{itemize}
    \ii If $\ell = 0$ and $j \ge r$, then $j+1 \ge 0+r$; and
    \ii If $\ell > 0$ and $j > \frac{\ell}{2} + r$, then $2j-r \ge \ell+r$.
  \end{itemize}
  So no new terms are introduced in this case either.
\end{itemize}
So we can unify all four double sums to run over $0 \le j \le \delta + 2r$,
simplifying the expression to just

\begin{align*}
  I_{n > 0}^{\text{1+2}}
  = q^{2(\delta+r)s}
  \sum_{j = 0}^{\delta + 2r} \Bigg(
    & \sum_{n=1}^{\min(2j-1-r, r)}
      q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n-2j)} \\
    & + \sum_{n=r+1}^{\min(2j-1-r, \ell+r)}
      q^{\left\lfloor \frac{n+r}{2} \right\rfloor} \cdot (-1)^n q^{s(n-2j)} \\
    &+ \sum_{n=\max(1,2j-r)}^{j}
      q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n-2j)} \\
    &+ \sum_{n=\max(j+1, 2j-r)}^{\min(j+\lambda, \ell+r)} q^{j} \cdot (-1)^n q^{s(n-2j)} \Bigg).
\end{align*}

\subsection{Merging of $I_{n \le 0}$ with $I_{n > 0}^{\text{1+2}}$ (and proof of \Cref{thm:full_orbital_ell_odd})}
We continue assuming $v(b) = v(d) = 0$.
It turns out that $I_{n \le 0} + I_{n > 0}^{\text{1+2}}$ can be rewritten more compactly
(giving a simple answer especially when $\ell$ is odd).
Then
\[
  I_{n \le 0} + I_{n > 0}^{\text{1+2}}
\]
can be rewritten to the collation
\begin{align*}
  = q^{2(\delta+r)s}
  \sum_{j = 0}^{\delta + 2r} \Bigg(
    q^{-2js}
    &+ \sum_{n=1}^{\min(2j-1-r, r)}
      q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n-2j)} \\
    &+ \sum_{n=r+1}^{\min(2j-1-r, \ell+r)}
      q^{\left\lfloor \frac{n+r}{2} \right\rfloor} \cdot (-1)^n q^{s(n-2j)} \\
    &+ \sum_{n=\max(1,2j-r)}^{j}
      q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n-2j)} \\
    &+ \sum_{n=\max(j+1, 2j-r)}^{\min(j+\lambda, \ell+r)} q^{j} \cdot (-1)^n q^{s(n-2j)} \Bigg).
\end{align*}
Note that when $r=0$ and $\ell = \lambda \equiv 1 \pmod 2$
we recover \cite[Equation (4.13)]{ref:AFL}.

The above expression can be considered as a Laurent polynomial in $-q^s$,
whose coefficients are nonnegative polynomials in $q$ (note that $(-1)^n = (-1)^{n-2j}$).
Now we are going to extract the coefficient of $(-q^s)^k$, for each integer $k$.
First, note that
\begin{itemize}
  \ii The initial term before the sums adds $1$
  if $k$ is even and $-2r \le k \le 2\delta + 2r$, and $0$ otherwise.
\end{itemize}
We move on to the inner sums and calculate their contributions.
For a fixed $k \in \ZZ$, we want to consider $(n,j)$ with $n-2j + 2(\delta+r) = k$,
that is, $2j = n + 2\delta + 2r - k$, or $n = 2j + k - 2\delta - 2r$.
The condition that $j \in \ZZ$ and $0 \le j \le \delta+2r$ is then equivalent to
\begin{equation}
  k-2\delta-2r \le n \le k+2r \qquad\text{and}\qquad n \equiv k \pmod 2.
  \label{eq:outer_assumption}
\end{equation}
We note also that
\begin{equation}
  n < 2j-r \iff n < n + 2 \delta + r - k \iff k < 2\delta + r
  \label{eq:outer_half_assumption_12}
\end{equation}
which needs to hold for the first two sums to contribute.
Conversely, in the latter two sums, we will assume that
\begin{equation}
  n \ge 2j-r \iff k \ge 2\delta + r.
  \label{eq:outer_half_assumption_34}
\end{equation}
Now we are ready for the main calculation.
In what follows $i \% 2 \in \{0,1\}$ means the remainder when $i$ is divided by $2$.
Moreover, any ellipses of the form
\[ q^i + \dots + q^{i'} \]
will be an abbreviation for $q^i + q^{i-1} + \dots + q^{i'}$
(i.e.\ within any ellipses, the exponents are understood to decrease by $1$,
and the sums are always nonempty, meaning $i \ge i'$).

In the region where $k < 2\delta + r$, the first two sums contribute:
\begin{itemize}
  \ii The first sum contributes if and only if \eqref{eq:outer_assumption} holds,
  $1 \le n \le r$ and \eqref{eq:outer_half_assumption_12} is true.
  Hence, the contribution only occurs when $k < 2\delta + r$.
  In that case, all $1 \le n \le \min(r,k+2r)$ with $n \equiv k \pmod 2$ appear.
  Since the contribution of a given $n$ is $q^n + q^{n-1}$
  and the $n$ are incrementing by $2$, our final total is
  \[
    \begin{cases}
      q^{k+2r} + \dots + q^{(k-1)\%2} & \text{if } -2r < k \leq -r \\
      q^{r-(k-r)\%2} + \dots + q^{(k-1)\%2} & \text{if } -r \le k < 2\delta + r \\
      0 & \text{otherwise}.
    \end{cases}
  \]

  \ii The second sum contributes if and only if \eqref{eq:outer_assumption} holds,
  \eqref{eq:outer_half_assumption_12} holds and $r+1 \le n \le \ell + r$.
  The hypothesis $n > r$ means we need $k \geq -r$.
  Since $\ell < 2\delta$, the upper bound for $n$ is $n \le \min(\ell+r, k+2r)$
  which we split into two cases.

  In the case where $k+2r \le \ell+r$, then since $\ell < 2\delta$,
  the inequality $k < 2\delta + r$ holds automatically.
  We have the largest term $n=k+2r \equiv k \pmod 2$,
  so the largest exponent $q$ that appears is
  $\left\lfloor \frac{(k+2r)+r}{2} \right\rfloor$.

  In the other case $\ell+r \le k+2r$,
  we obtain largest exponents of
  \[ \left\lfloor \frac{(\ell+r-(\ell+r-k)\%2) + r}{2} \right\rfloor
    = r + \left\lfloor \frac{\ell-(\ell+r-k)\%2}{2} \right\rfloor.
  \]
  Thus, we obtain
  \[
    \begin{cases}
      q^{\left\lfloor \frac{k+3r}{2} \right\rfloor} + \dots + q^{r+(r+1-k)\%2}
        & \text{if } -r \le k \le \ell - r \\
      q^{r + \left\lfloor \frac{\ell-(\ell+r-k)\%2}{2} \right\rfloor}
        + \dots + q^{r + (r+1-k)\%2}
        & \text{if } \ell - r \leq k < 2\delta + r \\
      0 & \text{otherwise}.
    \end{cases}
  \]
\end{itemize}

In the region where $k \ge 2\delta + r$, the latter two sums are in play:
\begin{itemize}
  \ii In the third sum, we assume \eqref{eq:outer_half_assumption_34};
  then the other constraints on $n$ are
  \begin{align*}
    n &\ge 1 \\
    n \le j \iff 2n \le n+2\delta+2r-k \iff n &\le 2\delta + 2r - k
  \end{align*}
  which implies $k < 2 \delta + 2r$ for this range to be nonempty.
  In this case, \eqref{eq:outer_assumption} is actually redundant already.
  That means our contribution can be described as
  \[
    \begin{cases}
      q^{2\delta+2r-k} + \dots + q^{(k-1)\%2} & \text{if } 2\delta+r \le k < 2\delta+2r \\
      0 & \text{otherwise}.
    \end{cases}
  \]
  \ii Unlike the other sums, the $j$ is in the exponent in the fourth sum,
  so \eqref{eq:outer_assumption} will not be useful to us.
  Instead our goal is to detect the values of $j$ for which the corresponding value of
  \[ n = 2j-2\delta-2r+k \]
  lies in the desired interval.
  That is, we get a contribution of $q^j$ if and only if
  \eqref{eq:outer_half_assumption_34} holds and
  \begin{align*}
    &\phantom{\iff} 0 \le j \le \delta + 2r \\
    j < 2j-2\delta-2r+k &\implies 2\delta+2r-k < j \\
    2j-2\delta-2r+k \le j+\lambda &\iff j \le 2\delta+2r+\lambda-k \\
    2j-2\delta-2r+k \le \ell+r &\iff j \le \delta+\frac{3r+\ell-k}{2}
  \end{align*}
  The values of $k$ for which there is any valid index $j$ is given by
  \[ 2\delta + r \le k \le 2 \delta + \min \left( \lambda + 2r, \ell + 3r \right). \]
  The breakpoint for the two upper bounds on $j$ occurs when
  \[ 2\delta+2r-k+\lambda \le \delta+\frac{3r+\ell-k}{2}
    \iff k \ge 2\delta + 2\lambda - \ell + r. \]

  Comparing all the bounds, we find there are three possible scenarios.
  \begin{itemize}
    \ii If $\lambda \le \frac{\ell+r}{2}$, then we get
    \[
      \begin{cases}
        q^{\delta+\left\lfloor\frac{3r+\ell-k}{2}\right\rfloor} + \dots + q^{2\delta+2r-k+1}
          & \text{if } 2\delta+r \le k \le 2\delta+2r  \\
        q^{\delta+\left\lfloor\frac{3r+\ell-k}{2}\right\rfloor} + \dots + q^{0}
          & \text{if } 2\delta+2r < k \le 2\delta+2\lambda-\ell+r  \\
        q^{2\delta+2r+\lambda-k} + \dots + q^0
          & \text{if } 2\delta+2\lambda-\ell+r \le k \le 2\delta+\lambda+2r \\
        0 & \text{otherwise}.
      \end{cases}
    \]

    \ii If $\frac{\ell+r}{2} < \lambda \le \ell + r$, then we get
    \[
      \begin{cases}
        q^{\delta+\left\lfloor\frac{3r+\ell-k}{2}\right\rfloor} + \dots + q^{2\delta+2r-k+1}
          & \text{if } 2\delta+r \le k \le 2\delta+2\lambda-\ell+r  \\
        q^{\delta+\left\lfloor\frac{3r+\ell-k}{2}\right\rfloor} + \dots + q^{2\delta+2r-k+1}
          & \text{if } 2\delta+2\lambda-\ell+r \le k \le 2\delta+2r  \\
        q^{2\delta+2r+\lambda-k} + \dots + q^0
          & \text{if } 2\delta+2r < k \le 2\delta+\lambda+2r \\
        0 & \text{otherwise}.
      \end{cases}
    \]

    \ii If $\ell+r < \lambda$, then we get
    \[
      \begin{cases}
        q^{\delta+\left\lfloor\frac{3r+\ell-k}{2}\right\rfloor} + \dots + q^{2\delta+2r-k+1}
          & \text{if } 2\delta+r \le k \le 2\delta+2r \\
        q^{\delta+\left\lfloor\frac{3r+\ell-k}{2}\right\rfloor} + \dots + q^{0}
          & \text{if } 2\delta+2r < k \le 2\delta+\ell+3r \\
        0 & \text{otherwise}.
      \end{cases}
    \]
  \end{itemize}
\end{itemize}
This completes the analysis of the four sums above.
For later purposes, it will be more symmetric to rewrite the exponent as
\[ \delta + \left\lfloor \frac{3r+\ell-k}{2} \right\rfloor
  = r + \left\lfloor \frac{(2\delta+\ell+r)-k}{2} \right\rfloor. \]

Now we can piece together all the parts below.
It turns out that for every value of $k$,
the coefficient of $(-q^s)^k$ is an expression
of the form $1 + q + q^2 + \dots + q^{\nn_\gamma(k)}$ for some $k$.
Indeed,
\begin{itemize}
  \ii When $k = -2r$ the only term is $q^0$.
  \ii For $-2r < k < r$, only the first sum contributes
  $q^{k+2r} + \dots + q^{(k-1)\%2}$,
  which is then completed by the $q^0$ contribution from $I_{n \le 0}$ when $k$ is even
  with a possible $q^0$.
  \ii For $-r \le k < 2\delta+r$,
  the first and second sum actually fit together with a ``seam'' near $q^r$,
  which is for even $k$ then completed by
  the single $q^0$ contribution from $I_{n \le 0}$ (only when $k$ is even).
  \ii For $2\delta+r \le k \le 2\delta+2r$,
  the same holds with piecing the third and fourth sum together
  (where the seam is near $q^k$ this time).
  \ii Finally, only the fourth sum contributes for $k \ge 2\delta+2r$,
  and it is of the desired form.
\end{itemize}
This gives us a succinct description of the weighted orbital integral.

If $\ell$ is even, we now have the following intermediate result.
\begin{proposition}
  [Case 1 and 2 for $\ell \ge 0$ even]
  \label{prop:ell_even_half}
  Suppose $\ell \ge 0$ is even.
  Then we have the intermediate result
  \[
    I_{n \le 0} + I_{n > 0}^{\text{1+2}}
    = \sum_{k = -2r}^{2\delta + \min(\lambda+2r, \ell+3r)}
    (-1)^k \left( 1 + q + q^2 + \dots + q^{\nn^{1+2}_{\gamma}(k)}  \right) (q^s)^k
  \]
  where the piecewise function $\nn_\gamma \colon \ZZ \to \ZZ_{\ge 0}$ is defined by
  \[
    \nn^{1+2}_\gamma(k) =
    \begin{cases}
      k + 2r & \text{if } {-2r} \le k \le -r \\
      \left\lfloor \frac{k+r}{2} \right\rfloor + r & \text{if }{-r} \le k \le \ell-r \\
      \frac{\ell}{2} + r - (k-r)\%2 & \text{if } \ell - r \le k \le 2\delta + r \\
      \left\lfloor \frac{(\ell+2\delta+r)-k}{2} \right\rfloor + r & \text{if } 2\delta + r \le k \le \ell + 2\delta + 3r
    \end{cases}
  \]
  in the case $\lambda \ge \ell+r$, and
  \[
    \nn^{1+2}_\gamma(k) =
    \begin{cases}
      k + 2r & \text{if } {-2r} \le k \le -r \\
      \left\lfloor \frac{k+r}{2} \right\rfloor + r & \text{if }{-r} \le k \le \ell-r \\
      \frac{\ell}{2} + r - (k-r) \% 2 & \text{if } \ell - r \le k \le 2\delta + r \\
      \left\lfloor \frac{(\ell+2\delta+r)-k}{2} \right\rfloor + r & \text{if } 2\delta + r \le k \le 2\lambda - \ell + 2\delta + r \\
      (\lambda + 2\delta + 2r) - k & \text{if } 2 \delta + 2 \lambda - \ell + r \le k \le \lambda + 2\delta + 2r
    \end{cases}
  \]
  in the case $\lambda \le \ell+r$.
\end{proposition}

On the other hand, when $\ell$ is odd, we get \Cref{thm:full_orbital_ell_odd}:
\ellodd*

\subsection{Contribution from Case 3\ts{+}, 3\ts{-}, 4\ts{+} assuming $v(b) \ge 0$ and $v(d) \ge 0$}
These cases only appear when $\ell$ is even and we assume this for this subsection.
We consider the contribution of these cases within
$\kappa \int_{t, t_1 \in E} \mathbf{1}[n > 0] \mathbf{1}_{\le r}(\gamma,t,m)$
(using \eqref{eq:even_case3_plus}, \eqref{eq:even_case3_minus}, \eqref{eq:even_case4_plus})
and put $\Vol(t_1:-v(t_1)=m) = q^{2m} (1-q^{-2})$ to get:
\begin{align*}
  I_{n > 0}^{\text{3+4}}
  % -----------------------------------------------------------
  &\coloneqq \kappa \sum_{n=\ell+r+1}^{\lambda-\frac{\ell}{2}+\delta+r}
    \sum_{m=n-r}^{\min(n-1, \lambda+r)-\frac{\ell}{2}+\delta}
    q^{-n-(n-\frac{\ell}{2}-r)} \left( 1 - q^{-1} \right) \\
    &\qquad\qquad\cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &\qquad+ \kappa \sum_{n=\ell+r+1}^{\frac{\ell}{2}+\delta+r}
    \sum_{m=n-r}^{\frac{\ell}{2}+\delta+r}
    q^{-n-(n-\frac{\ell}{2}-r)} \left( 1 - q^{-1} \right) \\
  &\qquad\qquad\cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &\qquad+ \kappa \sum_{n=\ell+r+1}^{\lambda+r}
    \sum_{m=n-\frac{\ell}{2}+\delta}^{\min(n,\lambda)+\delta+r}
    q^{-n-(m-\delta-r)} \left( 1 - q^{-1} \right) \\
    &\qquad\qquad\cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &= \sum_{n=\ell+r+1}^{\lambda-\frac{\ell}{2}+\delta+r}
    \sum_{m=n-r}^{\min(n-1, \lambda+r)-\frac{\ell}{2}+\delta}
    q^{-n-(n-\frac{\ell}{2}-r)}
      \cdot \Big( (-1)^n q^{s(2m-n)} q^{2n} \Big) \\
  &\qquad+ \sum_{n=\ell+r+1}^{\frac{\ell}{2}+\delta+r}
    \sum_{m=n-r}^{\frac{\ell}{2}+\delta+r}
    q^{-n-(n-\frac{\ell}{2}-r)}
      \cdot \Big( (-1)^n q^{s(2m-n)} q^{2n} \Big) \\
  &\qquad+ \sum_{n=\ell+r+1}^{\lambda+r}
    \sum_{m=n-\frac{\ell}{2}+\delta}^{\min(n,\lambda)+\delta+r}
    q^{-n-(m-\delta-r)}
      \cdot \Big( (-1)^n q^{s(2m-n)} q^{2n} \Big) \\
  &= \sum_{n=\ell+r+1}^{\lambda-\frac{\ell}{2}+\delta+r}
    \sum_{m=n-r}^{\min(n-1, \lambda+r)-\frac{\ell}{2}+\delta}
    q^{\frac{\ell}{2}+r} \cdot (-1)^n q^{s(2m-n)} \\
  &\qquad+ \sum_{n=\ell+r+1}^{\frac{\ell}{2}+\delta+r}
    \sum_{m=n-r}^{\frac{\ell}{2}+\delta+r}
    q^{\frac{\ell}{2}+r} \cdot (-1)^n q^{s(2m-n)} \\
  &\qquad+ \sum_{n=\ell+r+1}^{\lambda+r}
    \sum_{m=n-\frac{\ell}{2}+\delta}^{\min(n,\lambda)+\delta+r}
    q^{n-m+\delta+r} \cdot (-1)^n q^{s(2m-n)} \\
  &= q^{\frac{\ell}{2}+r} \cdot \sum_{n=\ell+r+1}^{\lambda+r}
    \sum_{m=n-r}^{n-1-\frac{\ell}{2}+\delta}
    (-1)^n q^{s(2m-n)} \\
  &\qquad+ q^{\frac{\ell}{2}+r} \cdot \sum_{n=\lambda+r+1}^{\lambda-\frac{\ell}{2}+\delta+r}
    \sum_{m=n-r}^{\lambda-\frac{\ell}{2}+\delta+r}
    (-1)^n q^{s(2m-n)} \\
  &\qquad+ q^{\frac{\ell}{2}+r} \cdot \sum_{n=\ell+r+1}^{\frac{\ell}{2}+\delta+r}
    \sum_{m=n-r}^{\frac{\ell}{2}+\delta+r}
    (-1)^n q^{s(2m-n)} \\
  &\qquad+ \sum_{n=\ell+r+1}^{\lambda+r}
    \sum_{m=n-\frac{\ell}{2}+\delta}^{\min(n,\lambda)+\delta+r}
    q^{n-m+\delta+r} \cdot (-1)^n q^{s(2m-n)};
\end{align*}
We now analyze each double sum.

\subsubsection{Analysis of the coefficient of the top-degree term $q^{\frac{\ell}{2}+r}$}
We start by analyzing just the first three double sums:
Fix an index $k$; we collect the coefficient of $(-q^s)^k$.
\begin{itemize}
  \ii For the first double sum, change the summation for $m$ to
  \[ m = n-r + j \iff j = m - n + r \]
  so that $2m - n = n - 2r + 2j$
  and the first double sum rewrites as
  \begin{align*}
    \sum_{n=\ell+r+1}^{\lambda+r} \sum_{m=n-r}^{n-\frac{\ell}{2}+\delta-1} (-q^s)^{2m-n}
    &= \sum_{n=\ell+r+1}^{\lambda+r}
      \sum_{j=0}^{r-\frac{\ell}{2}+\delta-1} (-q^s)^{n-2r+2j} \\
    &= \sum_{j=0}^{r-\frac{\ell}{2}+\delta-1} \sum_{n=\ell+r+1}^{\lambda+r}
      (-q^s)^{n-2r+2j} \\
    &= \sum_{j=0}^{r-\frac{\ell}{2}+\delta-1}
    \sum_{k=\ell-r+2j+1}^{\lambda-r+2j} (-q^s)^k
  \end{align*}
  Now we collect the coefficient of $(-q^s)^k$.
  The value of $k$ runs from the lowest value $k = \ell-r+1$
  to the highest value $k = \lambda - \ell + 2 \delta + r - 2$.
  We seek the number of $0 \le j \le r-\frac{\ell}{2}+\delta-1$ such that
  \[ \ell - r + 2j + 1 \le k \le \lambda - r + 2j
    \iff \frac{k + r - \lambda}{2} \le j \le \frac{k + r - (\ell + 1)}{2} \]
  so the number of terms that appear is
  \[
    \min\left( \left\lfloor \frac{k -\ell + r - 1}{2} \right\rfloor, - \frac{\ell}{2} + \delta + r - 1 \right)
    - \max\left( \left\lceil \frac{k + r -\lambda}{2} \right\rceil, 0 \right)
    + 1
  \]
  which is nonnegative (but could be zero).
  We add in one more term $k = \lambda - \ell + 2 \delta + r - 1$
  and $k = \lambda - \ell + 2 \delta + r$ for simplicity;
  this is okay because the above display equals zero at this value anyway.
  \ii For the second double sum, change the order of summation to
  \begin{align*}
    \sum_{n=\lambda+r+1}^{\lambda-\frac{\ell}{2}+\delta+r}
      \sum_{m=n-r}^{\lambda-\frac{\ell}{2}+\delta+r} (-q^s)^{2m-n}
    &= \sum_{m=\lambda+1}^{\lambda-\frac{\ell}{2}+\delta+r}
      \sum_{n=\lambda+r+1}^{\min\left( \lambda-\frac{\ell}{2}+\delta+r, m+r \right)} (-q^s)^{2m-n} \\
    &= \sum_{m=\lambda+1}^{\lambda-\frac{\ell}{2}+\delta+r}
      \sum_{k=\max\left( m-r, 2m-\lambda+\frac{\ell}{2}-\delta-r \right)}^{2m-\lambda-r-1} (-q^s)^k.
  \end{align*}
  Now we collect the coefficient of $(-q^s)^k$.
  The value of $k$ runs from the lowest value $k = \lambda - r + 1$
  to the highest value $k = \lambda-\ell+2\delta+r-1$.
  For $k$ in this interval, we seek values of $\lambda + 1 \le m \le \lambda - \frac{\ell}{2} + \delta + r$
  and
  \begin{align*}
    k \le 2m-\lambda-r-1 &\implies m \ge \frac{k+\lambda+r+1}{2} \\
    k \ge m-r &\implies m \le k + r \\
    k \ge 2m - \lambda + \frac{\ell}{2} - \delta - r
    &\implies m \le \frac{k + \lambda - \frac{\ell}{2} + \delta + r}{2}.
  \end{align*}
  When $k \ge \lambda - r + 1$ we already have $\frac{k + \lambda + r + 1}{2} \ge \lambda + 1$,
  so the number of terms that appear is
  \[ \min\left(k+r,
    \left\lfloor \frac{k + \lambda - \frac{\ell}{2} + \delta + r}{2} \right\rfloor,
    \lambda - \frac{\ell}{2} + \delta + r \right)
    - \left\lceil \frac{k+\lambda+r+1}{2} \right\rceil + 1 \]
  which is nonnegative (but could be zero).
  We add in two extra term at $k = \lambda - r$ and $k = \lambda - \ell + 2 \delta + r$;
  for simplicity; this is okay because the above display equals zero at this value anyway.
  \ii The third double sum
  \[
    \sum_{n=\ell+r+1}^{\frac{\ell}{2}+\delta+r}
      \sum_{m=n-r}^{\frac{\ell}{2}+\delta+r} (-q^s)^{2m-n}
  \]
  happens to coincide with the previous one if one replaces $\lambda$ by $\ell$ everywhere.
  Hence the number of terms that appear is
  \[ \min\left(k+r,
    \left\lfloor \frac{k + \frac{\ell}{2} + \delta + r}{2} \right\rfloor,
    + \frac{\ell}{2} + \delta + r \right)
    - \left\lceil \frac{k+\frac{\ell}{2}+r+1}{2} \right\rceil + 1 \]
  running from $k = \frac{\ell}{2} - r$ to $k = \frac{\ell}{2} + 2 \delta + r$.
\end{itemize}
Now we collate the contribution of the first three double sums:
\begin{align*}
  &\phantom+ \sum_{k=\ell-r}^{\lambda-\ell+2\delta+r} \left(
    \min\left( \left\lfloor \frac{k - \ell + r - 1}{2} \right\rfloor, - \frac{\ell}{2} + \delta + r - 1 \right)
    - \max\left( \left\lceil \frac{k + r -\lambda}{2} \right\rceil, 0 \right) + 1 \right) (-q^s)^k \\
  &+ \sum_{k=\lambda-r}^{\lambda-\ell+2\delta+r} \left(
    \min\left(k+r, \left\lfloor \frac{k+\lambda-\frac{\ell}{2}+\delta+r}{2} \right\rfloor, \lambda - \frac{\ell}{2} + \delta + r \right)
    - \left\lceil \frac{k+\lambda+r+1}{2} \right\rceil + 1 \right) (-q^s)^k \\
  &+ \sum_{k=\ell-r}^{2\delta+r} \left(
    \min\left( k+r, \left\lfloor \frac{k+\frac{\ell}{2}+\delta+r}{2} \right\rfloor, \frac{\ell}{2} + \delta + r \right)
    - \left\lceil \frac{k+\ell+r+1}{2} \right\rceil + 1 \right) (-q^s)^k \\
  &= \sum_{k=\ell-r}^{\lambda-r-1} \left(
    \min\left( \left\lfloor \frac{k - \ell + r - 1}{2} \right\rfloor, - \frac{\ell}{2} + \delta + r - 1 \right)
    + 1 \right) (-q^s)^k \\
  &+ \sum_{k=\lambda-r}^{\lambda-\ell+2\delta+r} \left(
    \min\left( \left\lfloor \frac{k - \ell + r - 1}{2} \right\rfloor, - \frac{\ell}{2} + \delta + r - 1 \right)
    - \left\lceil \frac{k + r -\lambda}{2} \right\rceil + 1 \right) (-q^s)^k \\
  &+ \sum_{k=\lambda-r}^{\lambda-\ell+2\delta+r} \left(
    \min\left(k+r, \left\lfloor \frac{k+\lambda-\frac{\ell}{2}+\delta+r}{2} \right\rfloor, \lambda - \frac{\ell}{2} + \delta + r \right)
    - \left\lceil \frac{k+\lambda+r+1}{2} \right\rceil + 1 \right) (-q^s)^k \\
  &+ \sum_{k=\ell-r}^{2\delta+r} \left(
    \min\left( k+r, \left\lfloor \frac{k+\frac{\ell}{2}+\delta+r}{2} \right\rfloor, \frac{\ell}{2} + \delta + r \right)
    - \left\lceil \frac{k+\ell+r+1}{2} \right\rceil + 1 \right)(-q^s)^k .
\end{align*}

Hence, for each $k$ the coefficient of $(-q^s)^k$
is given by a sum of a subset of the following four coefficients:
\begin{itemize}
  \ii For $\ell - r \le k \le \lambda - r - 1$, we get
  \[ C_1(k) \coloneqq \begin{cases}
    \left\lfloor \frac{k - \ell + r + 1}{2} \right\rfloor &\text{if } k \le 2 \delta + r \\
    - \frac{\ell}{2} + \delta + r &\text{if } k \ge 2 \delta + r.
    \end{cases} \]
  \ii For $\lambda - r \le k \le \lambda - \ell + 2 \delta + r$, we get
  \begin{align*}
    C_2(k)
    &\coloneqq \begin{cases}
      \left\lfloor \frac{k-\ell+r+1}{2} \right\rfloor - \left\lceil \frac{k+r-\lambda}{2} \right\rceil &\text{if } k \le 2 \delta + r \\
      - \frac{\ell}{2} + \delta + r - \left\lceil \frac{k+r-\lambda}{2} \right\rceil &\text{if } k \ge 2 \delta + r \\
    \end{cases} \\
    &= \begin{cases}
      \frac{\lambda-\ell+1}{2} - (k+r+1)\%2 &\text{if } k \le 2 \delta + r \\
      \left\lfloor \frac{\lambda - \ell + 2\delta + r - k}{2} \right\rfloor &\text{if } k \ge 2 \delta + r.
    \end{cases}
  \end{align*}

  \ii For $\lambda - r \le k \le \lambda - \ell + 2 \delta + r$, we get
  \begin{align*}
    C_3(k)
    &\coloneqq \begin{cases}
      k + r - \left\lceil \frac{k+\lambda+r+1}{2} \right\rceil + 1 &\text{if } k \le \lambda - \frac{\ell}{2} + \delta - r \\
      \left\lfloor \frac{k + \lambda - \frac{\ell}{2} + \delta + r}{2} \right\rfloor - \left\lceil \frac{k+\lambda+r+1}{2} \right\rceil + 1 &\text{if } \lambda - \frac{\ell}{2} + \delta - r \le k \le \lambda - \frac{\ell}{2} + \delta + r \\
      \left( \lambda - \frac{\ell}{2} + \delta + r \right)- \left\lceil \frac{k+\lambda+r+1}{2} \right\rceil + 1 &\text{if } k \ge \lambda - \frac{\ell}{2} + \delta + r \\
    \end{cases} \\
    &= \begin{cases}
      \left\lfloor \frac{k-\lambda+r+1}{2} \right\rfloor &\text{if } k \le \lambda - \frac{\ell}{2} + \delta - r \\
      \frac{- \frac{\ell}{2} + \delta + 1 - (k+\frac{\ell}{2}+\delta+r+1)\%2 -(k+r)\%2}{2} & \text{if } \lambda - \frac{\ell}{2} + \delta - r \le k \le \lambda - \frac{\ell}{2} + \delta + r \\
      \left\lfloor \frac{\lambda - \ell + 2\delta + r - k + 1}{2} \right\rfloor &\text{if } k \ge \lambda - \frac{\ell}{2} + \delta + r.
    \end{cases}
  \end{align*}

  \ii For $\ell - r \le k \le 2 \delta + r$, we get
  \begin{align*}
    C_4(k)
    &\coloneqq \begin{cases}
      k + r - \left\lceil \frac{k+\ell+r+1}{2} \right\rceil + 1 &\text{if } k \le \frac{\ell}{2} + \delta - r \\
      \left\lfloor \frac{k + \frac{\ell}{2} + \delta + r}{2} \right\rfloor - \left\lceil \frac{k+\ell+r+1}{2} \right\rceil + 1 &\text{if } \frac{\ell}{2} + \delta - r \le k \le \frac{\ell}{2} + \delta + r \\
      \left( \frac{\ell}{2} + \delta + r \right)- \left\lceil \frac{k+\ell+r+1}{2} \right\rceil + 1 &\text{if } k \ge \frac{\ell}{2} + \delta + r \\
    \end{cases} \\
    &= \begin{cases}
      \left\lfloor \frac{k-\ell+r+1}{2} \right\rfloor &\text{if } k \le \frac{\ell}{2} + \delta - r \\
      \frac{-\frac{\ell}{2} + \delta + 1 - (k+\frac{\ell}{2}+\delta+r)\%2 -(k+r+1)\%2}{2} & \text{if } \frac{\ell}{2} + \delta - r \le k \le \frac{\ell}{2} + \delta + r \\
      \left\lfloor \frac{2\delta + r - k + 1}{2} \right\rfloor &\text{if } k \ge \frac{\ell}{2} + \delta + r.
    \end{cases}
  \end{align*}
\end{itemize}
The coefficient we need is then
\[ C(k) \coloneqq C_1(k) + C_2(k) + C_3(k) + C_4(k) \]
where we consider $C_i(k) = 0$ if $k$ falls outside the required range for $C_i$.

\Cref{fig:ell_even_bands} gives a sketch of the regions
covered by $C_1$, $C_2$, $C_3$, $C_4$ in one situation.
In the general situation, some of the points in the middle could have different orders
relative to each other.
(In particular, $2\delta+r$ could occur in either $C_1$ or $C_2$.)
\begin{figure}[ht]
  \begin{center}
  \begin{asy}
    size(15cm);
    usepackage("amsmath");
    real h = 1.7;

    draw((3,3*h)--(3,2*h), dotted, Margins);
    draw((9,3*h)--(9,h), dotted, Margins);

    draw(( 0,3*h)--( 3,3*h), red, Arrows(TeXHead), Margins);
    draw(( 3,3*h)--(12,3*h), red, Arrows(TeXHead), Margins);
    dot("$\ell-r$", (0,3*h), dir(90), red);
    dot("$\lambda-r$", (3,3*h), dir(90), red);
    dot("$\lambda-\ell+2\delta+r$", (12,3*h), dir(90), red);
    label("$\boxed{C_1}$", (1.5,3*h), dir(90), red);
    label("$\boxed{C_2}$", (7.5,3*h), dir(90), red);

    draw(( 3,2*h)--(12,2*h), blue, Arrows(TeXHead), Margins);
    dot("$\lambda-r$", (3,2*h), dir(-90), blue);
    dot("$\lambda-\ell+2\delta+r$", (12,2*h), dir(-90), blue);
    label("$\boxed{C_3}$", (7.5,2*h), dir(90), blue);

    draw(( 0,1*h)--( 9,1*h), deepgreen, Arrows(TeXHead), Margins);
    dot("$\ell-r$", (0,h), dir(-90), deepgreen);
    dot("$2\delta+r$", (9,h), dir(-90), deepgreen);
    label("$\boxed{C_4}$", (4.5,h), dir(90), deepgreen);

    dot("$2\delta+r$", (9,3*h), dir(90), grey);
    dot("$\frac{\ell}{2}+\delta-r$", (1.8,h), dir(90));
    dot("$\frac{\ell}{2}+\delta+r$", (7.2,h), dir(90));
    dot("$\lambda-\frac{\ell}{2}+\delta-r$", (4.8,2*h), dir(90));
    dot("$\lambda-\frac{\ell}{2}+\delta+r$", (10.2,2*h), dir(90));
  \end{asy}
  \end{center}
  \label{fig:ell_even_bands}
  \caption{Rough illustration of one possibility for the shapes of
    regions for $C_1$, $C_2$, $C_3$, $C_4$, in the case where
    $\lambda - \frac{\ell}{2} + \delta - r \le \frac{\ell}{2} + \delta + r$.
    The breaking points within each $C_i$ are marked in black, and grey dotted lines
    join values of $k$ that overlap between the regions.
    The four black breaking points show up in the collated formula later.}
\end{figure}

\begin{figure}[ht]
  \begin{center}
  \begin{asy}
    size(15cm);
    usepackage("amsmath");
    real h = 1.7;

    draw((7,3*h)--(7,2*h), dotted, Margins);
    draw((5,3*h)--(5,h), dotted, Margins);

    draw(( 0,3*h)--( 7,3*h), red, Arrows(TeXHead), Margins);
    draw(( 7,3*h)--(12,3*h), red, Arrows(TeXHead), Margins);
    dot("$\ell-r$", (0,3*h), dir(90), red);
    dot("$\lambda-r$", (7,3*h), dir(90), red);
    dot("$\lambda-\ell+2\delta+r$", (12,3*h), dir(90), red);
    label("$\boxed{C_1}$", (3.5,3*h), dir(90), red);
    label("$\boxed{C_2}$", (9.5,3*h), dir(90), red);

    draw(( 7,2*h)--(12,2*h), blue, Arrows(TeXHead), Margins);
    dot("$\lambda-r$", (7,2*h), dir(-90), blue);
    dot("$\lambda-\ell+2\delta+r$", (12,2*h), dir(-90), blue);
    label("$\boxed{C_3}$", (9.5,2*h), dir(-90), blue);

    draw(( 0,1*h)--( 5,1*h), deepgreen, Arrows(TeXHead), Margins);
    dot("$\ell-r$", (0,h), dir(-90), deepgreen);
    dot("$2\delta+r$", (5,h), dir(-90), deepgreen);
    label("$\boxed{C_4}$", (2.5,h), dir(90), deepgreen);

    dot("$2\delta+r$", (5,3*h), dir(90), grey);
    dot("$\frac{\ell}{2}+\delta-r$", (1.8,h), dir(130));
    dot("$\frac{\ell}{2}+\delta+r$", (3.2,h), dir(50));
    dot("$\lambda-\frac{\ell}{2}+\delta-r$", (8.8,2*h), dir(110), fontsize(9pt));
    dot("$\lambda-\frac{\ell}{2}+\delta+r$", (10.2,2*h), dir(70), fontsize(9pt));
  \end{asy}
  \end{center}
  \label{fig:ell_even_bands_alt}
  \caption{An illustration of another possibility for the shapes of
    regions for $C_1$, $C_2$, $C_3$, $C_4$, this time in the case where
    $\frac{\ell}{2} + \delta + r \le \lambda - \frac{\ell}{2} + \delta - r$.}
\end{figure}

To make the casework a bit more efficient, we prove the following lemma,
which effectively lets us fold together cases on $\lambda-r$ or $2\delta+r$.
\begin{lemma}
  [Folding cases]
  \label{lem:folding_cases}
  The following two identities are true:
  \begin{itemize}
  \ii For $k \le \min\left( \lambda - \frac{\ell}{2} + \delta - r, 2 \delta + r \right)$,
  \[
    \left\lfloor \frac{k - \ell + r + 1}{2} \right\rfloor
    = \begin{cases}
      C_1(k) & \text{if } k \le \lambda - r \\
      C_2(k) + C_3(k) & \text{if } k \ge \lambda-r.
    \end{cases}
  \]
  \ii For $k \ge \max\left( \lambda - \frac{\ell}{2} + \delta - r, \lambda - r \right)$,
  \[
    \left\lfloor \frac{\lambda-\ell+2\delta+r-k}{2} \right\rfloor
    = \begin{cases}
      C_2(k) &\text{if } k \ge 2\delta + r \\
      C_2(k)+C_4(k)-(k+r)\%2 & \text{if }k \le 2 \delta + r.
    \end{cases}
  \]
  \end{itemize}
\end{lemma}
\begin{proof}
  For the first part,
  it's trivial for $k \le \lambda-r$, whilst for $k \ge \lambda-r$ we have
  \begin{align*}
    C_2(k) + C_3(k) &=
      \frac{\lambda-\ell+1}{2} - (k+r-\lambda) \% 2
      + \left\lfloor \frac{k-\lambda+r+1}{2} \right\rfloor \\
      &= \left\lfloor \frac{k-\ell+r+2}{2} \right\rfloor - (k+r-\lambda) \% 2
  \end{align*}
  which also equals the claimed result.

  For the second part,
  it's again trivial for $k \ge 2\delta + r$ whilst for $k \le 2\delta + r$ we have
  \begin{align*}
    C_2(k) + C_4(k) &=
    \frac{\lambda-\ell+1}{2} - (k+r+1)\%2 + \left\lfloor \frac{2\delta+r-k+1}{2} \right\rfloor \\
    &= \left\lfloor \frac{\lambda-\ell+2\delta+r-k}{2} \right\rfloor
    + (1 - (k+r+1)\%2)
  \end{align*}
  which also matches.
\end{proof}

We consider the following five cases now:
\begin{enumerate}
  \ii Suppose $\ell - r \le k \le \frac{\ell}{2} + \delta - r$
  (in particular, also $k \le 2 \delta + r$ and $k \le \lambda - \frac{\ell}{2} = \delta$).
  Then from \Cref{lem:folding_cases} we have
  \[ C(k) = \left\lfloor \frac{k-\ell+r+1}{2} \right\rfloor + C_4(k)
    = k - (\ell-r) + (k+r) \% 2. \]

  \ii Next suppose that
  $\frac{\ell}{2} + \delta - r \le k \le \min(\delta + \frac{\ell}{2} + r,
    \lambda - \frac{\ell}{2} + \delta - r)$.
  Again from \Cref{lem:folding_cases} we have
  \begin{align*}
    C(k) &= \left\lfloor \frac{k - \ell + r + 1}{2} \right\rfloor + C_4(k) \\
    &= \left\lfloor \frac{k - \ell + r + 1}{2} \right\rfloor +
    \frac{-\frac{\ell}{2} + \delta + 1 - (k+\frac{\ell}{2}+\delta+r)\%2 - (k+r+1)\%2}{2} \\
    &= \frac{k - \ell + r + 1}{2} +
      \frac{-\frac{\ell}{2} + \delta + 1 - (k+\frac{\ell}{2}+\delta+r)\%2}{2} - (k+r+1)\%2 \\
    &= \left( \delta - \frac{\ell}{2}  \right)
    + \left\lfloor \frac{k - \left( \frac{\ell}{2} + \delta - r \right)}{2}  \right\rfloor
    + (k+r) \% 2.
  \end{align*}

  \ii The next case is split into two possibilities.
  \begin{itemize}
    \ii First suppose that
    \[ \lambda - \frac{\ell}{2} + \delta - r \le k \le \frac{\ell}{2} + \delta + r \]
    (which matches \Cref{fig:ell_even_bands}).
    Then
    \begin{align*}
      C(k) &= C_2(k) + C_3(k) + C_4(k) \\
      &= \frac{\lambda-\ell+1}{2} - (k+r+1)\%2 \\
      &\qquad+ \frac{- \frac{\ell}{2} + \delta + 1 - (k+\frac{\ell}{2}+\delta+r+1)\%2 -(k+r)\%2}{2} \\
      &\qquad+ \frac{-\frac{\ell}{2} + \delta + 1 - (k+\frac{\ell}{2}+\delta+r)\%2 -(k+r+1)\%2}{2} \\
      &= \frac{\lambda-2\ell+2\delta+1}{2} + (k+r) \% 2.
    \end{align*}

    \ii Instead suppose that
    \[ \frac{\ell}{2} + \delta + r \le k \le \lambda - \frac{\ell}{2} + \delta - r. \]
    We consider four more sub-possibilities.
    \begin{itemize}
    \ii If $k \le \min(2\delta+r, \lambda-r)$ we get
    \begin{align*}
      C(k) &= C_1(k) + C_4(k) \\
      &= \left\lfloor \frac{k-\ell+r+1}{2} \right\rfloor
      + \left\lfloor \frac{2\delta+r-k+1}{2} \right\rfloor \\
      &= -\frac{\ell}{2} + \delta + r + (k+r)\%2.
    \end{align*}
    \ii Similarly $k \ge \min(2\delta+r, \lambda-r)$ we get
    \begin{align*}
      C(k) &= C_2(k) + C_3(k) \\
      &= \left\lfloor \frac{\lambda - \ell + 2\delta + r - k}{2} \right\rfloor
      + \left\lfloor \frac{k-\lambda+r+1}{2} \right\rfloor \\
      &= -\frac{\ell}{2} + \delta + r.
    \end{align*}
    \ii If $2\delta + r \le k \le \lambda - r$ we simply get
    \[ C(k) = C_1(k) = -\frac{\ell}{2} + \delta + r. \]
    \ii Finally if $\lambda - r \le k \le 2 \delta + r$ we get instead
    \begin{align*}
      C(k) &= C_1(k) + C_2(k) + C_3(k) \\
      &= \frac{\lambda-\ell+1}{2} - (k+r+1)\%2
      + \left\lfloor \frac{k-\lambda+r+1}{2} \right\rfloor \\
      &\qquad + \left( \frac{\ell}{2} + \delta + r \right)- \left\lceil \frac{k+\ell+r+1}{2} \right\rceil + 1 \\
      &= -\frac{\ell}{2} + \delta + r + (k+r) \% 2.
    \end{align*}
    \end{itemize}
  \end{itemize}

  \ii Moving on, suppose that
  $\max(\frac{\ell}{2} + \delta + r, \lambda - \frac{\ell}{2} + \delta - r)
    \le k \le \lambda - \frac{\ell}{2} + \delta + r$.
  Applying \Cref{lem:folding_cases} we get that
  \begin{align*}
    C(k) &= \left\lfloor \frac{\lambda - \ell + 2\delta + r - k}{2} \right\rfloor
    + C_3(k)
    + \mathbf{1}_{k \le 2 \delta + r} (k + r) \% 2 \\
    &= \left\lfloor \frac{\lambda - \ell + 2\delta + r - k}{2} \right\rfloor +
      \frac{- \frac{\ell}{2} + \delta + 1 - (k+\frac{\ell}{2}+\delta+r+1)\%2 -(k+r)\%2}{2} \\
      &\qquad + \mathbf{1}_{k \le 2 \delta + r} (k + r) \% 2 \\
    &= \left( \delta - \frac{\ell}{2} \right)
    + \left\lfloor \frac{\left( \lambda - \frac{\ell}{2} + \delta + r \right) - k}{2} \right\rfloor
    + \mathbf{1}_{k \le 2 \delta + r} (k + r) \% 2.
  \end{align*}

  \ii Finally, if $\lambda - \frac{\ell}{2} + \delta + r \le k \le \lambda - \ell + 2 \delta + r$,
  use \Cref{lem:folding_cases} to get just
  \begin{align*}
    C(k) &= \left\lfloor \frac{\lambda - \ell + 2\delta + r - k}{2} \right\rfloor + C_3(k) \\
    &= \left\lfloor \frac{\lambda - \ell + 2\delta + r - k}{2} \right\rfloor +
      \left\lfloor \frac{\lambda - \ell + 2\delta + r - k + 1}{2} \right\rfloor
      + \mathbf{1}_{k \le 2 \delta + r} (k + r) \% 2 \\
    &= (\lambda - \ell + 2 \delta + r) - k + \mathbf{1}_{k \le 2 \delta + r} (k + r) \% 2.
  \end{align*}
\end{enumerate}
Having exhausted all five cases, we compile them into the following:
\begin{proposition}
  [$\cc_\gamma$]
  \label{prop:ell_even_top_coeff}
  Let us define
  \[
    \cc_\gamma \coloneqq \Arch_{[\ell-r, \lambda - \ell + 2\delta + r]}
    (\delta - \ell/2, \min(\lambda-\ell-1, 2r)).
  \]
  Then
  \begin{align*}
  & q^{\frac{\ell}{2}+r} \cdot \sum_{n=\ell+r+1}^{\lambda+r}
    \sum_{m=n-r}^{n-1-\frac{\ell}{2}+\delta}
    (-1)^n q^{s(2m-n)}
  + q^{\frac{\ell}{2}+r} \cdot \sum_{n=\lambda+r+1}^{\lambda-\frac{\ell}{2}+\delta+r}
    \sum_{m=n-r}^{\lambda-\frac{\ell}{2}+\delta+r}
    (-1)^n q^{s(2m-n)} \\
  &\qquad+ q^{\frac{\ell}{2}+r} \cdot \sum_{n=\ell+r+1}^{\frac{\ell}{2}+\delta+r}
    \sum_{m=n-r}^{\frac{\ell}{2}+\delta+r}
    (-1)^n q^{s(2m-n)} \\
  &= \sum_{k=\ell-r}^{\lambda-\ell+2\delta+r} \cc_\gamma(k) (-1)^k (q^s)^k
    + \sum_{k \equiv \ell-r}^{2\delta+r} (k+r)\%2 \cdot (-1)^k (q^s)^k.
  \end{align*}
\end{proposition}
\begin{proof}
After removing the $\mathbf{1}_{k \le 2 \delta + r} \cdot (k + r) \% 2$ term,
we see that we need to verify
\[
  \cc_\gamma(k)
  =
  \begin{cases}
    k - (\ell-r) & \ell - r \le k \le \frac{\ell}{2} + \delta - r \\
    \left( \delta - \frac{\ell}{2}  \right)
      + \left\lfloor \frac{k - \left( \frac{\ell}{2} + \delta - r \right)}{2}  \right\rfloor
      & \frac{\ell}{2} + \delta - r \le k \le \min(\delta + \frac{\ell}{2} + r,
      \lambda - \frac{\ell}{2} + \delta - r) \\
    \frac{\lambda-2\ell+2\delta+1}{2}
      & \lambda - \frac{\ell}{2} + \delta - r \le k \le \frac{\ell}{2} + \delta + r \\
    -\frac{\ell}{2} + \delta + r
      & \frac{\ell}{2} + \delta + r \le k \le \lambda - \frac{\ell}{2} + \delta - r \\
    \left( \delta - \frac{\ell}{2} \right)
      + \left\lfloor \frac{\left( \lambda - \frac{\ell}{2} + \delta + r \right) - k}{2} \right\rfloor
      & \max(\frac{\ell}{2} + \delta + r, \lambda - \frac{\ell}{2} + \delta - r)
      \le k \le \lambda - \frac{\ell}{2} + \delta + r \\
    (\lambda - \ell + 2 \delta + r) - k
      & \lambda - \frac{\ell}{2} + \delta + r \le k \le \lambda - \ell + 2 \delta + r.
  \end{cases}
\]
which follows directly from the definition of $\Arch$ that we proposed.
\end{proof}

\subsubsection{Analysis of the remaining double sum}
It remains to evaluate
\[
  \sum_{n=\ell+r+1}^{\lambda+r} \sum_{m=n-\frac{\ell}{2}+\delta}^{\min(n,\lambda)+\delta+r}
  q^{n-m+\delta+r} \cdot (-1)^n q^{s(2m-n)}.
\]
As before if we define
\begin{align*}
  j &\coloneqq (n+\delta+r)-m \ge 0 \\
  k &\coloneqq n + 2 \delta + 2 r - 2 j.
\end{align*}
so the sum becomes
\begin{align*}
  &\phantom= \sum_{n=\ell+r+1}^{\lambda+r} \sum_{j=\max(0,n-\lambda)}^{\frac{\ell}{2}+r}
  q^j \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &= \sum_{j=\max(r-(\lambda-\ell-1),0)}^{\frac{\ell}{2}+r} \sum_{n=\ell+r+1}^{\lambda+\min(j,r)}
  q^j \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &= \sum_{j=\max(r-(\lambda-\ell-1),0)}^{r} \sum_{n=\ell+r+1}^{j+\lambda}
  q^j \cdot (-1)^n q^{s(n+2\delta+2r-2j)}
  + \sum_{j=r+1}^{\frac{\ell}{2}+r} \sum_{n=\ell+r+1}^{\lambda+r}
  q^j \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &= \sum_{j=\max(r-(\lambda-\ell-1),0)}^r \sum_{k=\ell+2\delta+3r-2j+1}^{\lambda+2\delta+2r-j}
  q^j \cdot (-q^s)^k
  + \sum_{j=r+1}^{\frac{\ell}{2}+r} \sum_{k=\ell+2\delta+3r-2j+1}^{\lambda+2\delta+3r-2j}
  q^j \cdot (-q^s)^k.
\end{align*}
Now we collect the coefficient of $(-q^s)^k$.
In the first double sum the value of $k$ runs from
the lowest value $k = \ell + 2 \delta + r + 1$
to the highest value $\lambda + 2 \delta + 2r - \max(r - (\lambda-\ell-1), 0)$.
The range of $j$ being summed is given by solving
\[
  \ell + 2 \delta + 3r - 2j + 1 \le k \le \lambda + 2 \delta + 2r - j
  \iff \frac{\ell + 2\delta + 3r + 1 - k}{2} \le j \le \lambda + 2 \delta + 2 r - k
\]
to get
\[ \max\left( \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil,
    0, r-(\lambda-\ell-1)\right)
    \le j \le \max\left( \lambda+2\delta+2r-k, r \right). \]
%However, for $k \le \lambda + 2 \delta + 2r - \max(r - (\lambda-\ell-1), 0)$ we have
%\[ \frac{\lambda + 2\delta + 3r + 1 - k}{2}
%  \ge \frac{r + \max(r-(\lambda-\ell-1), 0)}{2}
%  \ge \max(r-(\lambda-\ell-1), 0) \]
%so the maximum on the left-hand side resolves.

In the second double sum the value of $k$ runs from the lowest
value $k = 2 \delta + r + 1$ to the highest value $k = \lambda + 2 \delta + r - 2$
and $j$ now needs to satisfy
\[ \ell + 2 \delta + 3r - 2j + 1 \le k \le \lambda + 2\delta + 3r - 2j
  \iff \frac{\ell+2\delta+3r+1-k}{2} \le j \le \frac{\lambda+2\delta+3r-k}{2} \]
so we get the range to this time be
\[ \max\left( \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil, r + 1\right)
  \le j \le \min\left( \left\lfloor \frac{\lambda+2\delta+3r-k}{2} \right\rfloor,
    \frac{\ell}{2} + r \right). \]
In this case the max resolves to the ceiling because
$\frac{\lambda + 2 \delta + 3r + 1 - k}{2}
\ge \frac{\lambda + 2 \delta + 3r + 1 - (\lambda + 2 \delta + r - 2)}{2} \ge r+1$
for all $k$ in the desired range, but the min does not resolve immediately.
For convenience, we add on two extra values $k = \lambda + 2 \delta + r - 1$
and $k = \lambda + 2r + r$ for which the range above for $j$ is void anyway,
to make it easier to merge the sums momentarily.

In summary, our rewritten sum equals
\begin{align*}
  \sum_{k = \ell + 2\delta + r + 1}^{\lambda + 2 \delta + 2r - \max(r - (\lambda-\ell-1), 0)}
  \sum_{j=\max\left( \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil,
    0, r-(\lambda-\ell-1)\right)}^{\min\left( \lambda+2\delta+2r-k, r \right)}
    & q^j (-q^s)^k \\
  + \sum_{k = 2 \delta + r + 1}^{\lambda + 2 \delta + r}
  \sum_{j = \max\left( \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil, r + 1\right)}
  ^{\min\left( \left\lfloor \frac{\lambda+2\delta+3r-k}{2} \right\rfloor, \frac{\ell}{2} + r \right)}
    & q^j (-q^s)^k.
\end{align*}
Notice we always have
\[ 2\delta + r + 1 \le \ell + 2 \delta + r + 1 \le \lambda + 2 \delta + r
  \le \lambda + 2 \delta + 2r - \max\left( r - (\lambda - \ell - 1), 0 \right) \]
so the values of $k$ in the second double sum are contained inside those of the first.
Moreover, the two breaking points are
\begin{align*}
  \lambda + 2 \delta + 2 r - k \le r &\iff k \ge \lambda + 2 \delta + r \\
  \left\lceil \frac{\ell + 2 \delta + 3r + 1 - k}{2} \right\rceil \ge r+1
  &\iff k \le \ell + 2 \delta + r - 1
\end{align*}
which miraculously line up with the boundaries of the sum.
Hence for these overlapped values the two sums over $j$ fit together neatly
with a ``seam'' at the value $j = r$.
Then rewriting the sum with ascending values of $k$ we have
\begin{align*}
  \sum_{k = 2 \delta + r + 1}^{\ell + 2\delta + r}
    \sum_{j = \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil}^{\frac{\ell}{2} + r}
    & q^j (-q^s)^k \\
  + \sum_{k = \ell + 2 \delta + r + 1}^{\lambda + 2 \delta + r}
    \sum_{j=\max\left( \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil,
    0, r-(\lambda-\ell-1)\right)}^{\frac{\ell}{2} + r}
    & q^j (-q^s)^k \\
  + \sum_{k = \lambda + 2\delta + r + 1}^{\lambda + 2 \delta + 2r - \max(r - (\lambda-\ell-1), 0)}
    \sum_{j=\max\left( \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil,
    0, r-(\lambda-\ell-1)\right)}^{\lambda+2\delta+2r-k}
    & q^j (-q^s)^k.
\end{align*}
where we have used
$\frac{\lambda+2\delta+3r-k}{2} \ge \frac{\ell}{2} + r \iff \lambda+2\delta+r+\ell \ge k$
to resolve the minimums in the first two sums.


To proceed further we split this into cases based on whether $\lambda > \ell+r$ or not.
\begin{itemize}
  \ii If $\lambda > \ell + r$, then we have
  \begin{equation}
  \begin{aligned}
    \sum_{k = 2 \delta + r + 1}^{\ell + 2\delta + r}
    \sum_{j = \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil}
      ^{\frac{\ell}{2} + r}
      & q^j (-q^s)^k \\
    + \sum_{k = \ell + 2 \delta + r + 1}^{\lambda + 2 \delta + r}
    \sum_{j=\max\left( \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil, 0\right)}
      ^{\frac{\ell}{2} + r}
      & q^j (-q^s)^k \\
    + \sum_{k = \lambda + 2\delta + r + 1}^{\lambda + 2 \delta + 2r}
    \sum_{j=\max\left( \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil, 0 \right)}
      ^{\lambda+2\delta+2r-k}
      & q^j (-q^s)^k.
  \end{aligned}
  \label{eq:ell_even_missing1}
  \end{equation}

  \ii If $\lambda \le \ell + r$, then we instead have
  \begin{equation}
  \begin{aligned}
    \sum_{k = 2 \delta + r + 1}^{\ell + 2\delta + r}
    \sum_{j = \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil}
      ^{\frac{\ell}{2} + r}
      & q^j (-q^s)^k \\
    + \sum_{k = \ell + 2 \delta + r + 1}^{\lambda + 2 \delta + r}
    \sum_{j=\max\left( \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil,
      r-(\lambda-\ell-1)\right)}
      ^{\frac{\ell}{2} + r}
      & q^j (-q^s)^k \\
    + \sum_{k = \lambda + 2\delta + r + 1}^{2\lambda - \ell + 2\delta + r - 1}
    \sum_{j=\max\left( \left\lceil \frac{\ell + 2\delta + 3r + 1 - k}{2} \right\rceil,
      r-(\lambda-\ell-1)\right)}^{\lambda+2\delta+2r-k}
      & q^j (-q^s)^k.
  \end{aligned}
  \label{eq:ell_even_missing2}
  \end{equation}
\end{itemize}

\subsection{Proof of \Cref{thm:full_orbital_ell_even}}
We now put the finishing touches to deduce \Cref{thm:full_orbital_ell_even}.

\elleven*
\begin{proof}
  [Proof of \Cref{thm:full_orbital_ell_even}]
  The coefficient $\cc_\guv$ was already introduced in \Cref{prop:ell_even_top_coeff},
  where there is an extra $(k+r)\%2$ term for $\ell-r \le k \le 2\delta+r$
  that matches the corresponding term in \Cref{prop:ell_even_half}.

  Then, when $\lambda > \ell + r$ the terms in \Cref{prop:ell_even_half}
  fit together with the sum in \eqref{eq:ell_even_missing1} to give $\nn_\guv$.
  The same is true with $\lambda \le \ell + r$
  when one uses \eqref{eq:ell_even_missing2} instead.
  This completes the proof.
\end{proof}

\begin{remark}
  [Expanding $\nn_\gamma$]
  One can expand the Arch notation for $\nn_\gamma$ to obtain
  \[
    \nn_\gamma(k) =
    \begin{cases}
      k + 2r & \text{if } {-2r} \le k \le -r \\
      \left\lfloor \frac{k+r}{2} \right\rfloor + r & \text{if }{-r} \le k \le \ell-r \\
      \frac{\ell}{2} + r & \text{if } \ell - r \le k \le \lambda - \ell + 2\delta +  r \\
      \left\lfloor \frac{(2\delta+\lambda+r)-k}{2} \right\rfloor + r & \text{if } \lambda - \ell + 2\delta + r \le k \le \lambda + 2\delta + r \\
      (\lambda + 2\delta + 2r) - k & \text{if } \lambda + 2\delta + r \le k \le \lambda + 2\delta + 2r.
    \end{cases}
  \]
  Then $\cc_\gamma$ can be similarly expanded, but the result is so notationally dense
  that it is hardly worth including.
  If one defines the shorthands
  \begin{align*}
    \mathsf{B}_\gamma &\coloneqq \frac{\ell}{2} + \delta - r \\
    \mathsf{T}_\gamma &\coloneqq \lambda - \frac{\ell}{2} + \delta + r \\
    \mathsf{w}_\gamma &\coloneqq \min(\lambda-\ell-1, 2r)
  \end{align*}
  then it could be written out more fully as
  \[
    \cc_\gamma(k) = \begin{cases}
      k - (\ell - r)
        & \text{if } \ell-r \le k \le \mathsf{B}_\gamma \\
      \left\lfloor \frac{k - \mathsf{B}_\gamma}{2} \right\rfloor - \frac{\ell}{2} + \delta
        &\text{if } \mathsf{B}_\gamma \le k \le \mathsf{B}_\gamma + \mathsf{w}_\gamma \\
      - \frac{\ell}{2} + \delta + \half \mathsf{w}_\gamma
        &\text{if } \mathsf{B}_\gamma + \mathsf{w}_\gamma \le k \le \mathsf{T}_\gamma - \mathsf{w}_\gamma \\
      \left\lfloor \frac{\mathsf{T}_\gamma - k}{2} \right\rfloor - \frac{\ell}{2} + \delta
        &\text{if } \mathsf{T}_\gamma - \mathsf{w}_\gamma \le k \le \mathsf{T}_\gamma \\
        (\lambda - \ell + 2\delta + r) - k
        & \text{if } \mathsf{T}_\gamma \le k \le 2\delta + \lambda - \ell + r.
    \end{cases}
  \]
\end{remark}

\subsection{Contribution of cases for the $v(b) = v(d) < 0$ case (and proof of \Cref{thm:full_orbital_ell_neg})}
We now deal with the edge case $v(b) = v(d) < 0$.
The region $I_{n \le 0}$ remains the same, but we need to alter the calculation of the other parts.
We assume $|v(d)| \le r$ henceforth since otherwise the entire orbital integral vanishes.

\subsubsection{Contribution of Case 1 and Case 2}
This situation only occurs if $r > 2|v(d)|$.
In that case we get
\begin{align*}
  I_{n > 0}^{\text{1+2}}
  &= \kappa \sum_{n=1}^{-2|v(d)|+r}
    \sum_{m=n-r}^{-2|v(d)|+r}
    q^{-n} \left( 1 - q^{-2} \right)
    \cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &+ \kappa \sum_{n=1}^{-2|v(d)|+r}
    \sum_{m=-2|v(d)|+r+1}^{\min\left(n-2|v(d)|+r, \lambda-|v(d)|+r\right)}
    q^{-n - (m+2|v(d)|-r)} \left( 1 - q^{-1} \right) \\
  &\qquad\qquad\cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &= \sum_{n=1}^{-2|v(d)|+r} \sum_{m=n-r}^{-2|v(d)|+r}
    q^{n} \left( 1 + q^{-1} \right) (-1)^n q^{s(2m-n)} \\
  &+ \sum_{n=1}^{-2|v(d)|+r}
    \sum_{m=-2|v(d)|+r+1}^{\min\left(n,\lambda\right) - 2|v(d)| + r}
    q^{n - (m+2|v(d)|-r)} \cdot (-1)^n q^{s(2m-n)}.
\end{align*}

\subsubsection{Contribution of Case 3\ts+ and Case 4\ts+}
We split the sum into several cases.
\begin{align*}
  I_{n > 0}^{\text{3+4}}
  &= \kappa \sum_{n=\max(1, -2|v(d)|+r+1)}^{-|v(d)|+r}
    \sum_{m=n-r}^{-2|v(d)|+r}
    q^{-n} \left( 1 - q^{-2} \right)
    \cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &+ \kappa \sum_{n=\max(1, -2|v(d)|+r+1)}^{-|v(d)|+r}
    \sum_{m=-2|v(d)|+r+1}^{\min(n, \lambda) - 2|v(d)| + r}
    q^{-n-(m+2|v(d)|-r)} \left( 1 - q^{-1} \right) \\
    &\qquad\qquad\cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &+ \kappa \sum_{n=-|v(d)|+r+1}^{\lambda-|v(d)|+r}
    \sum_{m=n-r}^{n-|v(d)|}
    q^{-2n+r-|v(d)|} \left( 1 - q^{-1} \right)
    \cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &+ \kappa \sum_{n=-|v(d)|+r+1}^{\lambda-|v(d)|+r}
    \sum_{m=n-|v(d)|+1}^{\min(n, \lambda) - 2|v(d)| + r}
    q^{-n - (m+2|v(d)|-r)} \left( 1 - q^{-1} \right) \\
    &\qquad\qquad\cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &= \sum_{n=\max(1, -2|v(d)|+r+1)}^{-|v(d)|+r}
    \sum_{m=n-r}^{-2|v(d)|+r}
    q^{n} \left( 1 + q^{-1} \right) \cdot (-1)^n q^{s(2m-n)} \\
  &+ \sum_{n=\max(1, -2|v(d)|+r+1)}^{-|v(d)|+r}
    \sum_{m=-2|v(d)|+r+1}^{\min(n, \lambda) - 2|v(d)| + r}
    q^{n-(m+2|v(d)|-r)} (-1)^n q^{s(2m-n)} \\
  &+ \sum_{n=-|v(d)|+r+1}^{\lambda-|v(d)|+r}
    \sum_{m=n-r}^{n-|v(d)|} q^{r-|v(d)|} (-1)^n q^{s(2m-n)} \\
  &+ \sum_{n=-|v(d)|+r+1}^{\lambda-|v(d)|+r}
    \sum_{m=n-|v(d)|+1}^{\min(n, \lambda) - 2|v(d)| + r}
    q^{n - (m+2|v(d)|-r)} (-1)^n q^{s(2m-n)}.
\end{align*}

\subsubsection{Merging the contributions}
When we put together these sums, the first two double sums fold together and
we get just the following five double sums:
\begin{align*}
  I_{n>0}^{\text{1+2}} + I_{n>0}^{\text{3+4}}
  &= \sum_{n=1}^{-|v(d)|+r} \sum_{m=n-r}^{-2|v(d)|+r}
    q^{n} \left( 1 + q^{-1} \right) (-1)^n q^{s(2m-n)} \\
  &+ \sum_{n=-|v(d)|+r+1}^{\lambda-|v(d)|+r}
    \sum_{m=n-r}^{n-|v(d)|} q^{r-|v(d)|} (-1)^n q^{s(2m-n)} \\
  &+ \sum_{n=1}^{-2|v(d)|+r}
    \sum_{m=-2|v(d)|+r+1}^{\min\left(n, \lambda\right) - 2|v(d)|+r}
    q^{n - (m+2|v(d)|-r)} \cdot (-1)^n q^{s(2m-n)} \\
  &+ \sum_{n=\max(1, -2|v(d)|+r+1)}^{-|v(d)|+r}
    \sum_{m=-2|v(d)|+r+1}^{\min(n, \lambda) - 2|v(d)| + r}
    q^{n-(m+2|v(d)|-r)} (-1)^n q^{s(2m-n)} \\
  &+ \sum_{n=-|v(d)|+r+1}^{\lambda-|v(d)|+r}
    \sum_{m=n-|v(d)|+1}^{\min(n, \lambda) - 2|v(d)| + r}
    q^{n - (m+2|v(d)|-r)} (-1)^n q^{s(2m-n)}.
\end{align*}

\subsubsubsection{The first double sum, combined with $I_{n \le 0}$}
We start with
\[ \sum_{n=1}^{-|v(d)|+r} \sum_{m=n-r}^{-2|v(d)|+r} q^{n} \left( 1 + q^{-1} \right) (-1)^n q^{s(2m-n)} \]
We'd like to write an analogous sum over $j$.
For $1 < j < -|v(d)|+r$ we get a contribution of $q^j (-q^s)^k$ for $k = 2m-n$ if and only if
for $n = j + (k-n)\%2 = j + (k-j) \% 2$ we have
\begin{align*}
  n-r \le m \le -2|v(d)|+r
  &\iff 2n-2r \le k+n \le -4|v(d)|+2r \\
  &\iff j + (k-j)\%2 - 2r \le k \le -j - (k-j)\%2 - 4|v(d)| + 2r \\
  &\iff j - 2r \le k \le -j - 4|v(d)| + 2r.
\end{align*}
When $j=0$, the contribution is analogous except we must have $n=1$ so that $k$ must be odd;
and when $j=-|v(d)|+r$, the contribution is analogous except we must have $n=-|v(d)|+r$
so that $k$ must have the same parity as $-|v(d)|+r$.
In other words, the double sum can be written as

So this double sum can be rewritten as
\[ \sum_{j=1}^{-|v(d)|+r-1} \sum_{k = j - 2r}^{-j - 4|v(d)| + 2r} q^j (-q^s)^k
  + \sum_{\substack{-2r \le k \le -4|v(d)|+2r \\ k \equiv 1 \pmod 2}} (-q^s)^k
  + \sum_{\substack{-|v(d)|-r \le k \le -3|v(d)|+3r \\ k \equiv -|v(d)|+r \bmod 2}}
    q^{-|v(d)|+r} (-q^s)^k. \]
However, we also have
\[ I_{n \le 0} =
  \sum_{\substack{-2r \le k \le -4|v(d)|+2r \\ k \equiv 0 \pmod 2}} (-q^s)^k. \]
Hence once we incorporate $I_{n \le 0}$ in we have
\begin{align*}
  I_{n \le 0}
  &+ \sum_{n=1}^{-|v(d)|+r} \sum_{m=n-r}^{-2|v(d)|+r} q^{n} \left( 1 + q^{-1} \right) (-1)^n q^{s(2m-n)} \\
  &= \sum_{j=0}^{-|v(d)|+r-1} \sum_{k = j - 2r}^{-j - 4|v(d)| + 2r} q^j (-q^s)^k \\
  &+ \sum_{\substack{-|v(d)|-r \le k \le -3|v(d)|+r \\ k \equiv -|v(d)|+r \bmod 2}}
    q^{-|v(d)|+r} (-q^s)^k.
\end{align*}

\subsubsubsection{The second double sum}
We turn  to the second double sum
\[ \sum_{n=-|v(d)|+r+1}^{\lambda-|v(d)|+r} \sum_{m=n-r}^{n-|v(d)|} (-1)^n q^{s(2m-n)}. \]
Working with $k = 2m-n$,
the values of $k$ run from the lowest value $k = - |v(d)| - r + 1$
to the highest value $k = \lambda - 3|v(d)| + r$.
The coefficient of $k$ is the number of integers $m$ such that
\[ n-r \le m \le n-|v(d)| \iff 2m-k-r \le m \le 2m-k-|v(d)| \iff k+|v(d)| \le m \le k+r \]
and
\[ -|v(d)|+r+1 \le 2m-k \le \lambda - |v(d)| + r
  \iff \frac{k-|v(d)|+r+1}{2} \le m \le \frac{k+\lambda-|v(d)|+r}{2}. \]
In other words, the double sum in question equals
\begin{align*}
  \sum_{k=-|v(d)|-r+1}^{\lambda-3|v(d)|+r}
  \bigg( & \min\left( \left\lfloor \frac{k+\lambda-|v(d)|+r}{2} \right\rfloor, k+r \right) \\
  & - \max\left( \left\lceil \frac{k-|v(d)|+r+1}{2} \right\rceil, k+|v(d)| \right) + 1 \bigg) (-q^s)^k.
\end{align*}

\subsubsubsection{The third, fourth, and fifth double sum}
Now we evaluate the final three double sums.
Replacing $j = n - (m + 2 |v(d)| - r)$ gives
$2m-n = 2(n - (2|v(d)| - r) - j) - n = n - 4|v(d)| + 2r - 2j$ and
the last three double sums transform into
\begin{align*}
  \sum_{n=1}^{-2|v(d)|+r}
    \sum_{j=\max(0, n-\lambda)}^{n-1}
    q^j \cdot (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  + \sum_{n=\max(1, -2|v(d)|+r+1)}^{-|v(d)|+r}
    \sum_{j=\max(0, n-\lambda)}^{n-1}
    q^j (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  + \sum_{n=-|v(d)|+r+1}^{\lambda-|v(d)|+r}
    \sum_{j=\max(0, n -\lambda)}^{-|v(d)|+r-1}
    q^j (-1)^n q^{s(n-4|v(d)|+2r-2j)}.
\end{align*}
The range of $n$ across the three double sums is disjoint
and runs from $n = 1$ up to $n = \lambda - |v(d)| + r$.

%\Cref{tab:ell_neg_9_cases} shows the value of $j$ that are summed over
%depending on which breaking point applies for $n$.
%Note that not all $9$ cells are actually used for any particular $(|v(d)|, r, \lambda)$.
%\begin{table}[ht]
%  \begin{tabular}{lccc}
%    \toprule
%    & $n \le \lambda - |v(d)|$ & $\lambda - |v(d)| \le n \le \lambda$ & $n \ge \lambda$ \\ \midrule
%    $1 \le n \le -2|v(d)|+r$
%      & $0 \le j \le n-1$
%      & $\begin{aligned} n&-\lambda+|v(d)| \\ & \le j \le n-1 \end{aligned}$
%      & $\begin{aligned} n&-\lambda+|v(d)| \\ & \le j \le n-1 \end{aligned}$ \\
%    $\begin{aligned} \max(1,& -2|v(d)|+r+1) \\ &\le n \le -|v(d)|+r \end{aligned}$
%      & $0 \le j \le n-1$
%      & $0 \le j \le n-1$
%      & $\begin{aligned} n-\lambda &\le j \\ &\le n-1 \end{aligned}$ \\
%    $\begin{aligned} -|v(d)|& +r+1 \\ &\le n \le \lambda - |v(d)|+r \end{aligned}$
%      & $\begin{aligned} 0 &\le j \\ &\le -|v(d)|+r+1 \end{aligned}$
%      & $\begin{aligned} 0 &\le j \\ &\le -|v(d)|+r+1 \end{aligned}$
%      & $\begin{aligned} n-\lambda &\le j \\ &\le -|v(d)|+r+1 \end{aligned}$ \\
%    \bottomrule
%  \end{tabular}
%  \caption{The $9$ cases of the double sum}
%  \label{tab:ell_neg_9_cases}
%\end{table}

We now interchange the order of summation so that $j$ is on the outside to get
and then split the second double sum and re-collate:
\begin{align*}
  &\sum_{j=0}^{-2|v(d)|+r-1}
    \sum_{n=j+1}^{-2|v(d)|+r}
    q^j \cdot (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &+ \sum_{j=0}^{-|v(d)|+r-1}
    \sum_{n=\max(j+1, -2|v(d)|+r+1)}^{\min(j+\lambda,-|v(d)|+r)}
    q^j (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &+ \sum_{j=\max(0, -\lambda-|v(d)|+r+1)}^{-|v(d)|+r-1}
    \sum_{n=-|v(d)|+r+1}^{j+\lambda}
    q^j (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &= \sum_{j=0}^{-2|v(d)|+r-1}
    \sum_{n=j+1}^{-2|v(d)|+r}
    q^j \cdot (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &+ \sum_{j=0}^{-\lambda-|v(d)|+r}
    \sum_{n=\max(j+1, -2|v(d)|+r+1)}^{j+\lambda}
    q^j (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &+ \sum_{j=\max(0, -\lambda-|v(d)|+r+1)}^{-|v(d)|+r-1}
    \sum_{n=\max(j+1, -2|v(d)|+r+1)}^{-|v(d)|+r}
    q^j (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &+ \sum_{j=\max(0, -\lambda-|v(d)|+r+1)}^{-|v(d)|+r-1}
    \sum_{n=-|v(d)|+r+1}^{j+\lambda}
    q^j (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &= \sum_{j=0}^{-2|v(d)|+r-1}
    \sum_{n=j+1}^{-2|v(d)|+r}
    q^j \cdot (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &+ \sum_{j=0}^{-\lambda-|v(d)|+r}
    \sum_{n=\max(j+1, -2|v(d)|+r+1)}^{j+\lambda}
    q^j (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &+ \sum_{j=\max(0, -\lambda-|v(d)|+r+1)}^{-|v(d)|+r-1}
    \sum_{n=\max(j+1, -2|v(d)|+r+1)}^{j+\lambda}
    q^j (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &= \sum_{j=0}^{-2|v(d)|+r-1}
    \sum_{n=j+1}^{-2|v(d)|+r}
    q^j \cdot (-1)^n q^{s(n-4|v(d)|+2r-2j)} \\
  &+ \sum_{j=0}^{-|v(d)|+r-1}
    \sum_{n=\max(j+1, -2|v(d)|+r+1)}^{j+\lambda}
    q^j (-1)^n q^{s(n-4|v(d)|+2r-2j)}.
\end{align*}

Let $k = n - 2j - 4|v(d)| + 2r$ and transform this into
\begin{align*}
  &\sum_{j=0}^{-2|v(d)|+r-1}
    \sum_{k=-j-4|v(d)|+2r+1}^{-2j-6|v(d)|+3r}
    q^j \cdot (-q^s)^k \\
  &+ \sum_{j=0}^{-|v(d)|+r-1}
    \sum_{k=\max(j+1, -2|v(d)|+r+1) - 2j - 4|v(d)| + 2r}^{-j+\lambda-4|v(d)|+2r}
    q^j (-q^s)^k.
\end{align*}

\subsubsection{Collation}
Altogether, we have arrived at the following formula
\begin{align*}
  \Orb(\gamma, \mathbf{1}_{K'_{S, \le r}}, s)
  &= \sum_{j=0}^{-|v(d)|+r-1} \sum_{k = j - 2r}^{-j - 4|v(d)| + 2r} q^j (-q^s)^k
  + q^{-|v(d)|+r} \sum_{\substack{-|v(d)|-r \le k \le -3|v(d)|+r \\ k \equiv -|v(d)|+r \bmod 2}}
    (-q^s)^k \\
  &+ q^{-|v(d)|+r} \sum_{k=-|v(d)|-r+1}^{\lambda-3|v(d)|+r}
  \bigg( \min\left( \left\lfloor \frac{k+\lambda-|v(d)|+r}{2} \right\rfloor, k+r \right) \\
    &\qquad - \max\left( \left\lceil \frac{k-|v(d)|+r+1}{2} \right\rceil, k+|v(d)| \right) + 1 \bigg)
    (-q^s)^k \\
  &\sum_{j=0}^{-2|v(d)|+r-1}
    \sum_{k=-j-4|v(d)|+2r+1}^{-2j-6|v(d)|+3r}
    q^j \cdot (-q^s)^k \\
  &+ \sum_{j=0}^{-|v(d)|+r-1}
    \sum_{k=\max(j+1, -2|v(d)|+r+1) - 2j - 4|v(d)| + 2r}^{-j+\lambda-4|v(d)|+2r}
    q^j (-q^s)^k.
\end{align*}
We collapse the sums
\begin{align*}
  &\phantom+ q^{-|v(d)|+r} \sum_{\substack{-|v(d)|-r \le k \le -3|v(d)|+r \\ k \equiv -|v(d)|+r \bmod 2}}
    (-q^s)^k \\
  &+ q^{-|v(d)|+r} \sum_{k=-|v(d)|-r+1}^{\lambda-3|v(d)|+r}
  \bigg( \min\left( \left\lfloor \frac{k+\lambda-|v(d)|+r}{2} \right\rfloor, k+r \right) \\
    &\qquad - \max\left( \left\lceil \frac{k-|v(d)|+r+1}{2} \right\rceil, k+|v(d)| \right) + 1 \bigg)
    (-q^s)^k
\end{align*}
by noting that the coefficient of the second sum can be written as
\begin{align*}
  &\phantom=
  \begin{cases}
    \left\lfloor \frac{k+\lambda-|v(d)|+r}{2} \right\rfloor - \left\lceil \frac{k-|v(d)|+r+1}{2} \right\rceil + 1 &\text{if } \lambda-|v(d)|-r \le k \le -3|v(d)|+r \\
    r-|v(d)|+1 &\text{if } -3|v(d)|+r \le k \le \lambda-|v(d)| \\
    \left\lfloor \frac{k+\lambda-|v(d)|+r}{2} \right\rfloor - (k+|v(d)|) + 1 &\text{if } k \ge \max(-3|v(d)|+r, \lambda-|v(d)|-r) \\
    (k+r) - \left\lceil \frac{k-|v(d)|+r+1}{2} \right\rceil + 1 &\text{if } k \le \min(-3|v(d)|+r, \lambda-|v(d)|-r) \\
  \end{cases} \\
  &=
  \begin{cases}
    \frac{\lambda-1}{2} + (k+|v(d)|+r)\%2 &\text{if } \lambda-|v(d)|-r \le k \le -3|v(d)|+r \\
    r-|v(d)|+1 &\text{if } -3|v(d)|+r \le k \le \lambda-|v(d)| \\
    \left\lfloor \frac{\lambda-3|v(d)|+r-k}{2} \right\rfloor + 1 &\text{if } k \ge \max(-3|v(d)|+r, \lambda-|v(d)|-r) \\
    \left\lfloor \frac{k+|v(d)|+r}{2} \right\rfloor + (k+|v(d)|+r)\%2 &\text{if } k \le \min(-3|v(d)|+r, \lambda-|v(d)|-r) \\
  \end{cases}
\end{align*}
Thus when we add
$q^{-|v(d)|+r} \sum_{\substack{-|v(d)|-r \le k \le -3|v(d)|+r \\ k \equiv -|v(d)|+r \bmod 2}} (-q^s)^k$
back in we conveniently arrive at a coefficient of
\[
  1 +
  \begin{cases}
    \frac{\lambda-1}{2} &\text{if } \lambda-|v(d)|-r \le k \le -3|v(d)|+r \\
    r-|v(d)| &\text{if } -3|v(d)|+r \le k \le \lambda-|v(d)| \\
    \left\lfloor \frac{\lambda-3|v(d)|+r-k}{2} \right\rfloor &\text{if } k \ge \max(-3|v(d)|+r, \lambda-|v(d)|-r) \\
    \left\lfloor \frac{k+|v(d)|+r}{2} \right\rfloor &\text{if } k \le \min(-3|v(d)|+r, \lambda-|v(d)|-r).
  \end{cases}
\]
If we now define
\[ \cc_\gamma(k) \coloneqq \Arch_{[-|v(d)|-r, \lambda-3|v(d)|+r]} (0, \min(2r-2|v(d)|, \lambda)) \]
then the coefficient can be written instead as
$1 + \cc_\gamma(k)$.

Similarly, we unify the three remaining double sums by
repeatedly splitting into five double sums and re-collating everything.
The entire expression delightfully collapses into a single double sum as follows:
\begin{align*}
  &\sum_{j=0}^{-|v(d)|+r-1} \sum_{k = j - 2r}^{-j - 4|v(d)| + 2r} q^j (-q^s)^k \\
  &+ \sum_{j=0}^{-2|v(d)|+r-1}
    \sum_{k=-j-4|v(d)|+2r+1}^{-2j-6|v(d)|+3r}
    q^j \cdot (-q^s)^k \\
  &+ \sum_{j=0}^{-|v(d)|+r-1}
    \sum_{k=\max(j+1, -2|v(d)|+r+1) - 2j - 4|v(d)| + 2r}^{-j+\lambda-4|v(d)|+2r}
    q^j (-q^s)^k \\
  &= \sum_{j=0}^{-2|v(d)|+r-1} \sum_{k = j - 2r}^{-j - 4|v(d)| + 2r} q^j (-q^s)^k \\
  &+ \sum_{j=\max(-2|v(d)|+r,0)}^{-|v(d)|+r-1} \sum_{k = j - 2r}^{-j - 4|v(d)| + 2r} q^j (-q^s)^k \\
  &+ \sum_{j=0}^{-2|v(d)|+r-1}
    \sum_{k=-j-4|v(d)|+2r+1}^{-2j-6|v(d)|+3r}
    q^j \cdot (-q^s)^k \\
  &+ \sum_{j=0}^{-2|v(d)|+r-1}
    \sum_{k = -2j - 6|v(d)| + 3r + 1}^{-j+\lambda-4|v(d)|+2r}
    q^j (-q^s)^k \\
  &+ \sum_{j=\max(-2|v(d)|+r, 0)}^{-|v(d)|+r-1}
    \sum_{k = -j - 4|v(d)| + 2r + 1}^{-j+\lambda-4|v(d)|+2r}
    q^j (-q^s)^k \\
  &= \sum_{j=0}^{-2|v(d)|+r-1} \sum_{k = j - 2r}^{-j + \lambda - 4|v(d)| + 2r} q^j (-q^s)^k
    + \sum_{j=\max(-2|v(d)|+r,0)}^{-|v(d)|+r-1} \sum_{k = j - 2r}^{-j + \lambda - 4|v(d)| + 2r} q^j (-q^s)^k \\
  &= \sum_{j=0}^{-|v(d)|+r-1} \sum_{k = j - 2r}^{-j + \lambda - 4|v(d)| + 2r} q^j (-q^s)^k.
\end{align*}
Thus, at this point we now have
\begin{align*}
  \Orb(\gamma, \mathbf{1}_{K'_{S, \le r}}, s)
  &= \sum_{k=-|v(d)|-r}^{\lambda-3|v(d)|+r} q^{-|v(d)|+r} (1+\cc_\gamma(k)) (-q^s)^k \\
  &+ \sum_{j=0}^{-|v(d)|+r-1} \sum_{k = j - 2r}^{-j + \lambda - 4|v(d)| + 2r} q^j (-q^s)^k \\
  &= \sum_{k=-|v(d)|-r}^{\lambda-3|v(d)|+r} q^{-|v(d)|+r} \cc_\gamma(k) (-q^s)^k \\
  &+ \sum_{j=0}^{-|v(d)|+r} \sum_{k = j - 2r}^{-j + \lambda - 4|v(d)| + 2r} q^j (-q^s)^k.
\end{align*}
Interchange the order of the latter sum to be $k$ first:
\begin{align*}
  \Orb(\gamma, \mathbf{1}_{K'_{S, \le r}}, s)
  &= \sum_{k=-|v(d)|-r}^{\lambda-3|v(d)|+r} q^{-|v(d)|+r} \cc_\gamma(k) (-q^s)^k \\
  &+ \sum_{k=-2r}^{\lambda-4|v(d)|+2r} \sum_{j=0}^{\min(k+2r, -|v(d)|+r, \lambda-4|v(d)|+2r-k)} q^j (-q^s)^k.
\end{align*}
Putting this all together gives \Cref{thm:full_orbital_ell_neg}:
\ellneg*

\subsection{Derivatives of the orbital integral on $S_3(F)$}
\label{sec:S3_orbital_deriv}

We now differentiate each of the three earlier theorems.
Because of the similarity of the shapes of the orbitals,
we prove the general results \Cref{lem:derivative_nn} and \Cref{lem:derivative_cc}
and specialize them to the cases we need.

\subsubsection{Analysis of the $\nn_\gamma$ sum}
\begin{lemma}
  [Derivative of $\nn_\gamma$ sum]
  \label{lem:derivative_nn}
  Let $C$, $W$ and $H$ be integers with $W > 4H \ge 0$ and $W$ odd.
  Consider sums of the form
  \[ \Sigma_r(s) \coloneqq \sum_{k=C-2r}^{C+2r+W} \left( 1 + q + \dots
    + q^{\Arch_{[C-2r, C+2r+W]}(r, 2H)(k)} \right) (-q^s)^k. \]
  Then for any $r \ge 0$ we have
  \begin{align*}
    - \frac{1}{\log q} \left. \pdv{}{s} \Sigma_r(s) \right\rvert_{s=0}
    &= (-1)^{r+C} \sum_{j=r+1}^{r+H} \left( \frac{W+1}{2} + r - 2(j-r) \right) \cdot q^j \\
      &+ \sum_{j=0}^{r} (-1)^{j+C} \left( \frac{W+1}{2} + 2r - j \right) \cdot q^j.
  \end{align*}
\end{lemma}
\begin{proof}
  Since $\Sigma_r(0) = 0$, the effect of $C$ is just multiplication by $(-1)^C$
  and hence we assume without loss of generality that $C = 0$.
  For each $0 \le j \le r+H$ we consider the range of $k$
  such that $j \le \Arch_{[-2r, 2r+W]}(r, 2H)(k)$.
  The derivative at $s = 0$ will give the coefficient for $q^j$.
  \begin{itemize}
    \ii For $0 \le j \le r$, we have a contiguous range $-2r + j \le k \le 2r+W-j$.
    When we take the derivative of $\sum_k (-q^s)^k$ at $s = 0$ we get
    we get $\log q \cdot \sum_k (-1)^k$ across this range.
    Since consecutive elements differ by $1$, and $W$ is odd,
    we get $(-1)^j$ times half the number of elements in the range,
    which is $\frac{(2r+W-j) - (-2r+j) + 1}{2} = \frac{W+1}{2} + 2r - j$.

    \ii For $r+1 \le j \le r+H$, we have a contiguous range
    $-2r + r + 2(j-r) \le k \le 2r+W-(r + 2(j-r))$ instead,
    and the same proof gives the coefficient of $q^j$.
    \qedhere
  \end{itemize}
\end{proof}

\subsubsection{Analysis of the $\cc_\gamma$ sum}
We will use the following extremely easy lemma:
\begin{lemma}
  [Extremely easy]
  \label{lem:extremely_easy_lemma}
  If $a_0 \le a_1$ are integers then
  \begin{align*}
    \sum_{k=a_0}^{a_1} (k-a_0) \cdot k \cdot (-1)^k
    &= (-1)^{a_1} \cdot \frac{a_1(a_1-a_0+1)}{2} - \frac{(-1)^{a_0} + (-1)^{a_1}}{4} \cdot a_0 \\
    \sum_{k=a_0}^{a_1} (a_1-k) \cdot k \cdot (-1)^k
    &= (-1)^{a_0} \cdot \frac{a_0(a_1-a_0+1)}{2} - \frac{(-1)^{a_0} + (-1)^{a_1}}{4} \cdot a_1.
  \end{align*}
\end{lemma}
\begin{proof}
  This follows trivially by induction on $a_1$.
  (Alternatively, use a symbolic engine like WolframAlpha;
  see
  \href{https://www.wolframalpha.com/input?i=sum+\%28k-a\%29*k*\%28-1\%29\%5Ek+from+k\%3Da+to+b}{here}
  for the first sum and
  \href{https://www.wolframalpha.com/input?i=sum+\%28b-k\%29*k*\%28-1\%29\%5Ek+from+k\%3Da+to+b}{here}
  for the second sum.)
\end{proof}

\begin{lemma}
  [Derivative of $\cc_\gamma$ sum]
  \label{lem:derivative_cc}
  Let $C$, $W$, $L$ be integers with $L \ge 1$ odd and $W \ge 0$.
  Consider sums of the form
  \[ \Sigma_r(s) \coloneqq \sum_{k=C-r}^{C+2W+L+r} \Arch_{[C-r, C+2W+L+r]}(W, \min(2r, L))(k) \cdot (-q^s)^k. \]
  Then for any $r \ge 0$ we have
  \[ \frac{(-1)^{r+W+C}}{\log q} \left. \pdv{}{s} \Sigma_r(s) \right\rvert_{s=0}
    = \begin{cases}
      \frac W2 - \frac{L-1}{2} \cdot r & \text{if } W \equiv 0 \pmod 2 \\
      - \frac{W+L}{2} - \frac{L+1}{2} \cdot r & \text{if } W \equiv 1 \pmod 2.
    \end{cases} \]
\end{lemma}
\begin{proof}
  Since $\Sigma_r(0) = 0$, the effect of $C$ is just multiplication by $(-1)^C$
  and hence we assume without loss of generality that $C = 0$.
  Also, note that change $L$ to $L-1$ makes no difference since $L$ is odd
  (in general the $\Arch(w_0, w_1)$ only depends on $\left\lfloor w_1/2 \right\rfloor$).
  With this assumption, we could write explicitly
  \[ \Sigma_r(s) \coloneqq \sum_{k=-r}^{2W+L+r} \Arch_{[-r, 2W+L+r]}(W, \min(2r, L-1))(k) \cdot (-q^s)^k. \]
  Then for any $r \ge 0$ we have
  \[ \frac{1}{\log q} \left. \pdv{}{s} \Sigma_r(s) \right\rvert_{s=0}
    = \sum_{k=-r}^{2W+L+r} (-1)^{k} \cdot k \cdot \Arch_{[-r, 2W+L+r]}(W, \min(2r, L-1))(k). \]
  Let $H \coloneqq \min(2r, L-1)$ for brevity, which is even.
  We split the sum now into five parts:
  \begin{align*}
    \frac{1}{\log q} \left. \pdv{}{s} \Sigma_r(s) \right\rvert_{s=0}
    &= \sum_{k=-r}^{W-r-1} (-1)^{k} \cdot k \cdot \Arch_{[-r, 2W+L+r]}(W, H)(k) \\
    &\qquad+ \sum_{k=W-r}^{W-r + H - 1} (-1)^{k} \cdot k \cdot \Arch_{[-r, 2W+L+r]}(W, H)(k) \\
    &\qquad+ \sum_{k=W-r + H}^{W+L+r - H}
      (-1)^{k} \cdot k \cdot \Arch_{[-r, 2W+L+r]}(W, H)(k) \\
    &\qquad+ \sum_{k=W+L+r - H+1}^{W+L+r} (-1)^{k} \cdot k \cdot \Arch_{[-r, 2W+L+r]}(W, H)(k) \\
    &\qquad+ \sum_{k=W+L+r+1}^{2W+L+r} (-1)^{k} \cdot k \cdot \Arch_{[-r, 2W+L+r]}(W, H)(k) \\
    &= \sum_{k=-r}^{W-r-1} (-1)^{k} \cdot k \cdot (k+r) \\
    &\qquad+ \sum_{k=W-r}^{W-r + H - 1} (-1)^{k} \cdot k \cdot
      \left( W + \left\lfloor \frac{k-(W-r)}{2} \right\rfloor \right) \\
    &\qquad+ \sum_{k=W-r + H}^{W+L+r - H}
      (-1)^{k} \cdot k \cdot \left( W + \frac H2 \right) \\
    &\qquad+ \sum_{k=W+L+r - H + 1}^{W+L+r} (-1)^{k} \cdot k \cdot
      \left( W + \left\lfloor \frac{W+L+r-k}{2} \right\rfloor \right) \\
    &\qquad+ \sum_{k=W+L+r+1}^{2W+L+r} (-1)^{k} \cdot k \cdot (2W+L+r-k).
  \end{align*}
  We can take out the contribution of $r$ in the second, third, and fourth sum and write
  \begin{equation}
    \sum_{k=W-r}^{W+L+r} (-1)^k \cdot k \cdot W = (-1)^{W-r+1} W \cdot \frac{L+2r+1}{2}
    \label{eq:moment234r}
  \end{equation}
  The remaining part of the third sum is
  \begin{equation}
    \sum_{k=W-r + H}^{W+L+r - H} (-1)^{k} \cdot k \cdot \frac H2
    = (-1)^{W-r+1} \frac{L+2r-2H+1}{2} \cdot \frac H2
    \label{eq:moment3top}
  \end{equation}
  By \Cref{lem:extremely_easy_lemma}, the first sum is
  \[ \sum_{k=-r}^{W-r-1} (-1)^{k} \cdot k \cdot (k+r)
      = (-1)^{W-r-1} \cdot \frac{W(W-r-1)}{2} - \frac{(-1)^r + (-1)^{W+r-1}}{4} \cdot (-r) \]
  and the fifth sum is
  \begin{align*}
    \sum_{k=W+L+r+1}^{2W+L+r} (-1)^{k} \cdot k \cdot (2W+L+r-k)
    &= (-1)^{W+L+r+1} \cdot \frac{W(W+L+r+1)}{2} \\
      &\qquad - \frac{(-1)^{r+1} + (-1)^{W+r}}{4} \cdot (2W+L+r).
  \end{align*}
  This sum equals
  \begin{equation}
    \begin{aligned}
      &\sum_{k=-r}^{W-r-1} (-1)^{k} \cdot k \cdot (k+r)
      + \sum_{k=W+L+r+1}^{2W+L+r} (-1)^{k} \cdot k \cdot (2W+L+r-k) \\
      &= (-1)^{W+r} \frac{W(L+2r+2)}{2} - (-1)^{W+r} (W\%2) \cdot \frac{2W+L+2r}{2}.
    \end{aligned}
    \label{eq:moment15}
  \end{equation}

  Similarly, if we set aside the floors for the moment the second and fourth sum give
  \begin{align*}
    \sum_{k=W-r}^{W-r + H - 1} (-1)^{k} \cdot k \cdot \frac{k-(W-r)}{2}
    &= \frac{(-1)^{W-r-1}}{4} \cdot H \cdot \left( W - r + H - 1 \right) \\
    \sum_{k=W+L+r - H + 1}^{W+L+r} (-1)^{k} \cdot k \cdot \frac{W+L+r-k}{2}
    &= \frac{(-1)^{W+r}}{4} \cdot H \cdot \left( W + L + r - H + 1 \right)
  \end{align*}
  by \Cref{lem:extremely_easy_lemma}.
  Their sum is
  \begin{equation}
    \begin{aligned}
      \sum_{k=W-r}^{W-r + H - 1} (-1)^{k} \cdot k \cdot \frac{k-(W-r)}{2}
      &+ \sum_{k=W+L+r-H+1}^{W+L+r} (-1)^{k} \cdot k \cdot \frac{W+L+r-k}{2} \\
      &= \frac{(-1)^{W+r}}{4} \cdot H \cdot (L + 2r + 2 - 2H).
    \end{aligned}
    \label{eq:moment24main}
  \end{equation}
  We now add in the correction terms of $-1/2$ from the floor:
  \begin{align*}
    \sum_{\substack{W-r \le k \le W-r+H-1 \\ k \equiv W+r+1 \bmod 2}} (-1)^{k} \cdot k \cdot \left( - \half \right)
    &= \frac{(-1)^{W-r}}{2}
    \left( (W-r) \cdot \frac{H}{2} + \left( \frac{H}{2} \right)^2  \right) \\
    \sum_{\substack{W+L+r-H+1 \le k \le W+L+r \\ k \equiv W+L+r-1 \bmod 2}} (-1)^{k} \cdot k \cdot \left( - \half \right)
    &= \frac{(-1)^{W+L+r}}{2}
    \left( (W+L+r) \cdot \frac{H}{2} - \left( \frac{H}{2} \right)^2 \right).
  \end{align*}
  As $L$ is odd the sum of these is equal to
  \begin{equation}
    \begin{aligned}
      \sum_{\substack{W-r \le k \le W-r+H-1 \\ k \equiv W+r+1 \bmod 2}} (-1)^{k} \cdot k \cdot \left( - \half \right)
      &+ \sum_{\substack{W+L+r-H+1 \le k \le W+L+r \\ k \equiv W+L+r-1 \bmod 2}} (-1)^{k} \cdot k \cdot \left( - \half \right) \\
      &= \frac{(-1)^{W+r}}{2} \cdot \left( \frac{H^2}{2} - (L+2r) \frac H2 \right).
    \end{aligned}
    \label{eq:moment24err}
  \end{equation}
  Hence, if we sum all of \eqref{eq:moment234r}, \eqref{eq:moment3top},
  \eqref{eq:moment15}, \eqref{eq:moment24main}, \eqref{eq:moment24err} we obtain
  \begin{align*}
    \frac{(-1)^{W+r}}{\log q} \left. \pdv{}{s} \Sigma_r(s) \right\rvert_{s=0}
    &= - W \cdot \frac{L+2r+1}{2} - \frac{L+2r-2H+1}{2} \cdot \frac H2 \\
    &\qquad+ \frac{W(L+2r+2)}{2} - (W\%2) \cdot \frac{2W+L+2r}{2} \\
    &\qquad+ \frac14 \cdot H \cdot (L + 2r + 2 - 2H) + \half \left( \frac{H^2}{2} - (L+2r) \frac H2 \right) \\
    &= \frac{W}{2} - (W\%2) \cdot \frac{2W+L+2r}{2} - \frac{H}{4} \left( (L-1) + 2r - H  \right).
  \end{align*}
  Since $H = \min(L-1, 2r)$, it follows $H \cdot \left( (L-1)+2r-H \right) = 2r(L-1)$,
  and finally the variable $H$ is gone.
  Hence
  \[ \frac{(-1)^{W+r}}{\log q} \left. \pdv{}{s} \Sigma_r(s) \right\rvert_{s=0}
    = \frac{W}{2} - (W\%2) \cdot \frac{2W+L+2r}{2} - \frac r2 (L-1) \]
  which equals the claimed expression.
\end{proof}

\subsubsection{Proof of \Cref{thm:S3_orbital_deriv}}
All that remains is to apply the above lemmas with the correct inputs.
To spell out the details:
\begin{itemize}
  \ii For $\ell$ odd, consult \Cref{thm:full_orbital_ell_odd}.
  \begin{itemize}
    \ii Apply \Cref{lem:derivative_nn} with $C = 0$, $W = \ell + 2 \delta$ and $H = \frac{\ell-1}{2}$.
  \end{itemize}

  \ii For $\ell \ge 0$ even, consult \Cref{thm:full_orbital_ell_even}.
  \begin{itemize}
    \ii Apply \Cref{lem:derivative_nn} with $C = 0$, $W = \lambda + 2 \delta$ and $H = \frac{\ell}{2}$.
    \ii Apply \Cref{lem:derivative_cc} with $C = \ell$, $W = \delta - \half\ell$ and $L = \lambda - \ell$.
  \end{itemize}

  \ii For $\ell < 0$ even, consult \Cref{thm:full_orbital_ell_even}.
  If $r < |v(d)|$ then all the orbital integrals are zero anyway.
  Otherwise, we replace $r$ by to $r-|v(d)| \ge 0$
  and then apply the following lemmas:
  \begin{itemize}
    \ii Apply \Cref{lem:derivative_nn} with $C = -2|v(d)|$, $W = \lambda$ and $H = 0$
    and $r$ replaced by $r - |v(d)|$.
    \ii Apply \Cref{lem:derivative_cc} with $C = -2|v(d)|$, $W = 0$ and $L = \lambda$
    and $r$ replaced by $r - |v(d)|$.
  \end{itemize}
\end{itemize}
